---
title: "A08 : Interaction Model"
date: '`r Sys.Date()`'
author: Sylvain Schmitt & Anne Baranger
output:
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
  bookdown::html_document2:
    number_sections: no
    toc: true
    toc_float: yes
    theme: flatly
  bookdown::word_document2: default
linestretch: 1.5
# csl: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/csl/mee.csl
# bibliography: /home/ECOFOG/sylvain.schmitt/Documents/Bibliography/library.bib
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
#rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(kableExtra)
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 6,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "../../data/Paracou/"
```

```{r data, eval=T}
# traits <- googlesheets::gs_title("Measures_Symphonia") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   mutate(Genus = "Symphonia") %>%
#   rename(Species = Morphotype) %>%
#   mutate(Species = ifelse(Species == "Indet.", "sp.1", Species)) %>% 
#   mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>%
#   group_by(idTree, Plot, SubPlot, TreeFieldNum, Genus, Species,
#            SpeciesLong, Bark, Dawkins) %>%
#   summarise_at(vars("brBT", "brBD", "brWD"), mean, na.rm = T) %>%
#   ungroup() %>%
#   filter(!is.nan(brWD))
# load("./functional_save/env.Rdata")
# Individuals <-  left_join(traits, env, by = "idTree", suffix = c("", ".y"))
# rm(traits, env)
# save(Individuals, file = "./functional_save/IndividualsWood.Rdata")
load("./functional_save/IndividualsWood.Rdata")
load("./functional_save/CompetitionMatrix.Rdata")
```

```{r mdata}
traits <- c("brBT", "brBD", "brWD")
mdata <- lapply(traits, function(trait){
  data_trait <- Individuals[!is.na(unlist(Individuals[,trait])),] %>% 
    left_join(select(Competition, idTree, AreaOutside20) 
              %>% unique())
  Competition_trait <- Competition
  Competition_trait$idTree <- match(Competition_trait$idTree, data_trait$idTree)
  Competition_trait <- filter(Competition_trait, !is.na(idTree))
  list(trait = trait,
       N = nrow(data_trait),
       J = nrow(Competition_trait),
       S = length(unique(data_trait$Species)),
       Trait = as.numeric(scale(data_trait[trait], center = F)),
       DBH = as.numeric(scale(data_trait$DBH, center = F)),
       TWI = as.numeric(scale(data_trait$TWI, center = F)),
       DBHj = as.numeric(scale(Competition_trait$DBHj, center = F)),
       Deltaj = as.numeric(scale(Competition_trait$dij, center = F)),
       weights = 1-data_trait$AreaOutside20,
       individual = as.numeric(as.factor(Competition_trait$idTree)),
       species = as.numeric(as.factor(data_trait$Species)),
       data = data_trait,
       competition = Competition_trait)
})
names(mdata) <- traits
```

```{r fits}
# fits <- lapply(mdata, function(x)
#   sampling(Model, chains = 2, data = x, save_warmup = F, include = F, pars = c('NCIj')))
# names(fits) <- traits
# save(fits, file = "./functional_save/InteractionWood.Rdata")
load("./functional_save/InteractionWood.Rdata")
pars <- c("alpha_s", "betaDBH_s", "betaTWI_s", "betaComp_s", "alphaNCI", "sigma")
```

# Introduction {-}

Subsequent analysis aimed to explore determinant of individual wood functional traits from Symphonia globulifera. More especially, we investigated how individual ontogeny, abiotic environment, and biotic interactions shaped its wood phenotype at several taxonomic scale, from individual to species. Determinant of the functional traits have been studied with the interaction model developed in document [A03-Models](A03-Models.html) and are further detailed.

**Real introduction to be developped (maybe only in the first draft and not directly in this analysis).**

# Material and Methods

## Study site

The study was conducted in the northernmost part of the Guiana Plateau region, at the Paracou field station. The site was characterized by an average of 3041 mm annual rainfall and a mean air temperature of 25.71 °C. Old tropical forest with an exceptional richness (over 750 woody species) has developed among the succession of small hills of this area, rising to 10–40 m a.s.l. [@Gourlet-Fleury2004].

The site is made of 16 permanent plots (fifteen 6.25 ha plus one 25 ha) which have been censused (DBH>10) every 1-2 years for more than 35 years. Nine of the plots were logged and subjected to human-induced disturbance in 1986.

## Individuals sampling

**To be adjusted.**

```{r headcount}
Individuals %>% 
  group_by(Genus, Species) %>% 
  summarise(N = n()) %>% 
  arrange(desc(N)) %>% 
  kable(caption = "Number of individuals sampled per genus and species.",
        escape = F, format = "pandoc") %>% 
  kable_styling(full_width = F)
```

## Trait measurements

**To be adjusted**

```{r Trait}
Individuals %>% 
  select(brBT, brBD, brWD) %>% 
  reshape2::melt(variable.name = "trait") %>% 
  filter(!is.na(value)) %>% 
  group_by(trait) %>% 
  summarise(N = n(),
            Value = paste0("$",round(mean(value), 2), "\\pm", 
                           round(sd(value), 2), "$")) %>% 
  mutate(Trait = c("branch Bark Thickness", "branch Bark Density",
                    "branch Wood Density")) %>% 
  mutate(Unit = c("$\\mu m$", "$g.cm^{-3}$", "$g.cm^{-3}$")) %>%
  select(Trait, Unit, trait, N, Value) %>% 
  kable(col.names = c("Trait", "Unit", "Abbreviation", "N", "Mean (sd)"), format = "pandoc",
    caption = "Functional traits measured, with trait unit, abbreviation, headcount, mean and standard error.", escape = F) %>% 
  kable_styling(full_width = F)
```

## Environmental variables

Three little correlated (Pearson's r < 0.14, see analysis [A02-Environment](A02-Environment.html)) ontogenetic and environmental descriptors were chosen to depict individual leaf traits. Diameter at breast height ($DBH$, $cm$) was chosen as an indirect proxy for ontogeny effect [but see @roggy_links_2005] but was shown to be confounded with light access through Dawkins index (see analysis [A02-Environment](A02-Environment.html)).

A neighbor crowding index [$NCI$; @Uriarte2004a] was used as a descriptor of biotic asymmetric competition through tree neighborhood, implying that other biotic effects, as herbivory and pathogens effects, were not taken into account. The neighborhood crowding index $NCI_i$ from tree individual $i$ was calculated with the following formula:
$$NCI_i = \sum _{j|\delta_{i,j}<20m} ^{J_i} DBH_j ^2 e^{-\alpha.\delta_{i,j}}$$
with $DBH_j$ the diameter from neighboring tree $j$ and $\delta_{i,j}$ its distance to individual tree $i$. $NCI_i$ is computed for all neighbors at a distance $\delta_{i,j}$ inferior to 20m as often observed in literature [ref]. $\alpha$ represents the decrease of neighbors $DBH_j$ effect with distance (note that  set to 0 represent local basal area). 

Finally, topographic wetness index ($TWI$) was selected between various abiotic descriptors available (see analysis [A02-Environment](A02-Environment.html)) and highlighted water accumulation areas, which is crucial information at local scale when it comes to tropical ecosystems [@ferry2010higher]. Descriptors used were derived from field censuses ($DBH$ and $NCI$) or derived from a 1-m resolution digital elevation model built using LiDAR campaign done in 2015 ($TWI$) using SAGA-GIS [ref].


## Analysis

We explained wood trait $Trait$ variation with ontogeny ($DBH$), abiotic environment ($TWI$), biotic interactions ($NCI$) and taxonomic levels (species complex $C$ and species $S$) with a linear mixed model including interaction between ontogeny and environment (more likely than an additive form without interactions, see analysis [A07-Additive](A07-Additive.html)).

Individual wood trait $Trait_{c,s,i}$ for species complex $c \in [1;C]$ and species $s \in [1;S_c]$ is first explained by its ontogeny confounded with light though individual DBH $DBH_i$ with a Michaelis Menten form (more likely than a linear form, see analysis [A05-Ontogeny](A05-Ontogeny.html)):
$$T_{c,s,i} \sim \mathcal{N}(\alpha_{env}.\frac{DBH_i}{{\beta_{DBH}}_{c,s} + DBH_i}, \sigma)$$
Because of the Michaelis Menten form $\beta_{DBH}$ is the value of DBH for which the trait account for half of its mature value (when DBH tend to its maximum value). With higher $\beta_{DBH}$, traits evolves slower towards its plateau, consequently, ontogeny affects more traits values. We will further use $DBH_{90}$ equal to $9.\beta_{DBH}$ being the DBH value for which the trait account for 90% of its maximum value that we can assume as the DBH of trait maturity.

Finally $\alpha_{env}$ is the trait maximum value in the Michaelis Menten and will be represented by an additive linear form of environmental effects represented by $TWI$ for abiotic environment and by $NCI$ for biotic interactions:
$$alpha_{env} = \alpha_{c,s} + {\beta_{TWI}}_{c,s}.TWI_i + {\beta_{Comp}}_{c,s}.NCI_i$$
where $\alpha_{c,s}$ is the intercept, $\beta_{TWI}$ is the slope of TWI effect, e.g. positive $\beta_{TWI}$ represents an increase of the trait value with water accumulation; whereas $\beta_{Comp}$ is the slope of competition effect, e.g. negative $\beta_{Comp}$ highlight a decrease of trait value with competition.

Species complex effect was integrated as a fixed effect on each parameter of the model and was later tested by Student T test between the two complex values for each parameter, a non significative value indicating no differentiation of the complex for the tested effect. Species effect was integrated as a nested random effect within each parameter and evaluated through species variance for each parameter ($\sigma_{Intercept}$, $\sigma_{DBH}$, $\sigma_{TWI}$, $\sigma_{Comp}$), a high variance indicating a strong diversity of species answers within complex for the tested effect.

Traits, DBH and TWI were all reduced for the model inference, in order to ease model inference and later compare strength of effects between traits and between effects. A Bayesian method was used to infer parameters of the model regarding each leaf traits using `stan` language [ref] and `rstan` package [ref] in the R environment [ref] (see supplementary material [S1: Model] for model equations and `stan` code).

# Results

**To be written**

```{r summary}
lapply(fits, function(fit)
  broom::tidyMCMC(fit, pars = c(pars, "lp__"), droppars = NULL, rhat = T)) %>%
  bind_rows(.id = "trait") %>% 
  mutate(species = gsub("([[:alpha:]])", "", term)) %>% 
  select(trait, term, species, estimate, std.error, rhat) %>% 
  mutate(species = gsub("([[:punct:]])", "", species)) %>% 
  mutate(species = recode_factor(species, `2` = "S. sp1", 
                                 `1` = "S. globulifera")) %>% 
  mutate(term = gsub("([[:digit:]])", "", term)) %>% 
  mutate(term = gsub("([[:punct:]])", "", term)) %>% 
  mutate(term = as.factor(gsub("c", "", term))) %>% 
  mutate(term = recode_factor(term, 
                              alphas = "$\\alpha$",
                              betaDBHs = "$\\beta_{DBH}$", 
                              betaTWIs = "$\\beta_{TWI}$", 
                              betaComps = "$\\beta_{Comp}$", 
                              alphaNCI = "$\\alpha_{NCI}$",
                              sigma = "$\\sigma^2$",
                              lp = "log-likelihood")) %>% 
  mutate(trait = recode_factor(trait, 
                              invSLA = "$\\frac{1}{SLA}$",
                              LDMC = "$LDMC$", 
                              LT = "$LT$", 
                              invLA = "$\\frac{1}{LA}$",
                              CC = "$CC$")) %>% 
  reshape2::dcast(term + species ~ trait, value.var = "estimate") %>% 
  rename(Parameter = term, Complex = species) %>% 
  kable(caption = "Model parameters for each species with reduced traits and descriptors.",
        escape = F, digits = 3, format = "pandoc") %>% 
  kable_styling(full_width = F) %>% 
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2)
```

```{r ontogeny, fig.cap="Ontogeny effect represented by the $DBH_{90}$ and associated species variance. Grey vertical line indicates the census recruitment DBH (10 cm), whereas red and blue vertical lines indicate maximum sampled diameter for respectively Symhponia and Eschweilera."}
lapply(fits, function(fit) 
  mcmc_intervals_data(as.array(fit,
                               pars = c("betaDBH_s")))) %>% 
  bind_rows(.id = "trait") %>% 
  mutate(species = gsub("([[:alpha:]])", "", parameter)) %>% 
  mutate(species = gsub("([[:punct:]])", "", species)) %>% 
  mutate(species = recode_factor(species, `2` = "S. sp1", 
                                 `1` = "S. globulifera")) %>% 
  mutate(parameter = gsub("([[:digit:]])", "", parameter)) %>% 
  mutate(parameter = gsub("([[:punct:]])", "", parameter)) %>%
  select(-outer_width, -inner_width, -point_est) %>% 
  select(trait, parameter, species, ll, l, m, h, hh) %>% 
  mutate_at(vars("ll", "l", "m", "h", "hh"), funs(.*32.58441)) %>%
  mutate_at(vars("ll", "l", "m", "h", "hh"), funs(ifelse(parameter == "betaDBH",
                                                         .*9, .))) %>%
  mutate(parameter = recode_factor(parameter, betaDBHs = "DBH[90]")) %>%
  ggplot(aes(x = trait, xend = trait, col = species, fill = species)) +
  geom_hline(yintercept = 10, color = "gray90", size = 0.5) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  coord_flip() +
  facet_wrap(~ parameter, labeller = label_parsed, scales = "free",
             nrow = 2) +
  xaxis_title(F) + ylab("Diameter at Breast Hieght (DBH, cm)") +
  scale_y_sqrt(breaks = scales::pretty_breaks(10)) +
  theme(legend.position="bottom") +
  ylim(NA, 200)
```

```{r environment, fig.cap="Environment effects represented by TWI and NCI (for reduced variables and traits)."}
S_sqrt_trans <- function() scales::trans_new("S_sqrt",
                                             function(x) sign(x)*sqrt(abs(x)),
                                             function(x) x^2*sign(x))
lapply(fits, function(fit) 
  mcmc_intervals_data(as.array(fit,
                               pars = c("betaTWI_s",
                                        "betaComp_s")))) %>% 
  bind_rows(.id = "trait") %>% 
  mutate(species = gsub("([[:alpha:]])", "", parameter)) %>% 
  mutate(species = gsub("([[:punct:]])", "", species)) %>% 
  mutate(species = ifelse(species == "", NA, species)) %>% 
  mutate(species = recode_factor(species, `2` = "S. sp1", 
                                 `1` = "S. globulifera")) %>% 
  mutate(parameter = gsub("([[:digit:]])", "", parameter)) %>% 
  mutate(parameter = gsub("([[:punct:]])", "", parameter)) %>% 
  mutate(variable = ifelse(grepl("TWI", parameter), "TWI", "NCI")) %>% 
  mutate(parameter = ifelse(grepl("beta", parameter), "beta", "sigma^2")) %>% 
  mutate(parameter = factor(parameter, levels = c("beta", "sigma^2"))) %>%
  mutate(variable = factor(variable, levels = c("TWI", "NCI"))) %>%
  ggplot(aes(x = trait, xend = trait, col = species, fill = species)) +
  geom_hline(yintercept = 0, color = "gray90", size = 0.5) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  coord_flip() +
  facet_grid(variable ~ parameter, labeller = label_parsed, scales = "free") +
  xaxis_title(F) +
  yaxis_title(F) +
  scale_y_continuous(trans="S_sqrt") +
  theme(legend.position="bottom")
```

# Discussion

**To be written**

## Conclusion

*Take home messages…*

-

# Supplementary materials

## S1: Model

We explained leaf trait $Trait$ variation with ontogeny ($DBH$), abiotic environment ($TWI$), biotic interactions ($NCI$) and taxonomic levels (species complex $C$ and species $S$) with a linear mixed model including interaction between ontogeny and environment (more likely than an additive form without interactions, see analysis [A07-Additive](A07-Additive.html)). We obtained the following model (see [Material and Methods] for more detail on the model form):

\begin{equation} 
\begin{split}
  T_{c,s,i} \sim \mathcal{N}(\frac{DBH_i}{{\beta_{DBH}}_{c,s} + DBH_i} \times (\alpha_{c,s} + {\beta_{TWI}}_{c,s}.TWI_i + {\beta_{Comp}}_{c,s}.\sum_{j=1}^{J} DBH_j^{2} . e^{-{\alpha_{NCI}}_{c,s}.\delta_{i,j}}), \sigma)    \\
  \Theta_{c,s} \sim \mathcal{N}^5(\Theta_c,\sigma_{species}) ~|~ \Theta =
   \begin{bmatrix}
           \alpha \\
           \beta_{DBH} \\
           \beta_{TWI} \\
           \beta_{Comp}
  \end{bmatrix},~\sigma_{species}
  \begin{bmatrix}
           \sigma_{Intercept} \\
           \sigma_{DBH} \\
           \sigma_{TWI} \\
           \sigma_{Comp}
  \end{bmatrix}
\end{split}
\end{equation}
Resulting in the following `stan` code with selected priors:

```{stan stanModel, output.var="Model", echo=T, eval=F}
data {
  int<lower=1>  N ; // # of observations
  int<lower=1>  J ; // # of neighbors
  int<lower=1> S ; // # species
  int<lower=1> C ; // # complex
  vector[N] Trait ; // Trait
  vector[N] DBH ; // Diameter at Breast Height
  vector[N] TWI ; // Topographic Wetness Index
  vector[J] DBHj ; // DBH neighbor
  vector[J] Deltaj ; // Distance neighbor
  vector[N] weights ;
  int<lower=1, upper=N>  individual[J] ; // individuals index in neighbor matrix
  int<lower=1, upper=S> species[N] ; // species index
  int<lower=1, upper=C> speciesincomplex[S] ; // species index wihtin complex
  int<lower=1, upper=C> complex[N] ; // species index
}
parameters {
  vector [C] alpha ; // Intercept for complexes
  vector<lower=0> [C]  betaDBH ; // DBH half-load for complexes
  vector[C] betaTWI ; // TWI slope for complexes
  vector[C] betaComp ; // Competition slope for complexes
  real<lower=0> alphaNCI ;
  vector<lower=0> [S] alpha_s_tilde ; // Intercept for species
  vector<lower=0> [S] betaDBH_s_tilde ; // DBH half-load for species
  vector[S] betaTWI_s_tilde ; // TWI slope for species
  vector[S] betaComp_s_tilde ; // Competition slope for species
  real<lower=0> sigmaIntercept ; // Intercept variance for species
  real<lower=0> sigmaDBH ; // DBH half-load variance for species
  real<lower=0> sigmaTWI ; // TWI slope variance for species
  real<lower=0> sigmaComp ; // Competition slope variance for species
  real<lower=0> sigma ; // Variance
}
transformed parameters {
  vector[S] alpha_s ; // Species uncentered effects
  vector<lower=0> [S] betaDBH_s ;
  vector[S] betaTWI_s ;
  vector[S] betaComp_s ;
  vector[J] NCIj ; // Crowding index
  vector[N] NCI ;
  alpha_s = alpha[speciesincomplex] + sigmaIntercept*alpha_s_tilde ;  // Species uncentered effects
  betaDBH_s = betaDBH[speciesincomplex] + sigmaDBH*betaDBH_s_tilde ;
  betaTWI_s = betaTWI[speciesincomplex] + sigmaTWI*betaTWI_s_tilde ;
  betaComp_s = betaComp[speciesincomplex] + sigmaComp*betaComp_s_tilde ;
  NCIj = DBHj .* DBHj .* exp(-alphaNCI * Deltaj) ;  // Crowding index
  NCI = rep_vector(0.0, N) ;
  for(j in 1:J)
   NCI[individual[j]] += NCIj[j] ;
  NCI = (1 ./ weights) .* NCI ;
  NCI = NCI ./ sd(NCI) ;
}
model {
  alpha ~ normal(0, 10^6) ; // Priors
  betaDBH ~ lognormal(0,1) ;
  betaTWI ~ normal(0, 10^6) ;
  betaComp ~ normal(0, 10^6) ;
  alphaNCI ~ lognormal(0, 1) ;
  alpha_s_tilde ~ normal(0, 1) ;
  betaDBH_s_tilde ~ normal(0, 1) ;
  betaTWI_s_tilde ~ normal(0, 1) ;
  betaComp_s_tilde ~ normal(0, 1) ;
  sigmaIntercept ~ lognormal(0, 1) ;
  sigmaDBH ~ lognormal(0, 1) ;
  sigmaTWI ~ lognormal(0, 1) ;
  sigmaComp ~ lognormal(0, 1) ;
  sigma ~ cauchy(0, 5) ;
  Trait ~ normal((alpha_s[species] + betaTWI_s[species] .* TWI +  betaComp_s[species] .* NCI) .* (DBH ./ (betaDBH_s[species] + DBH)), sigma) ; // Likelihood
} 
generated quantities {
  vector[N] Trait_pred ; // Predictions
  vector[N] Trait_predDBH ;
  vector[N] Trait_predTWI ;
  vector[N] Trait_predNCI ;
  Trait_pred = (alpha[complex] + betaTWI[complex] .* TWI + betaComp[complex] .* NCI) .* (DBH ./ (betaDBH[complex] + DBH));
  Trait_predDBH = (alpha[complex] + betaTWI[complex] * mean(TWI) + betaComp[complex] * mean(NCI)) .* (DBH ./ (betaDBH[complex] + DBH)) ;
  Trait_predTWI = (alpha[complex] + + betaTWI[complex] .* TWI + betaComp[complex] * mean(NCI)) .* (mean(DBH) ./ (betaDBH[complex] + mean(DBH))) ;
  Trait_predNCI = (alpha[complex] + betaTWI[complex] * mean(TWI) + betaComp[complex] .* NCI) .* (mean(DBH) ./ (betaDBH[complex] + mean(DBH))) ;
}
```

## S2: Diagnostic

Model inference converged ($\hat R = 1$, figure \@ref(fig:mcmc)) for every traits with relatively little or no divergent transition (< 0.1%), and relatively uncorrelated parameters. Post predictive check (PPC) with density overlay of observed trait values against predicted trait values showed relatively similar distribution taking into account that the model form was generic for every traits (figure \@ref(fig:ppc)). We can note that the model reproduced well multimodality for LDMC and invLA but had difficulty to represent high trait values for invSLA, LT and CC.

```{r mcmc, fig.cap="Markov chains trace plot after warmup for leaf thickness model."}
# lapply(fits, check_divergences)
mcmc_trace(as.array(fits$brWD, pars = c(pars, "lp__")),
             facet_args = list(labeller = label_parsed))
# mcmc_pairs(as.array(fits$invSLA), regex_pars = pars)
```

```{r ppc, fig.cap="Post predictive check (PPC) with density overlay of observed trait values against predicted trait."}
cowplot::plot_grid(plotlist = mapply(function(fit, data) {
  yrep <- as.matrix(fit, pars = "Trait_pred")
  ppc_dens_overlay(data$Trait, yrep[sample(nrow(yrep), 25), ])
}, fit = fits, data = mdata, SIMPLIFY = F), labels = names(fits), nrow = 3)
```

## S4: Predictions

Supplementary material S4 includes model predictions for every traits and descriptor (each descriptor is showed with other predictors set to their mean), and highlights the difference of goodness of fit among leaf functional traits.

```{r prediction, fig.cap="Predictions for every traits and descriptors (each dewscriptor is showed with other predictors set to their mean).", fig.width=12, fig.height=12}
lapply(as.list(c("DBH", "TWI", "NCI")), function(variable)
  lapply(as.list(traits), function(trait) {
    if(variable == "NCI") {
      value <- apply(as.matrix(fits[[trait]], pars = "NCI"), 2, mean)
    } else {
      value <- mdata[[trait]][[variable]]
    }
    data.frame(
      trait = trait, 
      variable = variable,
      Y = mdata[[trait]]$Trait,
      value = value,
      Species = mdata[[trait]]$data$SpeciesLong,
      mu = apply(as.matrix(fits[[trait]], pars = paste0("Trait_pred", variable)), 
                 2, mean),
      mu5 = apply(as.matrix(fits[[trait]], pars = paste0("Trait_pred", variable)), 
                  2, quantile, probs = 0.05),
      mu95 = apply(as.matrix(fits[[trait]], pars = paste0("Trait_pred", variable)), 
                   2, quantile, probs = 0.95)
    )
  }) %>% bind_rows()) %>% 
  bind_rows() %>% 
  ggplot(aes(x = value, col = Species)) +
  geom_point(aes(y = Y)) +
  geom_ribbon(aes(ymin = mu5, ymax = mu95), alpha = 0.2) +
  geom_line(aes(y = mu)) +
  facet_grid(trait ~ variable, scales = "free")
```

# References

