---
title: "A09 : Sensitivity Analysis"
date: '`r Sys.Date()`'
author: Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: no
    toc: true
    toc_float: yes
    theme: flatly
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
    keep_tex: true
  bookdown::word_document2: default
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
#rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(kableExtra)
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 10, fig.width = 10,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "../../data/Paracou/"
```

```{r data, eval=T}
# traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>%
#   mutate(Genus = "Symphonia") %>%
#   rename(Species = Morphotype) %>%
#   mutate(Species = ifelse(Species == "Indet.",
#                           c("globulifera", "sp.1", "sp.1")[fct_recode(Bark, "globulifera" = "G",
#                                      "sp.1" =  "S")], Species))
# traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   filter(!(Plot == 14 & SubPlot == 1 & TreeFieldNum == 760)) %>%  # outlier
#   filter(!(Species %in% c("congestiflora","simiorum","persistens")))
# traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>%
#   mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>%
#   group_by(idTree, Plot, SubPlot, TreeFieldNum, Genus, Species,
#            SpeciesLong, Bark, Dawkins) %>%
#   summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC",
#                     "brBT", "brBD", "brWD"), mean, na.rm = T) %>%
#   ungroup() %>%
#   mutate(invSLA=1/SLA) %>%
#   mutate(invLA=1/LA)
# load("./functional_save/env.Rdata")
# Individuals <-  left_join(traits, env, by = "idTree", suffix = c("", ".y"))
# rm(traitsEschweilera, traitsSymphonia, traits, paracou, env)
# save(Individuals, file = "./functional_save/Individuals.Rdata")
load("./functional_save/Individuals.Rdata")
load("./functional_save/CompetitionMatrix.Rdata")
load("./functional_save/Interaction.Rdata")
```

# Introduction

> We will test the effect of covariables by computing model predictions with all variables (full) with model predictions with all variable set to their mean except the tested one. Thus, the model will be sensitive to the variable if the $\hat Y$ does not change.

Practically, working with the following model:

$$T_{c,s,i} \sim \mathcal{N}(\frac{DBH_i}{{\beta_{DBH}}_{c,s} + DBH_i} \times (\alpha_{c,s} + {\beta_{TWI}}_{c,s}.TWI_i + {\beta_{Comp}}_{c,s}.NCI), \sigma)$$
We will test variable effect looking at:

$$\Delta \hat T = \sqrt{(\hat T_{full} - \hat T_{\beta_{TWI}})^2}$$
In conclusion we will test following models for the different effects :

```{r}
data.frame(
  Variable = c("DBH", "TWI", "NCI", "Species"),
  Test = c(
    "$T_{c,s,i} \\sim \\mathcal{N}(\\frac{DBH_i}{{\\beta_{DBH}}_{c} + DBH_i} \\times (\\alpha_{c} + {\\beta_{TWI}}_{c}.\\overline{TWI} + {\\beta_{Comp}}_{c}.\\overline{NCI}), \\sigma)$",
    "$T_{c,s,i} \\sim \\mathcal{N}(\\frac{\\overline{DBH_i}}{{\\beta_{DBH}}_{c} + \\overline{DBH_i}} \\times (\\alpha_{c} + {\\beta_{TWI}}_{c}.TWI + {\\beta_{Comp}}_{c}.\\overline{NCI}), \\sigma)$",
    "$T_{c,s,i} \\sim \\mathcal{N}(\\frac{\\overline{DBH_i}}{{\\beta_{DBH}}_{c} + \\overline{DBH_i}} \\times (\\alpha_{c} + {\\beta_{TWI}}_{c}.\\overline{TWI} + {\\beta_{Comp}}_{c}.NCI), \\sigma)$",
    "$T_{c,s,i} \\sim \\mathcal{N}(\\frac{\\overline{DBH_i}}{{\\beta_{DBH}}_{c,s} + \\overline{DBH_i}} \\times (\\alpha_{c,s} + {\\beta_{TWI}}_{c,s}.\\overline{TWI} + {\\beta_{Comp}}_{c,s}.\\overline{NCI}), \\sigma)$"
  )
) %>% 
  kable(format = "pandoc")
```

# Analsysis

```{r predicitons}
traits <- c("invSLA", "LDMC", "LT", "invLA", "CC")
preds <- lapply(traits, function(trait){
  data_trait <- Individuals[!is.na(unlist(Individuals[,trait])),]

  DBH <- data_trait$DBH/sd(data_trait$DBH)
  TWI <- data_trait$TWI/sd(data_trait$TWI)
  NCI <- apply(as.matrix(fits[[trait]], pars = "NCI"), 2, mean)
  species <- as.numeric(as.factor(data_trait$Species))
  complex <- as.numeric(as.factor(data_trait$Genus))

  alpha <- as.matrix(fits[[trait]], pars = "alpha")
  betaDBH <- as.matrix(fits[[trait]], pars = "betaDBH")
  betaTWI <- as.matrix(fits[[trait]], pars = "betaTWI")
  betaComp <- as.matrix(fits[[trait]], pars = "betaComp")
  alpha_s <- as.matrix(fits[[trait]], pars = "alpha_s")
  betaDBH_s <- as.matrix(fits[[trait]], pars = "betaDBH_s")
  betaTWI_s <- as.matrix(fits[[trait]], pars = "betaTWI_s")
  betaComp_s <- as.matrix(fits[[trait]], pars = "betaComp_s")

  Y <- unlist(data_trait[trait])/sd(unlist(data_trait[trait]))
  Yp <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha_s[n,species] + betaTWI_s[n,species] * TWI +  betaComp_s[n,species] * NCI) * (DBH / (betaDBH_s[n,species] + DBH)), simplify = F))
  Ycomplex <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha[n,complex] + betaTWI[n,complex] * TWI +  betaComp[n,complex] * NCI) * (DBH / (betaDBH[n,complex] + DBH)), simplify = F))
  Ydbh <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha[n,complex] + betaTWI[n,complex] * mean(TWI) +  betaComp[n,complex] * mean(NCI)) * (DBH / (betaDBH[n,complex] + DBH)), simplify = F))
  Ytwi <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha[n,complex] + betaTWI[n,complex] * TWI +  betaComp[n,complex] * mean(NCI)) * (mean(DBH) / (betaDBH[n,complex] + mean(DBH))), simplify = F))
  Ycomp <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha[n,complex] + betaTWI[n,complex] * mean(TWI) +  betaComp[n,complex] * NCI) * (mean(DBH) / (betaDBH[n,complex] + mean(DBH))), simplify = F))
  Yspecies <- do.call("rbind", sapply(1: nrow(alpha), function(n) (alpha_s[n,species] + betaTWI_s[n,species] * mean(TWI) +  betaComp_s[n,species] * mean(NCI)) * (mean(DBH) / (betaDBH_s[n,species] + mean(DBH))), simplify = F))

  Ddbh <- sqrt((Yp - Ydbh)^2)
  Dtwi <- sqrt((Yp - Ytwi)^2)
  Dcomp <- sqrt((Yp - Ycomp)^2)
  Dspecies <- sqrt((Yp - Yspecies)^2)

data.frame(
  Trait = trait,
  DBH = data_trait$DBH, 
  TWI = data_trait$TWI, 
  NCI = NCI,
  Genus = data_trait$Genus,
  Species = data_trait$Species,
  Y = unlist(data_trait[trait])/sd(unlist(data_trait[trait])),
  Yp = apply(Yp, 2, mean),
  Yp5 = apply(Yp, 2, quantile, probs = 0.05),
  Yp95 = apply(Yp, 2, quantile, probs = 0.95),
  Ydbh = apply(Ydbh, 2, mean),
  Ydbh5 = apply(Ydbh, 2, quantile, probs = 0.05),
  Ydbh95 = apply(Ydbh, 2, quantile, probs = 0.95),
  Ytwi = apply(Ytwi, 2, mean),
  Ytwi5 = apply(Ytwi, 2, quantile, probs = 0.05),
  Ytwi95 = apply(Ytwi, 2, quantile, probs = 0.95),
  Ycomp = apply(Ycomp, 2, mean),
  Ycomp5 = apply(Ycomp, 2, quantile, probs = 0.05),
  Ycomp95 = apply(Ycomp, 2, quantile, probs = 0.95),
  Yspecies = apply(Yspecies, 2, mean),
  Yspecies5 = apply(Yspecies, 2, quantile, probs = 0.05),
  Yspecies95 = apply(Yspecies, 2, quantile, probs = 0.95),
  Ddbh = apply(Ddbh, 2, mean),
  Ddbh5 = apply(Ddbh, 2, quantile, probs = 0.05),
  Ddbh95 = apply(Ddbh, 2, quantile, probs = 0.95),
  Dtwi = apply(Dtwi, 2, mean),
  Dtwi5 = apply(Dtwi, 2, quantile, probs = 0.05),
  Dtwi95 = apply(Dtwi, 2, quantile, probs = 0.95),
  Dcomp = apply(Dcomp, 2, mean),
  Dcomp5 = apply(Dcomp, 2, quantile, probs = 0.05),
  Dcomp95 = apply(Dcomp, 2, quantile, probs = 0.95),
  Dspecies = apply(Dspecies, 2, mean),
  Dspecies5 = apply(Dspecies, 2, quantile, probs = 0.05),
  Dspecies95 = apply(Dspecies, 2, quantile, probs = 0.95)
)}) %>% bind_rows()
```

# Results


```{r}
preds %>%
  select(Trait, Genus, Species, DBH, TWI, NCI, 
         Y, Yp, Yspecies, Ydbh, Ytwi, Ycomp) %>% 
  rename(Observed = Y) %>% 
  reshape2::melt(id.vars = c("Trait", "Genus", "Observed", "Species",
                             "DBH", "TWI", "NCI"),
                 variable.name = "Model", value.name = "Y") %>% 
  ggplot(aes(x = DBH, col = Species)) +
  geom_point(aes(y = Observed)) +
  geom_line(aes(y = Y), lwd = 1.3) +
  facet_grid(Trait ~ Model, scales = "free")
```

```{r}
preds %>%
  select(Trait, Genus, Species, DBH, TWI, NCI, 
         Y, Yp, Yspecies, Ydbh, Ytwi, Ycomp) %>% 
  rename(Observed = Y) %>% 
  reshape2::melt(id.vars = c("Trait", "Genus", "Observed", "Species",
                             "DBH", "TWI", "NCI"),
                 variable.name = "Model", value.name = "Y") %>% 
  ggplot(aes(x = TWI, col = Species)) +
  geom_point(aes(y = Observed)) +
  geom_line(aes(y = Y), lwd = 1.3) +
  facet_grid(Trait ~ Model, scales = "free")
```

```{r}
preds %>%
  select(Trait, Genus, Species, DBH, TWI, NCI, 
         Y, Yp, Yspecies, Ydbh, Ytwi, Ycomp) %>% 
  rename(Observed = Y) %>% 
  reshape2::melt(id.vars = c("Trait", "Genus", "Observed", "Species",
                             "DBH", "TWI", "NCI"),
                 variable.name = "Model", value.name = "Y") %>% 
  ggplot(aes(x = NCI, col = Species)) +
  geom_point(aes(y = Observed)) +
  geom_line(aes(y = Y), lwd = 1.3) +
  facet_grid(Trait ~ Model, scales = "free")
```

```{r}
preds %>%
  select(Trait, Genus, Species, Y, Yp, Yspecies, Ydbh, Ytwi, Ycomp) %>% 
  rename(Observed = Y, Full = Yp, Species = Yspecies, DBH = Ydbh, 
         TWI = Ytwi, Competition = Ycomp) %>% 
  reshape2::melt(id.vars = c("Trait", "Genus", "Observed", "Species"),
                 variable.name = "Model", value.name = "Predicted") %>% 
  ggplot(aes(Observed, Predicted)) +
  geom_point() +
  geom_abline(slope = 1, intercept =  1, col = "red") +
  facet_grid(Trait ~ Model, scales = "free")
```

```{r}
preds %>%
  select(Trait, Genus, Ddbh, Dtwi, Dcomp, Dspecies) %>% 
  rename(DBH = Ddbh, TWI = Dtwi, Competition = Dcomp, Species = Dspecies) %>% 
  reshape2::melt(id.vars = c("Trait", "Genus")) %>% 
  mutate(variable = factor(variable, levels = c("Competition", "TWI", 
                                                "DBH", "Species"))) %>%
  ggplot(aes(variable, value, fill = variable)) +
  geom_boxplot() +
  facet_grid(Trait ~ Genus, scales = "free") +
  coord_flip() +
  scale_y_sqrt() +
  scale_fill_discrete(guide = "none") +
  xlab("") + ylab(expression(Delta(Prediction)))
```

# Discussion

## Conclusion

# References
