```{r setupNichenGrowth, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "../../data/Paracou/"
```

```{r dataNichenGrowth}
load("./functional_save/Individuals.Rdata")
load("../distributions/distribution_save/env.Rdata")
load("../distributions/distribution_save/Competition.Rdata")
load("../distributions/distribution_save/species.Rdata")
trees <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>% 
  tbl("Paracou") %>% 
  filter(CensusYear == 2015) %>%
  filter(Species != "Indet.") %>% 
  collect()
Competition <- Competition %>% 
  filter(idTree %in% Individuals$idTree) %>% 
  mutate(dij = ifelse(dij <1, 1, dij)) %>% 
  left_join(dplyr::select(trees, idTree, Genus, Species)) %>% 
  mutate(strata = as.numeric(Genusj == Genus, Speciesj == Species)) %>% 
  group_by(idTree) %>% 
  summarise(NCIhetero = log(sum(DBHj^2*exp(-0.25*dij)*abs(strata-1))+1),
            NCIcon = log(sum(DBHj^2*exp(-0.25*dij)*strata)+1))
Complexes <- bind_rows(
  data.frame(Complex = "Chartacea", Genus = "Eschweilera",
             Species = c("simiorum", "congestiflora")),
  data.frame(Complex = "Parvifolia", Genus = "Eschweilera",
             Species = c("pedicellata", "coriacea", "decolorans", "sagotiana",
                         "wachenheimii", "grandiflora_form2")),
  data.frame(Complex = "Licania", Genus = "Licania",
             Species = c("alba", "membranacea", "canescens", "micrantha",
                         "ovalifolia", "sprucei", "densiflora",
                         "laxiflora", "parvifructa")),
  data.frame(Complex = "Iryanthera", Genus = "Iryanthera",
             Species = c("hostmannii", "sagotiana")),
  data.frame(Complex = "Talisia", Genus = "Talisia",
             Species = c("hexaphylla", "praealta", "simaboides")),
  data.frame(Complex = "Symphonia", Genus = "Symphonia",
             Species = c("globulifera", "sp.1")))
parameters <- lapply(fits, function(fit)
  apply(as.matrix(fit, pars = c("alpha", "beta", "gamma")), 2, mean) %>% 
    data.frame(parameter = names(.), value = .) %>% 
    separate(parameter, c("parameter", "type"), "\\[", fixed = T) %>% 
    mutate(type = gsub("]", "", type)) %>% 
    separate(type, c("SpeciesNum", "variableNum"), ",", convert = T)) %>% 
  bind_rows(.id = "Complex") %>% 
  left_join(data.frame(variableNum = 1:3, 
                      variable = c("TWI", "NCIhetero", "NCIcon"))) %>% 
  left_join(lapply(unique(Complexes$Complex), function(complex)
    data.frame(Complex = complex,
               SpeciesNum = 1:length(unique(filter(Complexes, Complex == complex)$Species)),
               Species = levels(as.factor(filter(Complexes, Complex == complex)$Species)))
  ) %>% bind_rows()) %>% 
  dplyr::select(Complex, Species, parameter, variable, value) %>% 
  reshape2::dcast(Complex + Species ~ parameter + variable, value.var = "value")
Individuals <- Individuals %>% 
  group_by(Species) %>% 
  filter(n() > 20) %>% 
  left_join(env) %>% 
  left_join(Complexes) %>% 
  left_join(Competition) %>% 
  mutate_at(c("TWI", "NCIhetero", "NCIcon"), funs(scale)) %>% 
  left_join(parameters) %>% 
  mutate(Suitability = ifelse(!is.na(NCIhetero) & !is.na(NCIcon) & !is.na(TWI) & !is.na(alpha_NA),
                              tsensembler:::softmax(alpha_NA + beta_TWI*TWI + beta_NCIhetero*NCIhetero +
                                               NCIcon*NCIcon + gamma_TWI*TWI^2 +
                                               gamma_NCIhetero*NCIhetero^2 + gamma_NCIcon*NCIcon^2), NA)) %>% 
  mutate(logSuitability = log(Suitability))
```

# Niche and growth

The aim of this analysis is to quickly explore the potential role of species relative niche in tree growth. For that we used three different methods:

1. We fitted a growth potential $AGRmax_{ind}$ for every individual that we tried to explain by species relative niche (**Individual growth paragraph**)
1. We computed a vigor index for every individual based on the difference between species mean predicted growth and individual observed growth (**Individual vigor paragraph**)
1. We integrated species niche in the growth model as a new reductor (**Traits in model paragraph**)

## Individual growth

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{individual}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
We obtained reasonable predicitons for individual growth (Fig. \@ref(fig:predicitonIndividualGrowth)), besides due to different sampling depth between individuals the model can be really uncertain for lot of individuals. Globally the niche was not related to individual growth (Fig. \@ref(fig:NicheRelationIndividualGrowth) and Tab. \@ref(tab:NicheLmIndividualGrowth)).

```{stan modelIndividualNichenGrowth, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
  int<lower=1> I ; // Nb of individuals
  int<lower=0> ind[N] ; // individual vector
  int<lower=0> indsp[I] ; // individual in species vector
}
parameters {
  vector<lower=0.1,upper=10>[I] AGRmaxind ; // individual potential growth
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=10>[S] sigmaInd ; // individual potential growth deviation
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  AGRmaxind ~ normal(AGRmax[indsp], sigmaInd[indsp]) ;
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fitsNichenGrowth}
data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species)),
#                             I = length(unique(data$idTree)),
#                             ind = as.numeric(as.factor(data$idTree)),
#                             indsp = data %>%
#                               dplyr::select(Species, idTree) %>%
#                               mutate_all(as.factor) %>%
#                               mutate_all(as.numeric) %>%
#                               arrange(idTree) %>%
#                               unique() %>%
#                               dplyr::select(Species) %>%
#                               unlist()
#                 ))
# save(fit, file = "./functional_save/growth.Rdata")
load("./functional_save/growth.Rdata")
```

```{r predicitonIndividualGrowthNichenGrowth, fig.cap="Model predictions for individual growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1))) + 
  geom_line(aes(y = AGRpred))
```

```{r NicheRelationIndividualGrowthNichenGrowth, fig.cap="Individual growth - Niche relation."}
data %>% 
  mutate(AGRmaxind = apply(as.matrix(fit, pars = "AGRmaxind"), 2, mean)[as.numeric(as.factor(data$idTree))]) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, AGRmaxind, logSuitability) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  filter(!is.na(logSuitability)) %>% 
  ggplot(aes(logSuitability, AGRmaxind, col = Species)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r NicheLmIndividualGrowthNichenGrowth}
data %>% 
  mutate(AGRmaxind = apply(as.matrix(fit, pars = "AGRmaxind"), 2, mean)[as.numeric(as.factor(data$idTree))]) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, AGRmaxind, logSuitability) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  filter(!is.na(logSuitability)) %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(AGRmaxind ~ logSuitability, data = .)) %>% 
  broom::tidy(lm) %>% 
  filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model AGRmaxind ~ logSuitability for every species.")
```

## Individual vigor

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
And computed the following vigor index:
$$Vigor_{individual}=\frac{\int _{t0_{individual}} ^{tend_{individual}} AGRobserved_{individual}}{\int _{t0_{individual}} ^{tend_{individual}} AGRpredicted_{individual}}$$
We obtained reasonable predicitons for species growth (Fig. \@ref(fig:predicitonVigor)). Globally the niche was not related to individual vigor (Fig. \@ref(fig:NicheRelationVigor) and Tab. \@ref(tab:NicheLmVigor)).

```{stan modelSpNichenGrowth, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fitSpNichenGrowth}
data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthsp.Rdata")
load("./functional_save/growthsp.Rdata")
```

```{r predicitonVigorNichenGrowth, fig.cap="Model predictions for species growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1)), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r NicheRelationVigorNichenGrowth, fig.cap="Individual vigor - niche relation."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  group_by(idTree) %>% 
  summarise(Vigor = (sum(agr)-sum(AGRpred))/n()) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, Vigor, logSuitability) %>% 
  unique() %>% 
    filter(!is.na(logSuitability)) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  ggplot(aes(logSuitability, Vigor, col = SpeciesLong)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r NicheLmVigorNichenGrowth}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  group_by(idTree) %>% 
  summarise(Vigor = (sum(agr)-sum(AGRpred))/n()) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, Vigor, logSuitability) %>% 
  unique() %>% 
  filter(!is.na(logSuitability)) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(Vigor ~ logSuitability, data = .)) %>% 
  broom::tidy(lm) %>% 
  filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model Vigor ~ logSuitability for every species.")
```

## Niche in model

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}.e^{-\beta_{logSuitability}.logSuitability}, \sigma)$$
We obtained reasonable predicitons for species growth (Fig. \@ref(fig:predicitonlogSuitability)). Globally the niche did seem to have little to no effect on individual growth, except for a negative effect on *S. globulifera* and a positive effect on *S. sp1* (Fig. \@ref(fig:TWIPosteriors)).

```{stan modellogSuitabilityNichenGrowth, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  vector[N] logsuitability ; 
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1>[S] AGRmax ; // species potential growth
  vector[S] logSuitability ; 
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-logSuitability[sp[n]]*logsuitability[n]), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-logSuitability[sp[n]]*logsuitability[n]) ;
}
```

```{r fitlogSuitabilityNichenGrowth}
data <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  left_join(Individuals) %>% 
  ungroup() %>% 
  dplyr::select(idTree, Genus, agr, dbh, logSuitability, Species) %>% 
  mutate_at(vars("logSuitability"), scale) %>% 
  mutate_at(vars("logSuitability"), as.vector) %>% 
  na.omit()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             logsuitability = data$logSuitability,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthlogSuitability.Rdata")
load("./functional_save/growthlogSuitability.Rdata")
```

```{r predicitonlogSuitabilityNichenGrowth, fig.cap="Model predictions for logSuitability growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1)), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r logSuitabilityPosteriorsNichenGrowth, fig.cap="Model posteriors for logSuitability effect on growth."}
bayesplot::mcmc_areas(as.array(fit, pars = c("logSuitability")))
```

## Conclusion

This was a rapide test. But at the exception of *Symphonia* species in method 3, all methods seem to indicant no link between species niche and individual growth. Method 3 only suggest an opposite effect of niche on individual growth for *Symphonia* species (in the sense of TWI, see previous document).
