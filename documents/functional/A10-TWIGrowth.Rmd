---
title: "A09 : TWI and growth"
date: '`r Sys.Date()`'
author: Sylvain Schmitt
output:
  bookdown::html_document2:
    number_sections: no
    toc: true
    toc_float: yes
    theme: flatly
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
  bookdown::word_document2: default
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "../../data/Paracou/"
```

```{r data, eval=T}
# traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>%
#   mutate(Genus = "Symphonia") %>%
#   rename(Species = Morphotype) %>%
#   mutate(Species = ifelse(Species == "Indet.",
#                           c("globulifera", "sp.1", "sp.1")[fct_recode(Bark, "globulifera" = "G",
#                                      "sp.1" =  "S")], Species))
# traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   filter(!(Plot == 14 & SubPlot == 1 & TreeFieldNum == 760)) %>%  # outlier
#   filter(!(Species %in% c("congestiflora","simiorum","persistens")))
# traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>%
#   mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>%
#   group_by(idTree, Plot, SubPlot, TreeFieldNum, Genus, Species,
#            SpeciesLong, Bark, Dawkins) %>%
#   summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC",
#                     "brBT", "brBD", "brWD"), mean, na.rm = T) %>%
#   ungroup() %>%
#   mutate(invSLA=1/SLA) %>%
#   mutate(invLA=1/LA)
# load("./functional_save/env.Rdata")
# Individuals <-  left_join(traits, env, by = "idTree", suffix = c("", ".y"))
# rm(traitsEschweilera, traitsSymphonia, traits, paracou, env)
# save(Individuals, file = "./functional_save/Individuals.Rdata")
load("./functional_save/Individuals.Rdata")
Individuals <- Individuals %>% 
  group_by(Species) %>% 
  filter(n() > 20) %>% 
  ungroup() %>% 
  mutate_at(vars("TWI"), funs(./sd(., na.rm = T)))
```

# Introduction

The aim of this analysis is to quickly explore the potential role of TWI in tree growth. For that we used three different methods:

1. We fitted a growth potential $AGRmax_{ind}$ for every individual that we tried to explain by TWI (**Individual growth paragraph**)
1. We computed a vigor index for every individual based on the difference between species mean predicted growth and individual observed growth (**Individual vigor paragraph**)
1. We integrated TWI in the growth model as a new reductor (**Traits in model paragraph**)

# Individual growth

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{individual}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
We obtained reasonable predicitons for individual growth (Fig. \@ref(fig:predicitonIndividualGrowth)), besides due to different sampling depth between individuals the model can be really uncertain for lot of individuals. Globally TWI was not related to individual growth (Fig. \@ref(fig:TWIRelationIndividualGrowth) and Tab. \@ref(tab:TWILmIndividualGrowth)).

```{stan modelIndividual, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
  int<lower=1> I ; // Nb of individuals
  int<lower=0> ind[N] ; // individual vector
  int<lower=0> indsp[I] ; // individual in species vector
}
parameters {
  vector<lower=0.1,upper=10>[I] AGRmaxind ; // individual potential growth
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=10>[S] sigmaInd ; // individual potential growth deviation
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  AGRmaxind ~ normal(AGRmax[indsp], sigmaInd[indsp]) ;
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fits}
data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species)),
#                             I = length(unique(data$idTree)),
#                             ind = as.numeric(as.factor(data$idTree)),
#                             indsp = data %>%
#                               select(Species, idTree) %>%
#                               mutate_all(as.factor) %>%
#                               mutate_all(as.numeric) %>%
#                               arrange(idTree) %>%
#                               unique() %>%
#                               select(Species) %>%
#                               unlist()
#                 ))
# save(fit, file = "./functional_save/growth.Rdata")
load("./functional_save/growth.Rdata")
```

```{r predicitonIndividualGrowth, fig.cap="Model predictions for individual growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1))) + 
  geom_line(aes(y = AGRpred))
```

```{r TWIRelationIndividualGrowth, fig.cap="Individual growth - TWI relation."}
data %>% 
  mutate(AGRmaxind = apply(as.matrix(fit, pars = "AGRmaxind"), 2, mean)[as.numeric(as.factor(data$idTree))]) %>% 
  left_join(Individuals) %>% 
  select(Genus, Species, idTree, AGRmaxind, TWI) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  ggplot(aes(TWI, AGRmaxind, col = Species)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r TWILmIndividualGrowth}
data %>% 
  mutate(AGRmaxind = apply(as.matrix(fit, pars = "AGRmaxind"), 2, mean)[as.numeric(as.factor(data$idTree))]) %>% 
  left_join(Individuals) %>% 
  select(Genus, Species, idTree, AGRmaxind, TWI) %>% 
  unique() %>% 
  filter(!is.na(TWI)) %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(AGRmaxind ~ TWI, data = .)) %>% 
  broom::tidy(lm) %>% 
  filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model AGRmaxind ~ TWI for every species.")
```

# Individual vigor

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
And computed the following vigor index:
$$Vigor_{individual}=\frac{\int _{t0_{individual}} ^{tend_{individual}} AGRobserved_{individual}}{\int _{t0_{individual}} ^{tend_{individual}} AGRpredicted_{individual}}$$
We obtained reasonable predicitons for species growth (Fig. \@ref(fig:predicitonVigor)). Globally TWI was not related to individual vigor (Fig. \@ref(fig:TWIRelationVigor) and Tab. \@ref(tab:TWILmVigor)).

```{stan modelSp, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fitSp}
data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthsp.Rdata")
load("./functional_save/growthsp.Rdata")
```

```{r predicitonVigor, fig.cap="Model predictions for species growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1)), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r TWIRelationVigor, fig.cap="Individual vigor - TWI relation."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  group_by(idTree) %>% 
  summarise(Vigor = (sum(agr)-sum(AGRpred))/n()) %>% 
  left_join(Individuals) %>% 
  select(Genus, Species, idTree, Vigor, TWI) %>% 
  filter(!is.na(TWI)) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  ggplot(aes(TWI, Vigor, col = SpeciesLong)) +
  geom_point() +
  geom_smooth(method = "lm")
```

```{r TWILmVigor}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  group_by(idTree) %>% 
  summarise(Vigor = (sum(agr)-sum(AGRpred))/n()) %>% 
  left_join(Individuals) %>% 
  select(Genus, Species, idTree, Vigor, TWI) %>% 
  filter(!is.na(TWI)) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(Vigor ~ TWI, data = .)) %>% 
  broom::tidy(lm) %>% 
  filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model Vigor ~ TWI for every species.")
```

# TWI in model

We used the following model adapted from @Herault2011:
$$log(AGR+1) \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh}{Dopt_{species}})}{Ks_{species}}]^2}.e^{-\beta_{TWI}.TWI}, \sigma)$$
We obtained reasonable predicitons for species growth (Fig. \@ref(fig:predicitonTraits)). Globally TWI did not seem to have an effect on individual growth, except for *S. globulifera* (Fig. \@ref(fig:TWIPosteriors)).

```{stan modelTWI, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  vector[N] twi ; 
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1>[S] AGRmax ; // species potential growth
  vector[S] TWI ; 
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-TWI[sp[n]]*twi[n]), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-TWI[sp[n]]*twi[n]) ;
}
```

```{r fitTWI}
data <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  left_join(Individuals) %>% 
  ungroup() %>% 
  select(idTree, Genus, agr, dbh, TWI, Species) %>% 
  mutate_at(vars("TWI"), scale) %>% 
  mutate_at(vars("TWI"), as.vector) %>% 
  na.omit()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             twi = data$TWI,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthTWI.Rdata")
load("./functional_save/growthTWI.Rdata")
```

```{r predicitonTraits, fig.cap="Model predictions for TWI growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = Species, group = idTree)) + 
  geom_point(aes(y = log(agr+1)), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r TWIPosteriors, fig.cap="Model posteriors for TWI effect on growth."}
bayesplot::mcmc_areas(as.array(fit, pars = c("TWI")))
```

# Conclusion

This was a rapide test. But at the exception of *Symphonia* species in method 3, all methods seem to indicant no link between TWI and individual growth. Method 3 only suggest a positive effect of TWI on individual growth for *Symphonia* species.

# References
