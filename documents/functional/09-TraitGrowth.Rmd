```{r setupTraitsnGrowth, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(rstan)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "../../data/Paracou/"
```

```{r dataTraitsnGrowth, eval=T}
# traitsSymphonia <- googlesheets::gs_title("Measures_Symphonia") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   mutate(SLA = as.numeric(SLA), LDMC = as.numeric(LDMC)) %>%
#   mutate(Genus = "Symphonia") %>%
#   rename(Species = Morphotype) %>%
#   mutate(Species = ifelse(Species == "Indet.",
#                           c("globulifera", "sp.1", "sp.1")[fct_recode(Bark, "globulifera" = "G",
#                                      "sp.1" =  "S")], Species))
# traitsEschweilera <- googlesheets::gs_title("Measures_Eschweilera") %>%
#   googlesheets::gs_read("AllTraits") %>%
#   filter(!(Plot == 14 & SubPlot == 1 & TreeFieldNum == 760)) %>%  # outlier
#   filter(!(Species %in% c("congestiflora","simiorum","persistens")))
# traits <- bind_rows(traitsEschweilera, traitsSymphonia) %>%
#   mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>%
#   group_by(idTree, Plot, SubPlot, TreeFieldNum, Genus, Species,
#            SpeciesLong, Bark, Dawkins) %>%
#   summarise_at(vars("SLA", "LDMC", "LT", "LA", "CC",
#                     "brBT", "brBD", "brWD"), mean, na.rm = T) %>%
#   ungroup() %>%
#   mutate(invSLA=1/SLA) %>%
#   mutate(invLA=1/LA)
# load("./functional_save/env.Rdata")
# Individuals <-  left_join(traits, env, by = "idTree", suffix = c("", ".y"))
# rm(traitsEschweilera, traitsSymphonia, traits, paracou, env)
# save(Individuals, file = "./functional_save/Individuals.Rdata")
load("./functional_save/Individuals.Rdata")
load("./functional_save/CompetitionMatrix.Rdata")
sdDBH <- sd(Individuals$DBH)
Individuals <- Individuals %>% 
  rename(LMA = invSLA) %>% 
  group_by(Species) %>% 
  filter(n() > 20) %>% 
  ungroup() %>% 
  left_join(Competition %>% 
              group_by(idTree) %>% 
              summarise(NCI = (1/mean(1-AreaOutside20))*sum(DBHj^2*exp(-0.25*dij)))) %>%
  mutate(NCI = log(NCI)) %>% 
  mutate_at(vars("LMA", "LDMC", "LT", "invLA", "CC", "DBH", "TWI", "NCI"),
            funs(./sd(., na.rm = T)))
```

# Traits and growth

> Changes following Geraldine remark about the temporality of functional traits value, *i.e.* the value we observe is valid only for 2015 as traits evolve with DBH.

The aim of this analysis is to quickly explore the potential role of individual leaf functional traits in tree growth. For that we used three different methods:

1. We fitted a growth potential $AGRmax_{ind}$ for every individual that we tried to explain AGR predicted in 2015 by each functional trait (**Individual growth paragraph**)
1. We computed a vigor index for every individual based on the difference between species mean predicted growth and individual observed growth in 2015 (**Individual vigor paragraph**)
1. We integrated traits in the growth model as a new reductor of 2015 individual annual growth rate (**Traits in model paragraph**)

## Individual growth

We used the following model adapted from @Herault2011:
$$log[AGR(t)+1] \sim \mathcal{N}(AGRmax_{individual}.e^{-\frac12 .[\frac{log(\frac{dbh(t)}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
We obtained reasonable predicitons for individual growth (\@ref(fig:predicitonIndividualGrowth)), besides due to different sampling depth between individuals the model can be really uncertain for lot of individuals. Globally traits did not seem to be related to individual growth in 2015, except for a weak and significative negative effect of SLA on *E. sagotiana* individual growth and a weak and significative positive effect of LA  on *E. sagotiana* and  *S. sp.1* individual growth (\@ref(fig:traitRelationIndividualGrowth) and \@ref(tab:traitLmIndividualGrowth)).

```{stan modelIndividualGrowth, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
  int<lower=1> I ; // Nb of individuals
  int<lower=0> ind[N] ; // individual vector
  int<lower=0> indsp[I] ; // individual in species vector
}
parameters {
  vector<lower=0.1,upper=10>[I] AGRmaxind ; // individual potential growth
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=10>[S] sigmaInd ; // individual potential growth deviation
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  AGRmaxind ~ normal(AGRmax[indsp], sigmaInd[indsp]) ;
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmaxind[ind[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fitIndividualGrowth}
data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species)),
#                             I = length(unique(data$idTree)),
#                             ind = as.numeric(as.factor(data$idTree)),
#                             indsp = data %>%
#                               dplyr::select(Species, idTree) %>%
#                               mutate_all(as.factor) %>%
#                               mutate_all(as.numeric) %>%
#                               arrange(idTree) %>%
#                               unique() %>%
#                               dplyr::select(Species) %>%
#                               unlist()
#                 ))
# save(fit, file = "./functional_save/growth.Rdata")
load("./functional_save/growth.Rdata")
```

```{r predicitonIndividualGrowth, fig.cap="Model predictions for individual growth with predicted growth in 2015 in black."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1))) + 
  geom_line(aes(y = AGRpred)) +
  geom_point(aes(y = AGRpred, alpha = CensusYear == 2015), col = "black")
```

```{r traitRelationIndividualGrowth, fig.cap="Individual growth redicted in 2015 - trait relation."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  filter(CensusYear == 2015) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, AGRpred, SLA, LDMC, LT, LA, CC) %>% 
  filter(!is.na(SLA)) %>% 
  unique() %>% 
  reshape2::melt(id.vars = c("Genus", "Species", "idTree", "AGRpred"),
                 variable.name = "Trait") %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  ggplot(aes(value, AGRpred)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(SpeciesLong ~ Trait, scales = "free")
```

```{r traitLmIndividualGrowth}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  filter(CensusYear == 2015) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, AGRpred, SLA, LDMC, LT, LA, CC) %>% 
  filter(!is.na(SLA)) %>% 
  unique() %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(AGRpred ~ SLA + LDMC + LT + LA + CC, data = .)) %>% 
  broom::tidy(lm) %>%
    filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model AGRpred ~ SLA + LDMC + LT + LA + CC for every species in 2015.")
```

## Individual vigor

We used the following model adapted from @Herault2011:
$$log[AGR(t)+1] \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh(t)}{Dopt_{species}})}{Ks_{species}}]^2}, \sigma)$$
And computed the following vigor index:
$$Vigor_{individual}=\frac{AGRobserved_{individual}(t=2015)}{AGRpredicted_{individual}(t=2015)}$$
We obtained reasonable predicitons for species growth (\@ref(fig:predicitonVigor)). Globally traits did not seem to be related to individual vigor, except for a weak and significative negative effect of LDMC on *E. decolorans* individual vigor and a weak and significative positive effect of LA  on *S. sp1* individual vigor (\@ref(fig:traitRelationVigor) and \@ref(tab:traitLmVigor)).

```{stan modelVigor, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2)) ;
}
```

```{r fitVigor}
  data <-  src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
    tbl("Paracou") %>%
    filter(idTree %in% local(Individuals$idTree)) %>%
    mutate(dbh = CircCorr/pi) %>% 
    group_by(idTree) %>% 
    arrange(idTree, CensusYear) %>% 
    collect() %>% 
    mutate(ddbh = dbh - lag(dbh), 
           dt = CensusYear - lag(CensusYear)) %>% 
    filter(ddbh > 0) %>% 
    mutate(agr = ddbh/dt) %>% 
    ungroup()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthsp.Rdata")
load("./functional_save/growthsp.Rdata")
```

```{r predicitonVigor, fig.cap="Model predictions for species growth."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = SpeciesLong, group = idTree)) + 
  geom_point(aes(y = log(agr+1)), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r traitRelationVigor, fig.cap="Individual vigor in 2015 - trait relation."}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  filter(CensusYear == 2015) %>% 
  mutate(Vigor = agr-AGRpred) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, idTree, Vigor, SLA, LDMC, LT, LA, CC) %>% 
  filter(!is.na(SLA)) %>% 
  unique() %>% 
  reshape2::melt(id.vars = c("Genus", "Species", "idTree", "Vigor"),
                 variable.name = "Trait") %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  ggplot(aes(value, Vigor)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(SpeciesLong ~ Trait, scales = "free")
```

```{r traitLmVigor}
data %>% 
  mutate(SpeciesLong = paste(substr(Genus, 1, 1), Species)) %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>%
  filter(CensusYear == 2015) %>% 
  mutate(Vigor = agr-AGRpred) %>% 
  left_join(Individuals) %>% 
  dplyr::select(Genus, Species, SpeciesLong, idTree, Vigor, SLA, LDMC, LT, LA, CC) %>% 
  filter(!is.na(SLA)) %>% 
  unique() %>% 
  group_by(SpeciesLong) %>% 
  do(lm = lm(Vigor ~ SLA + LDMC + LT + LA + CC, data = .)) %>% 
  broom::tidy(lm) %>% 
  filter(p.value < 0.05) %>% 
  kable(digits = 3, caption = "Significative coefficients for the model Vigor ~ SLA + LDMC + LT + LA + CC for every species in 2015.")
```

## Traits in model

We used the following model adapted from @Herault2011:
$$log[AGR(t)+1] \sim \mathcal{N}(AGRmax_{species}.e^{-\frac12 .[\frac{log(\frac{dbh(t)}{Dopt_{species}})}{Ks_{species}}]^2}.e^{-\beta_{Trait}.Trait}, \sigma)$$
We first made a test with one trait, SLA. We obtained reasonable predicitons for species growth (Fig. \@ref(fig:predicitonTraits)). Globally SLA had a very weak and not significant negative effect on individual growth (Fig. \@ref(fig:traitsPosteriors)).

```{stan modelTraits, output.var="Model", echo=F, eval=F, cache=F}
data {
  int<lower=1> N ; // Nb of observations
  vector<lower=0>[N] AGR ; // growth vector
  vector<lower=0>[N] dbh ; // dbh vector
  vector[N] SLA ; 
  vector[N] LDMC ;
  vector[N] LT ; 
  vector[N] LA ; 
  vector[N] CC ;
  int<lower=1> S ; // Nb of species
  int<lower=0> sp[N] ; // species vector
}
parameters {
  vector<lower=0.1,upper=10>[S] AGRmax ; // species potential growth
  vector<lower=0,upper=200>[S] Dopt ; // optimal diameter
  vector<lower=0.1,upper=10>[S] Ks ; // kurtosis
  vector[S] betaSLA ; 
//  vector[S] betaLDMC ; 
//  vector[S] betaLT ; 
//  vector[S] betaLA ; 
//  vector[S] betaCC ; 
  real<lower=0,upper=10> sigma ;
}
model {
  for(n in 1:N)
    log(AGR[n]+1) ~ normal(AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-betaSLA[sp[n]]*SLA[n]), sigma) ;
}
generated quantities {
  vector<lower=0>[N] AGRpred ;
  for(n in 1:N)
    AGRpred[n] = AGRmax[sp[n]]*exp(-0.5*pow(log(dbh[n]/Dopt[sp[n]])/Ks[sp[n]], 2))*exp(-betaSLA[sp[n]]*SLA[n]) ;
}
```

```{r fitTraits}
data <- src_sqlite(file.path(path, "trees", "Paracou.sqlite")) %>%
  tbl("Paracou") %>%
  filter(idTree %in% local(Individuals$idTree)) %>%
  mutate(dbh = CircCorr/pi) %>% 
  group_by(idTree) %>% 
  arrange(idTree, CensusYear) %>% 
  collect() %>% 
  mutate(ddbh = dbh - lag(dbh), 
         dt = CensusYear - lag(CensusYear)) %>% 
  filter(ddbh > 0) %>% 
  mutate(agr = ddbh/dt) %>% 
  filter(CensusYear == 2015) %>%
  left_join(mutate_at(Individuals, vars("SLA", "LDMC", "LT", "LA", "CC"), funs(as.vector(base::scale(., center = F))))) %>% 
  dplyr::select(agr, dbh, SLA, LDMC, LT, LA, CC, Species) %>% 
  na.omit()
# fit <- sampling(Model, chains = 2, save_warmup = F,
#                 data = list(N = nrow(data),
#                             AGR = data$agr,
#                             dbh = data$dbh,
#                             SLA = data$SLA,
#                             LDMC = data$LDMC,
#                             LT = data$LT,
#                             LA = data$LA,
#                             CC = data$CC,
#                             S = length(unique(data$Species)),
#                             sp = as.numeric(as.factor(data$Species))
#                 ))
# save(fit, file = "./functional_save/growthTraits.Rdata")
load("./functional_save/growthTraits.Rdata") 
```

```{r predicitonTraits, fig.cap="Model predictions for traits growth."}
data %>% 
  ungroup() %>% 
  mutate(AGRpred = apply(as.matrix(fit, pars = "AGRpred"), 2, mean)) %>% 
  ggplot(aes(x = dbh, col = Species)) + 
  geom_point(aes(y = log(agr+1), size = SLA), alpha = 0.1) + 
  geom_line(aes(y = AGRpred))
```

```{r traitsPosteriors, fig.cap="Model posteriors for traits effect on growth."}
bayesplot::mcmc_areas(as.array(fit, pars = c("betaSLA")))
```

## Conclusion

This was a rapide test. But as a first conclusion whereas methods 1 and 2 (individual growth and individual vigor) did not seem to indicate significant effect of traits on individual growth, including SLA as a reductor in the growth model question about an eventual negative effect of increased acquisition through increased SLA in individual growth in 2015, besides it seems globally null. We may test other traits in future analysis.
