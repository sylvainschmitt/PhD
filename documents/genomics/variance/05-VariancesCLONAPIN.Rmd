```{r setupVarCLONAPIN, include = FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(rstan)
library(bayesplot)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = F, cache.lazy = F, eval = F)
path <- "../../../data/CLONAPIN/"
```

```{r mdataClonapinVariance}
trees <- readRDS(file.path(path, "all_data_pheno-clim-soil_07042019.RDS")) %>% 
  left_join(read_csv(file.path(path, "coordinates_provenances.csv")), by = c("prov" = "CODE")) %>% 
  filter(!is.na(height), !is.na(max.Q)) %>% 
  filter(site == "portugal") %>% 
  dplyr::select(block, prov, clon, tree, height, 
                age, bio5_prov, bio14_prov, Q1, Q2, Q3, Q4, Q5, Q6) %>% 
  rename(provenance = prov, clone = clon, individual = tree, bio5 = bio5_prov,
         bio14 = bio14_prov) %>% 
  na.omit() %>% 
  filter(block %in% unique(block)[1:4], provenance %in% unique(provenance)[1:4]) %>% 
  mutate_at(c("age", "bio5", "bio14"), scale, center = F) %>% 
  mutate_at(c("age", "bio5", "bio14"), as.vector) %>% 
  mutate(blockNum = as.numeric(as.factor(block)), 
         provenanceNum = as.numeric(as.factor(provenance)),
         cloneNum = as.numeric(as.factor(clone)), 
         individualNum = as.numeric(as.factor(individual)))
K <- read_tsv(file.path(path, "plink2.king"),
         col_names = read_tsv(file.path(path, "plink2.king.id"))$IID) %>% 
  as.data.frame()
row.names(K) <- read_tsv(file.path(path, "plink2.king.id"))$IID
K <- as.matrix(K)
K <- K[unique(trees$clone),unique(trees$clone)]
K[K < 0] <- 0
K <- K*2
K0 <- K
K <- as.matrix(Matrix::nearPD(K)$mat)
mdata <- list(
  B = max(trees$blockNum),
  P = max(trees$provenanceNum),
  G = 6,
  C = max(trees$cloneNum),
  I = max(trees$individualNum),
  N = nrow(trees),
  height = trees$height,
  age = trees$age,
  bio5 = trees$bio5,
  bio14 = trees$bio14,
  bloc = trees$blockNum,
  provenance = trees$provenanceNum,
  clone = trees$cloneNum,
  individual = trees$individualNum,
  Q = as.matrix(dplyr::select(trees, Q1, Q2, Q3, Q4, Q5, Q6)),
  K = K
)
```

# Variances CLONAPIN

**Dirty quick tests !**

We explored the geneotypic variance (with kinship matrix $K$) with different methods. We combined for each height measurement of block $b$, from provenance $p$ and clone $c$ for individual $i$ at age $a$: (i) the individual age $Age_{i,a}$, the provenance environmnetal variables $BIO4_p$ and $BIO15_p$, the genetic populations with matrix $Q$, and the genotype kinship with matrix $K$. Tests were done with 4 blocks and 4 provenances resulting in 664 measures of height.

## BLUPS-like & Normal Animal

$$log(h_{b,p,g,c,i,a}) \sim \mathcal N (\mu + \epsilon_b.\sigma_2  + \epsilon_p.\sigma_3 \\+ \beta1.Age_{i,a} + \beta2.Age_{i,a}^2 + \beta3.Bio4_p + \beta4.Bio15_p+Q.\gamma_G, \sigma_1) \\  (\mu,\epsilon_b,\epsilon_p,\beta1,\beta2,\beta3,\beta4,\gamma_G) \sim \mathcal N^{7+G}(0,1) \\ (\sigma_1,\sigma_2,\sigma_3) \sim \mathcal C^2(0,1)$$

```{r BLUPSnorm}
# Bnorm <- stan_model("variance_models/varianceClonapin/BLUPSnormal.stan")
# fitBnorm <- sampling(Bnorm, chains = 2, data = mdata, save_warmup = F,
#                          include = F, par = c("epsilon_b", "epsilon_p"),
#                          control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(fitBnorm, file = "variance_save/fitBnorm.Rdata")
load("variance_save/fitBnorm.Rdata")
broom::tidyMCMC(fitBnorm, ess = T, rhat = T,
                pars = c("mu", "beta", "gamma", "sigma", "lp__"),
                estimate.method = "median", droppars = F)
mcmc_trace(fitBnorm, regex_pars = c("mu", "beta", "gamma", "sigma"))
mcmc_intervals(fitBnorm, regex_pars = c("mu", "beta", "gamma", "sigma"))
```

$$log(h_{b,p,g,c,i,a})-\hat{log(h_{b,p,g,c,i,a})} \sim \mathcal N(\sigma_2.A.a_c, \sigma_1) \\ a_c \sim \mathcal N(0,1) \\ (\sigma_1,\sigma_2) \sim \mathcal C^{2}(0,1)$$

```{r Anorm}
mdata2 <- list(
  C = mdata$C,
  N = mdata$N,
  height = mdata$height,
  yp = as.vector(apply(as.array(fitBnorm, "yp"), 3, median)),
  clone = mdata$clone,
  K = mdata$K
)
# Anorm <- stan_model("variance_models/varianceClonapin/AnimalNormal.stan")
# fitAnorm <- sampling(Anorm, chains = 2, data = mdata2, save_warmup = F,
#                          include = F, par = c("epsilon_b", "epsilon_p", "a"),
#                          control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(fitAnorm, file = "variance_save/fitAnorm.Rdata")
load("variance_save/fitAnorm.Rdata")
broom::tidyMCMC(fitAnorm, ess = T, rhat = T, 
                estimate.method = "median", droppars = F)
mcmc_trace(fitAnorm)
mcmc_intervals(fitAnorm, regex_pars = c("sigma", "V"))
```

## Full Normal

$$log(h_{B,P,G,C,I,A}) \sim \mathcal N (\mu + \epsilon_B.\sigma_2  + \epsilon_P.\sigma_3 \\+ \beta1.Age_{I.A} + \beta2.Age_{I.A}^2 + \beta3.Bio4_P + \beta4.Bio15_P+Q.\gamma_G+\sigma_4.A.a_C, \sigma_1) \\  (\mu,\epsilon_B,\epsilon_P,\beta1,\beta2,\beta3,\beta4,\gamma_G, a_C) \sim \mathcal N^{7+G}(0,1) \\ (\sigma_1,\sigma_2,\sigma_3,\sigma_4) \sim \mathcal C^2(0,1) \\ log(h_{b,p,g,c,i,a})-log(\hat{h_{b,p,g,c,i,a}}) \sim \mathcal N(\sigma_2.A.a_c, \sigma_1) \\  \sim \mathcal N(0,1) \\ (,\sigma_2) \sim \mathcal C^{2}(0,1)$$

```{r Fnorm}
# Fnorm <- stan_model("variance_models/varianceClonapin/FullNormal.stan")
# fitFnorm <- sampling(Fnorm, chains = 2, data = mdata, save_warmup = F,
#                          include = F, par = c("epsilon_b", "epsilon_p"),
#                          control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(fitFnorm, file = "variance_save/fitFnorm.Rdata")
load("variance_save/fitFnorm.Rdata")
broom::tidyMCMC(fitFnorm, ess = T, rhat = T, 
                estimate.method = "median", droppars = F)
mcmc_trace(fitFnorm)
mcmc_intervals(fitFnorm, regex_pars = c("mu", "beta", "gamma", "sigma", "V"))
```

## BLUPS-like & Lognormal Animal

$$h_{b,p,g,c,i,a} \sim \mathcal {logN} (log(\mu + \epsilon_b.\sigma_2  + \epsilon_p.\sigma_3 \\+ \beta1.Age_{i,a} + \beta2.Age_{i,a}^2 + \beta3.Bio4_p + \beta4.Bio15_p+Q.\gamma_G), \sigma_1) \\ (\mu,\epsilon_b,\epsilon_p,\beta1,\beta2,\beta3,\beta4,\gamma_G) \sim \mathcal N^{7+G}(0,1) \\ (\sigma_1,\sigma_2,\sigma_3) \sim \mathcal C^2(0,1)$$

```{r BLUPSlnorm}
Blnorm <- stan_model("variance_models/varianceClonapin/BLUPSlognormal.stan")
fitBlnorm <- sampling(Blnorm, chains = 2, data = mdata, save_warmup = F,
                         include = F, par = c("epsilon_b", "epsilon_p"),
                         control = list(adapt_delta = 0.99, max_treedepth = 12))
save(fitBlnorm, file = "variance_save/fitBnorm.Rdata")
load("variance_save/fitBnorm.Rdata")
broom::tidyMCMC(fitBlnorm, ess = T, rhat = T,
                pars = c("mu", "beta", "gamma", "sigma", "lp__"),
                estimate.method = "median", droppars = F)
mcmc_trace(fitBlnorm, regex_pars = c("mu", "beta", "gamma", "sigma"))
mcmc_intervals(fitBlnorm, regex_pars = c("mu", "beta", "gamma", "sigma"))
```

$$h_{b,p,g,c,i,a}-\hat{h_{b,p,g,c,i,a}} \sim \mathcal {logN}(log(A.e^{log(mu) + \sigma_2.a_c}), \sigma_1) \\ a_c \sim \mathcal N(0,1) \\ (\sigma_1,\sigma_2) \sim \mathcal C^{2}(0,1)$$

```{r Alnorm}
mdata2 <- list(
  C = mdata$C,
  N = mdata$N,
  height = mdata$height,
  yp = as.vector(apply(as.array(fitBnorm, "yp"), 3, median)),
  clone = mdata$clone,
  K = mdata$K
)
# Anorm <- stan_model("variance_models/varianceClonapin/AnimalNormal.stan")
# fitAnorm <- sampling(Anorm, chains = 2, data = mdata2, save_warmup = F,
#                          include = F, par = c("epsilon_b", "epsilon_p", "a"),
#                          control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(fitAnorm, file = "variance_save/fitAlnorm.Rdata")
load("variance_save/fitAlnorm.Rdata")
broom::tidyMCMC(fitAnorm, ess = T, rhat = T, 
                estimate.method = "median", droppars = F)
mcmc_trace(fitAnorm)
mcmc_intervals(fitAnorm, regex_pars = c("sigma", "V"))
```


## Full Lognormal

## Comparisons

```{r comparisonsClonapin}
lapply(list(fitAnorm, fitFnorm),
       mcmc_intervals_data, pars = c("Vg", "Vr")) %>% 
  bind_rows(.id = "model") %>% 
  mutate(model = recode_factor(model, 
                               "1" = "BLUPs & Animal Normal", 
                               "2" = "Full normal")) %>% 
  mutate(parameter = recode_factor(parameter, 
                               "Vg" = "Genetic", 
                               "Vr" = "Residual")) %>% 
  ggplot(aes(x = model, xend = model,
             color = model, fill = model)) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  coord_flip() +
  xaxis_title(F) + 
  ylab("Variance") +
  scale_color_discrete(guide = "none") +
  scale_fill_discrete(guide = "none") +
  facet_wrap(~ parameter, scales = "free_x")
```

