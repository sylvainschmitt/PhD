---
title: Topography drives microgeographic adaptations among closely-related species of two tropical tree species complexes
date: 'New Phytologist version `r Sys.Date()` '
output:
  bookdown::word_document2:
    reference_docx: ./template/template.docx
  bookdown::pdf_document2:
    includes:
      before_body: ./template/doc_prefix.tex
      in_header: ./template/preamble.tex
    number_sections: false
    toc: false
  bookdown::html_document2:
    number_sections: false  
    toc: true
    toc_float: yes
linestretch: 1.5
csl: /home/sylvain/Documents/Bibliography/csl/newphyto.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

Sylvain Schmitt$^1$, 
Niklas Tysklind$^2$, 
Bruno Hérault$^{3,4,5}$
Myriam Heuertz$^1$

*$^1$ Univ. Bordeaux, INRAE, BIOGECO, 69 route d’Arcachon, 33610 Cestas France;* 
*$^2$ INRAE, UMR EcoFoG (Agroparistech, CNRS, Cirad, Université des Antilles, Université de la Guyane), Campus Agronomique, 97310 Kourou, French Guiana;*
*$^3$ CIRAD, UPR Forêts et Sociétés, Yamoussoukro, Côte d'Ivoire;*
*$^4$ Forêts et Sociétés, Univ Montpellier, CIRAD, Montpellier, France;*
*$^5$ Institut National Polytechnique Félix Houphouët-Boigny, INP-HB, Yamoussoukro, Côte d'Ivoire;*

* **Corresponding author**: Sylvain Schmitt, +33 6 49 19 32 63, sylvain.m.schmitt@gmail.com
* **Word count**:
    * Main body: 5223
    * Introduction: 1132
    * Material and Methods: 2446
    * Results: 588
    * Discussion: 1057
* **Figures**: 5 (all in colour)
* **Tables**: 0
* **Supporting information**: 1 file

\newpage 

# Summary

<!-- _**200 words.maximum**_ -->

* Despite the local and regional abundance of closely-related tree species growing in sympatry in Neotropical rainforests, little is known of the eco-evolutionary forces that allow their local coexistence. Here, we assessed genetic species delimitation and genotypic diversity of closely-related sympatric species belonging to two Neotropical tree species complexes, and addressed their fine-scale spatial adaptation along a topographic gradient with associated edaphic and hydrologic features.
* Combining tree inventories, LiDAR-derived topographic data, and single nucleotide polymorphisms (SNPs) from gene capture experiments, we used population genomics, environmental association analyses and genome wide association studies to explore microgeographic adaptations to topography for 663 individuals belonging to six species within two species complexes (genus *Symphonia*, Clusiaceae, and genus *Eschweilera*, Lecythidaceae) of Neotropical forest trees.
* Within species complexes, closely-related tree species had different realized optima for topographic niches defined through the topographic wetness index or the relative elevation, and species displayed genetic signatures of adaptations. *Symphonia* species were differentially adapted to water and nutrient distribution, whereas *Eschweilera* species were differentially adapted to soil chemistry due to hydromorphy.
* Our results thus suggest that species adaptations to different characteristics of topography stabilize local coexistence between closely-related species within tree species complexes.

## Keywords

ecological niche; Paracou; relative elevation; syngameon; topographic wetness index; tropical forests

# Introduction 

The tremendous biodiversity of tropical forests [@Gaston2000] has intrigued biologists for decades [@connell_diversity_1978].
Lowland Amazonia alone is estimated to shelter around sixteen thousand tree species [@TerSteege2013]. 
But the five thousand species of trees botanically described in Amazonia belong to only height hundred ten genera [@TerSteege2013],
many of which are thus species-rich.
Even at the hectare-scale, tropical forests shelter up to several hundred tree species [@Gentry1988], 
including species-rich genera with closely-related species growing in sympatry [@Caron2019]. 
Closely-related species are expected to share similar niche and functional strategies due to phylogenetic constraints [@Wiens2010].
These niche and functional similarities are expected to lead to increased competition between closely-related tree species and ultimately to local competitive exclusion of one species by the other [but see competitive combining, @Aarssen1983].
The coexistence in sympatry of closely related tree species represents thus an intriguing paradox. 
Despite the local and regional abundance of closely-related tree species growing in sympatry in the Neotropics [@Gentry1988; @TerSteege2013; @Pinheiro2018],
little is known of the eco-evolutionary forces that allow their local coexistence.

Genetic studies have shown that species in species-rich genera have a higher level of genetic polymorphism [@Caron2019] 
and hybridize more often between congeners [@Whitney2010] than those in species-poor genera. 
Species-rich genera thus frequently contain species complexes, defined as clades of morphologically similar species and/or species sharing large amounts of genetic variation due to recent common ancestry and/or hybridization [@Pernes1984].
Species-rich genera also frequently contain syngameons, defined as species connected by limited, but recurrent, interspecific gene flow [@Suarez-Gonzalez2018].
Syngameons are evolving at two contrasting taxonomic levels, they maximize each species adaptation to its ecological niche, and they evolve at the syngameon level which benefits all the constituent species. 
The syngameon is thus unlikely to just represent a transitional stage before complete speciation; 
instead it probably represents a successful evolutionary strategy that decreases the overall risk of syngameon extinction, 
while allowing distinct ecological adaptations of its constituent species [@Cannon2015b; @Cannon2019a]. 
With regard to local species coexistence, species complexes or syngeamons are especially susceptible to phylogenetic constraints due to their low level of genetic differentiation. 
However against theoretical expectation, species complexes and syngameons frequently include sympatric species coexisting at local scales [@Caron2019; @Gonzalez2009; Schmitt et al., in prep].

To address the paradox of local species coexistence in sympatry despite similar expected niches,
niche theory evokes ecological niche differences that limit competitive exclusion [@lortie_rethinking_2004-1; @weiher_assembly_1995].
The heterogeneity of resource distribution in space and time defines fine-scale habitat structure where species can coexist.
In tropical forests, topography explains the fine scale spatial distribution of water and nutrient availability,
showing a strong association with soil nitrogen, carbon and phosphorus content [@ferry2010higher].
Topography  has been shown to explain pervasive differentiation in habitat preference among species [@gunatilleke_specieshabitat_2006; @Engelbrecht2007; @kraft_functional_2008; @Allie2015]. 
In particular, soil nutrients, also influenced by topography through hydromorphy, directly shape the spatial distribution of forest tree species [@Levins1971].
Topography has also been shown to drive functional responses among and within species [@Schmitt2020].
Topography, for example measured  through the topographic wetness index [@Schmitt2020] or relative elevation [@Allie2015], 
is thus a proxy of numerous habitat features related to nutrient and water availability.
Therefore, topography is a good candidate factor that may explain the coexistence of closely-related species in Neotropical tree species complexes [Schmitt et al., in prep].

Closely-related species growing in sympatry in differentiated ecological niches are frequently the product of an adaptive radiation [@Seehausen2004], such as Darwin’s finches in the Galapagos [@Grant2019]. 
Evolutionary history behind adaptive radiations falls within a continuum from sympatric ecological speciation to secondary contacts of species ecologically specialised in allopatry or parapatry [@rundell_adaptive_2009].
In particular, species complexes can result from adaptive radiations and species segregation along environmental gradients.
Species complexes may combine and reshuffle genetic features among species in hybrid swarms [@Seehausen2004; @Grant2019], 
thus multiplying the number of potential ecological niches and helping species to achieve reproductive isolation [@Runemark2019]. 
Indeed, hybrid or derived species require a certain degree of reproductive isolation from their progenitors to avoid becoming an evolutionary melting pot. 
Nevertheless, species-specific adaptations can be maintained or even maximised under gene flow, 
especially with selective pressures varying in space and or time [@Tigano2016].
For instance, the European white oaks form one of the best known syngameons [@Cannon2019a].
European white oak species lack private haplotypes indicating extensive hybridisation [@Petit2002], 
but have a unique ecological niche with tolerance to drought, cold and alkaline soils [@Cannon2019a; @Leroy2019]. 
The coexistence of the different species is partly due to the genes that allow them to survive in different ecological niches [@Leroy2019].
To our knowledge, only few studies evidenced genetic evidence for differential adaptation to topography or abiotic habitats in tropical tree clades [@Fine2004; @Paun2016; @Pillon2014].
At the within-species level though, topography has been highlighted as a driver of genetic divergence [@Brousseau2015].

In the present study, we assessed genetic species delimitation and genotypic diversity of closely-related sympatric tree species belonging to two Neotropical species complexes. 
We addressed fine-scale spatial adaptation along a topography gradient and identified underlying edaphic and hydrologic gradients. 
Combining tree inventories, LiDAR-derived topographic data, and single nucleotide polymorphisms (SNPs) from gene capture experiments, 
we used population genomics, environmental association analyses and genome wide association studies to address the following questions:

1. How is genetic diversity structured among and within species of Neotropical tree species complexes ?
1. How are water and nutrient availability structured at fine spatial scale by the topographic gradients in which individuals grow?
1. Are tree species and individuals adapted to the fine-scale topographic gradients?

We hypothesized species to be delineated into gene pools corresponding to already described taxonomic morphotypes. 
We expected misidentifications due to absence of true diagnostic markers due to overlapping intraspecific morphological variability, and the difficulty to access reproductive material. 
In this context, molecular data reveals the true evolutionary history as it can reveal cryptic species or lead to the merging of  taxa previously thought to be distinct [@Ewedje2020].
We hypothesized relative elevation and topographic wetness to explain the distribution of water and nutrient availability at fine scale [@ferry2010higher; @Allie2015; Schmitt et al. in prep]. 
We hypothesized species to be delimited along topography with fixed neutral and adaptive variants, 
following previous evidence of topography determining species’ ecological niches [Schmitt et al., in prep]. 
But interspecific gene flow within the species complex could reduce species adaptations to topography and blur evolutionary history [@Tigano2016].

# Material and Methods

## Study site

The study was conducted in the Paracou field station, in the coastal forests of French Guiana, South America.
The site is characterized by an average of 3,041 mm annual rainfall and a mean air temperature of 25.71 °C [@Aguilos2018].
Old tropical forest with an exceptional richness (over 750 woody species) grows across the succession of small hills of this area, which rise to 10–40 m a.s.l. [@Gourlet-Fleury2004].
The site comprises 16 permanent plots (fifteen 6.25 ha plus one 25 ha) which have been censused (DBH>10) every 1-2 years for more than 35 years. Nine of the plots were logged and subjected to human-induced disturbance in 1986 [details on the experiment in @Herault2018].

## Plant material

Four hundred two individuals of *Symphonia globulifera* (Clusiaceae) 
and 432 individuals belonging to the clade *Parvifolia* of the genus *Eschweilera* [Lecythidaceae, @Huang2015; @Mori2016], 
were sampled in 2017 and 2018 during the dry season (from September to December) in Paracou (Fig. \@ref(fig:maps)).
Both genera are locally abundant and some constituent tree species are Amazonian hyperdominants [@TerSteege2013].
*Symphonia globulifera* L.f (Clusiaceae) was previously recognized as composed of two morphotypes in French Guiana [@Sabatier1997].
*S. globulifera sensu stricto* and *Symphonia sp.1* occur in sympatry but in differentiated habitats, 
with *S. globulifera* preferentially growing in valley bottoms with an acquisitive functional strategy 
and *S. sp1* preferentially exploiting a variety of drier habitats with a conservative functional strategy [@Allie2015; Schmitt et al., in prep; @Schmitt2020].
Similarly, *Eschweilera sagotiana* Miers, *E. decolorans* Sandwith, and *E. coriacea* (DC.) S.A.Mori exhibit niche differentiation, differential response to water stress, and different functional traits along topography [@Allie2015; Schmitt et al., in prep; @Ferry2007; @Schmitt2020].
The genera *Symphonia*  and *Eschweilera* have been highlighted as species complexes with low (phylo-)genetic species resolution and high levels of plastid DNA sharing among sister species [@baraloto_using_2012-1; @Caron2019; @Gonzalez2009; @Torroba-Balmori2017; @Heuertz2020; @Huang2015].
In addition, outgroups for genetic analysis in *Symphonia* were comprised of 13 individuals of *Symphonia globulifera* from Africa (Sao Tome, Gabon, Cameroun, Congo, Benin, Liberia, Ivory Coast, and Gana), seven *Symphonia globulifera* from South America (Brazil, Costa Rica and Panama), two *Symphonia nectarifera* Jum. & H. Perrier from Madagascar, two *Symphonia urophylla* (Decne. ex Planch. & Triana) Benth. & Hook.f. ex Vesque from Madagascar, five *Pentadesma butyracea* Sabine from Benin and Cameroon and one *Pentadesma grandifolia* Baker f. from Cameroon.
For *Eschweilera*, outgroups were selected from other *Eschweilera* clades in Paracou (*Lecythis persistens* Sagot, *E. simiorum* (Benoist) Eyma, and *E. chartacea* (O.Berg) Eyma).
Leaves were collected from the 864 individuals (402 + 30 *Symphonia* + 432 *Eschweilera*)  and  dessicated using silica gel. 

## Design of sequence capture 

We designed in *silico* two sets of 20,000 80-mer probes sequences, one for the genome of *Symphonia globulifera*, and a second compatible with both *Eschweilera sagotiana* and *Eschweilera coriacea* (Fig. S1, Fig. S2). 

*Symphonia globulifera*

For *Symphonia globulifera*, we used a published low-coverage draft genome from Africa [@Olsson2017], an unpublished draft genome from French Guiana [Scotti et al., in prep], an unpublished transcriptome from 20 juveniles from French Guiana [Tysklind et al., in prep], and reduced-representation genomic reads of individuals from French Guiana [Torroba-Balmori et al., unpublished].
We aligned genomic reads on the two genome drafts with `bwa` [@Li2009]. 
We kept scaffolds from the two genome drafts with a length superior to 1 kbp and at least one matching alignment with a read with a single match on the genome, and merged the two filtered genome drafts with `quickmerge` [@Chakraborty2016]. 
We aligned transcripts on the new filtered genome draft with `BLAT` [@Kent2002] and selected 533 scaffolds without transcript-match, *i.e.* anonymous scaffolds. 
We masked repetitive regions with `RepeatMasker` [@Smit2015] and selected 533 1-kbp anonymous loci within the 533 previous scaffolds.

Similarly, we filtered transcripts from the 20 juveniles of *Symphonia globulifera* from French Guiana [Tysklind et al., in prep] based on SNP quality, type and frequency. 
We further detected  open reading frames (ORFs) using `transdecoder` [@Haas2013], 
and selected transcripts with non-overlapping  ORFs including a start codon.
We kept ORFs with an alignment on scaffolds from the aforementioned genome draft for *Symphonia* using `BLAT` [@Kent2002],
and masked repetitive regions with `RepeatMasker` [@Smit2015]. 
We selected 1,150 genic loci of 500-bp to 1-kbp, from 100 bp before the start to a maximum of 900 bp after the end of the ORFs, resulting in 1-Mbp genomic loci that included a coding region.

*Eschweilera*

For *Eschweilera*, we used transcriptomes from  *Eschweilera sagotiana* and *Eschweilera coriacea* [@Vargas2019], and unpublished reduced representation genomic reads (M. Heuertz pers. com.).
We mapped reciprocally *E. coriacea* and *E. sagotiana* transcriptomes using `BLAT` [@Kent2002], and in reciprocal best matches, we kept a single transcript to avoid paralogs and have robust targets among species.
We further detected  open reading frames (ORFs) using `transdecoder` [@Haas2013], 
and selected transcripts with non-overlapping  ORFs including a start codon.
We selected 1,530 transcriptomic loci of 500-bp to 1-kbp, from 100 bp before the start to a maximum of 900 bp after the end of the ORFs, resulting in 0.83-Mbp of transcriptomic loci. 
To build anonymous targets, we built a *de novo* assembly of ddRAD-seq genomic data using `ipyrad` [@Eaton2020], mapped consensus sequences on transcripts using `BLAT` [@Kent2002], and kept consensus sequences with no match on transcripts.
We masked repetitive regions with `RepeatMasker` [@Smit2015] and selected  2.2k anonymous loci resulting in a length 0.52-Mbp.

## Genomic data production

*Libraries preparations*

Genomic DNA was extracted from 5 mg of dried leaf tissue with a CTAB protocol [@Doyle1987]. 
Libraries were digested with 'Ultra II FS Enzyme Mix' (new England Biolabs Inc, MA, USA) for a target size of 150 bp, and built with the 'NEBNext Ultra II FS DNA Library Prep kit for Illumina'(New England Biolabs Inc, MA, USA).
We amplified and tagged libraries using 5 $\mu L$ of adaptor-ligated DNA, 8.3 $\mu L$ of 'NEBNext Ultra II Q5 Master Mix' (new England Biolabs Inc, MA, USA), 2x 1.6 $\mu L$ of Index Primer i5 and i7 from 'NEBNext Multiplex Oligos for Illumina (Dual Index Primers Set 1 and Set 2)' (new England Biolabs Inc, MA, USA). 
Initial denaturation (98°C for 30 s) was followed by 8 cycles (98°C for 10 s and 65°C for 1 min 30 s) and a final extension (65°C for 5 min). 
We pooled libraries in four equimolar multiplex and captured sequences by hybridization for 80 hours.
We used the 20,000 80-mer probes sequences designed for the capture using myBaits Custom 1-20K (Arbor Biosciences, MI, USA) and corresponding myBaits V4 protocol. 
We finally pooled the four multiplexes and sequenced them in two lanes of an Illumina HiSeq 4000 instrument obtaining 2x150bp pair-end reads.

*Symphonia SNP calling and filtering*

We assessed the quality off raw reads using `multiqc` [@Ewels2016] and trimmed them with `trimmomatic` [@Andrews2010]. 
We kept only pair-end reads without adaptors and a phred score above 15 in a sliding window of 4.
70% of trimmed reads mapped off-targets using `bwa` [@Li2009]. 
We thus mapped trimmed reads on the hybrid reference built for target design of sequence capture using `bwa` [@Li2009], `picard` [@BroadInstitute2018], `samtools` [@Li2009a] and `bedtools` [@Quinlan2010].
We called variants for each individual using `HaplotypeCaller`, aggregated variants using `GenomicsDBImport` and jointly-genotyped individuals using `GenotypeGVCFs` all in `GATK4` software [@Freksa1993]. 
We filtered biallelic SNPs with a quality above 30, a quality by depth above 2, a Fisher strand bias below 60 and strand odds ratio above 3 using `GATK4` [@Freksa1993]. 
Finally, we filtered individuals and SNPs for missing data with a maximum of 95% and 15% of missing data per individual and SNP, respectively, using `plink2` [@Chen2019].
We obtained 454,262 biallelic SNPs over 406 individuals.

*Eschweilera SNP calling and filtering*

We assessed quality from raw reads using `multiqc` [@Ewels2016] and trimmed them with `trimmomatic` [@Andrews2010]. 
We kept only pair-end reads without adaptors and a phred score above 15 in a sliding window of 4.
We kept only trimmed reads mapped on-targets using `bwa` [@Li2009]. 
Because of problems with paralogs in *Eschweilera* clade *Parvifolia* due to a strong signature of a past genome duplication [@Heuertz2020],
we decided to build a *de novo* reference of successfully mapping reads using `ipyrad` with a very strict clustering threshold across individuals of 0.95 [@Eaton2020].
We automatically tested numerous values of missing data and outgroup filtering, and kept strict filters with population structure congruent with botanical identification but keeping a maximum of individuals (Fig. S3, Fig. S4).
We filtered individuals and SNPs for missing data with a maximum of 99% of missing data per SNP and at least 5 individuals represented per SNP using `plink2` [@Chen2019].
Outgroups were automatically filtered out by clustering individuals in a genomic principal component analysis (gPCA) in two groups using K-means (Fig. S5).
We obtained 418,793 biallelic SNPs over 257 individuals.

*Symphonia annotation*

We used the previous alignments (see design of sequence capture) from genome drafts [@Olsson2017; Scotti et al., in prep] with the transcriptome [Tysklind et al., in prep] to classify called SNPs into (i) anonymous SNPs (on scaffolds matching no transcripts), (ii) putatively-hitchhiker SNPs (close to a transcript or within an intron), and (iii) genic SNPs (within an exon).
We used transcript annotation of gene ontology to further annotate called SNPs. 
We used long ORFs detection with `TransDecoder` [@Haas2013], their alignment with `blastp` on the `Uniprot` database [@Bateman2019; @Bias1991] and with `hmmscan` on `Pfam` database [@Johnson2010; @El-Gebali2019] in addition to called SNPs position into `SNPdat` [@Doran2013] to assess SNP synonymy.

*Symphonia SNP filtering for quantitative genomics*

This first dataset including 454,262 SNPs was used for population genetic and demographic analyses. 
Since low-frequency alleles and linkage disequilibrium will bias the number of fixed loci and increase the number of false-positives in genomic scans [@Foll2008],
we built a second dataset for quantitative genomics, filtering variants with a minor allele frequency above 5% (18 individuals) and with linkage disequilibrium $r^2<0.99$. 
We further removed admixed individuals from genomic scans (see population genetic analyses for admixed individuals definitions). 
We retained 70,737 biallelic SNPs over 372 individuals.

## Analyses

### Genetic species delimitation

For genetic species delimitation within species complexes, 
we investigated population genetic structure using `admixture` [@Alexander2011], 
using 10 repetitions of K genetic groups varying from 1 to 10 and assessed the number of gene pools with cross validation.
We defined individuals with a membership to gene pools below 90% as admixed and the remaining individuals as genetically pure.
We further investigated admixture with the `introgress` R package [@Gompert2010], 
using genetically pure individuals as parental populations and all individuals as the hybrid population.
Due to an excess of missing data, `admixture` failed to infer population genetic structure for *Eschweilera*.
We thus used principal component analysis and K-means clustering to detect *Eschweilera* populations.
We assessed the number of gene pools using the within group sum of squares.
We validated populations structures of *Symphonia* and *Eschweilera* by comparison with botanical identifications.

We used `bayescan` [@Foll2008] to detect fixed SNPs between the different *Symphonia* gene pools using the 70,737 SNPs filtered for quantitative genomics (see genomic data production) with an *a priori* odd ratio of ten.
We considered as outliers those SNPs for which the p-value corrected for multiple testing by false discovery rate was below 5%.
We tested genic outlier SNPs for enrichment in gene ontology with the R package `clusterProfiler` [@DeLaCruz2014].

### Topography effect on neutral and adaptive genetic variation

To explore topography effect on genetic variation,
we selected two little-correlated topographic variables, the topographic wetness index (TWI) and the relative elevation (RE, Pearson'$r=-0.26$, $p-value<10^{-16}$), 
among several abiotic descriptors and as proxies of water and nutrients availability in Paracou. 
Waterlogging and topography have been highlighted as crucial for forest dynamics [@ferry2010higher], species-habitats [@Engelbrecht2007], and phenotypic variation of *Symphonia* and *Eschweilera* [@Schmitt2020]. 
TWI and RE were derived from a 1-m resolution digital elevation model using SAGA-GIS [@Conrad2015] based on a LiDAR campaign done in 2015.
We further used analysis of variance (ANOVA) to characterize TWI and RE (as response variables) specificities with edaphic and hydrologic properties (as explanatory variables, including soil organic matter, carbon, nitrogen, exchangeable cation charge [@Soucemarianadin2004; @Roelens2007], water table depth [@Gourlet-Fleury2004] and waterlogging [@Cantet2004]).

We did environmental association analyses [@Rellstab2015a] using general linear mixed models developed for genome wide association studies (GWAS). 
We used topography as the response variable and genetic structure (populations) and relatedness (kinship matrix) as explanatory variables, as it is common practice [@Rellstab2015a]. 
We assumed that the topographic conditions where individuals have grown above 10-cm DBH was strongly correlated to the individual heritable phenotypes [e.g. @Eckert2010]. 
We used genetic species and individual kinship in a lognormal animal model [@Wilson2010] to estimate genetic variance associated with topography.
We defined species based on the gene pools identified with `admixture`, removing admixed individuals.
We inferred individual kinship using KING [@Manichaikul2010], as the method is robust to population structure. 
We set negative kinship values to null as they were confounding with population structure, and we further ensured that the matrix was positive-definite using the `nearPD`  function from the R package `Matrix`.
The environment $y_{s,i}$ where individual $i$ in species $s$ grows was inferred with a lognormal distribution with the following formula:

\begin{equation}
   \begin{aligned}
      y_{s,i} \sim logN(log(\mu_s.a_{i}),\sigma^2_1) \\
      a_{i} \sim MVlogN_N(log(1),\sigma^2_2.K)
   \end{aligned}
   (\#eq:AnimalEnv)
\end{equation}

where $\mu_s$ is the mean environment of species $s$, $a_i$ is the breeding value of the individual $i$ and $\sigma^2_1$ is the shape parameter of the lognormal. 
Individual breeding values $a_i$ are defined following a multivariate lognormal law $\mathcal{MVlogN}$ of co-shape matrix defined as the product of the kinship matrix $K$ with estimated individual genotypic variation $\sigma^2_2$.
To estimate variances on a normal scale, we log-transformed species fixed effect, genetic additive values, and we calculated conditional and marginal $R^2$ [@Nakagawa2013].
A Bayesian method was used to infer parameters using `stan` language [@Carpenter2017, Model S1] and `rstan` package [@Team2018] in the R environment [@RCoreTeam2020] using the No-U-Turn Sampler alogirthm [NUTS, @Hoffman2014], which performs better for estimating genetic parameters and breeding values [@Nishio2019].

# Results

*Symphonia globulifera* was previously recognized as composed of two morphotypes in French Guiana [@Sabatier1997]. 
But cross validation of admixture analyses for different levels of clustering K advocated for 3 different gene pools (Fig. \@ref(fig:symphospecies), Fig. S6, Fig. S7).
The three gene pools corresponded to the previously identified two morphotypes (70-80% of match) *S. globulifera* and *S. sp1*, with *S. globulifera* morphotype itself structured in two gene pools. 
The two gene pools composing the *S. globulifera* morphotype corresponded to two locally defined sub-morphotypes called *S. globulifera type Paracou* and *S. globulifera type Régina* (Fig. \@ref(fig:symphomorphotypes), Saint-Omer Cazal, pers. com.). 
*S. sp1* grows preferentially in drier plateaux and slopes (Schmitt et al., submitted) and has a light grey thin and smooth bark associated with smaller leaves, flowers and fruits  (Fig.\@ref(fig:symphomorphotypes); @Sabatier1997). 
*S. globulifera type Paracou* grows in wet habitats of bottomlands, but drier than the last population, and has a dark and intermediate thin and smooth bark compared to the last population (Fig.\@ref(fig:symphomorphotypes); Schmitt, pers. com.). 
*S. globulifera type Regina* grows in the wettest bottomlands of Paracou and has a thick and lashed bark (Fig.\@ref(fig:symphomorphotypes); Schmitt, pers. com.).
We conducted a second blind-identification of every individual in November 2019 to investigate mismatches between gene pools and morphotypes and the existence of the two morphotypes *S. globulifera type Paracou* and *S. globulifera type Régina*. 
The blind-identification correctly assigned the difference between all *S. globulifera type Paracou* and *S. globulifera type Régina* and reclassified correctly 87% of previous mismatches between gene pools and previous botanical identification.
Among the three populations, 25 individuals (7%) showed patterns of introgression, 15 between *S. globulifera type Regina* and *S. sp1* and 10 between *S. globulifera type Paracou* and *S. sp1* (confirmed with `introgress` R package [@Gompert2010], Fig. S8). 
Admixed individuals were removed from subsequent analyses.
Last but not least, genomic scans for *Symphonia* revealed fixed markers among populations (5.7% of SNPs, Fig. S9) with adaptive markers represented by an enrichment of genes related to “response to water deprivation” ($p=0.01106483$). 
Consequently, *Symphonia globulifera* was locally and genetically structured in three sympatric species (Fig. \@ref(fig:symphospecies)), including thus cryptic species, corresponding to three different morphotypes (Fig. \@ref(fig:symphomorphotypes)). 
*Eschweilera* clade Parvifolia was locally and genetically structured in three genepools corresponding to botanical species *E. coriacea*, *E. sagotiana* and *E. decolorans* (65-80% of match, Fig. \@ref(fig:parvispecies), Tab. S1).

We identified topographic wetness index (TWI) and relative elevation (RE, Fig. \@ref(fig:SpDistVar)) as descriptors of the topographic gradient in which individuals grow.
Topographic wetness index ($TWI$) was related to hydrology (ANOVA with water table depth, $R^2=0.32$, $p<10^{-151}$).
Relative elevation ($RE$) was related to soil chemistry due to hydromorphy (ANOVA with soil carbon, nitrogen, organic matter, exchangeable cation charge and soil color due to hyrdomorphy with $0.23<R^2<0.28$, $p<10^{-30}$).
The spatial distribution of *Symphonia* and *Eschweilera* species suggested that both topographic wetness index ($TWI$) and relative elevation ($RE$) drove individual survival among populations ($0.06<R_m^2<0.39$, Fig. \@ref(fig:SpDistVar), Tab. \@ref(tab:fits)).
The spatial distribution of *Symphonia* species was driven by both topographic wetness index ($TWI$, Fig. \@ref(fig:SpDistVar)**c**, Tab. \@ref(tab:fits)), especially between *S. globulifera Regina* and *S. globulifera Paracou*, and relative elevation ($RE$, Fig. \@ref(fig:SpDistVar)**d**, Tab. \@ref(tab:fits)), especially between *S. sp1* and the two remainings.
The spatial distribution of *Eschweilera*  species was mainly driven by relative elevation ($RE$, Fig. \@ref(fig:SpDistVar)**b**, Tab. \@ref(tab:fits)).
The spatial distribution of *Symphonia* and *Eschweilera* species along topography resulted in intermediate genetic differentiation, $F_{ST}=0.15$ and $F_{ST}=0.35$ between *Symphonia* and *Eschweilera* species respectively

# Discussion

Despite the local abundance and regional success of closely-related tree species growing in sympatry in the Neotropics,
little is known of the eco-evolutionary forces responsible for their local coexistence.
Here, we show that within tree species complexes, closely-related species have different realized optima for topographic niches with species genetic adaptations. 
*Symphonia* species are adapted to water and nutrient distribution with topographic wetness and relative elevation,
growing thus in a broad range of local habitats.
Whereas *Eschweilera* species are differentially adapted to soil chemistry due to hydromorphy, avoiding wettest habitats.
The greater role of topography among *Symhponia* species than among *Eschweilera* species suggests that topography may be the main factor in differentiating niches among *Symhponia* species, while other factors may differentiate niches among *Eschweilera* species.
Consequently, species adaptations to different characteristics of topography stabilize local coexistence between closely-related species within tree species complexes.

## Three species of *Symphonia* adapted to topography coexist in sympatry

We identified three distinct species of *Symphonia globulifera* with different morphology, genepool and topographic niche.
For the study purpose, we named the three species *S. sp1*, *S. globulifera type Paracou* and *S. globulifera type Regina* in reference to already existing morphotypes and local names.
The three species showed a low but significant genetic differentiation ($F_{ST} = 0.15$), already highlighted previously at the local scale between the previously two recognized morphotypes [$F_{ST} = 0.114$ for SSRs; @Olsson2017].
The genetic differentiation was revealed by 5.7% of SNPs being significantly associated with species with an enrichment in genes implicated in response to water deprivation.
Interestingly though, topography has already been highlighted as a driver of the distribution of the two previously recognized morphotypes [@Allie2015; Schmitt et al. submitted], with *S. globulifera* growing in low-elevation and wet bottomlands and *S. sp1* growing in drier slopes and plateaux.
But our study revealed the existence of two *Symphonia globulifera* morphotypes segregated within wet areas with *Symphonia globulifera type Regina* growing in the wettest bottomlands, such as swamp characterized by increased wetness and anoxia.
Similar ecotypic differentiation with swamp have been suggested in Africa [@Budde2013].
Individual topographic conditions were mainly plastic (54-56% of residual variation) but among the remaining genetic variation the majority (80-85%) was due to species differences (Fig. \@ref(fig:SpDistVar)).
Thus, finescale topographic variation between individuals was driven by species adaptations, revealing local adaptation to topography among the three species at the hectare-scale.
Further studies at a broader regional scale are needed, but our results advocate for the definition of three distinct taxonomic species with differences in morphology (Fig. \@ref(fig:symphomorphotypes)), habitats (Fig. \@ref(fig:SpDistVar)), functional traits and growth trajectories (S. Schmitt pers. com.).

## Differentiation of *Symphonia* and *Eschweilera* species along topography: water distribution and soil chemistry

*Symphonia* species were primarily differentially adapted to water and nutrient distribution with topographic wetness and relative elevation; whereas *Eschweilera* species were differentially adapted to soil chemistry due to hydromorphy.
Similarly to *Symphonia* species, at least three distinct species of *Eschweilera* clade *Parvifolia* with different morphology, genepool and topographic niche coexist in sympatry. 
*E. coriacea* preferentially grow in valley bottoms, and *E. sagotiana* and *E. decolorans* preferentially exploit a variety of drier habitats with slopes and plateaus [Fig. \@ref(fig:SpDistVar); @Allie2015; Schmitt et al. submitted].
The lack of power of *Eschweilera* data prevented us from detecting less abundant *Eschweilera* clade *Parvifolia* species (e.g. *E. grandiflora*, *E. whachenheimii*), but our results do not question their botanical definitions.
Topographic conditions of *Eschweilera* individuals were mainly plastic (73-75% of residual variation), but among the remaining genetic variation the majority was due to species differences for relative elevation (52%) while the majority was due to genotypes for topographic wetness index (78%, Fig. \@ref(fig:SpDistVar)).
The results of *Eschweilera* are in contrast to those of *Symphonia*,
with more plasticity and genotypic effects in topographic conditions of *Eschweilera* individuals than *Symphonia* individuals.
Moreover, species topographic differences for *Symphonia* were driven by both topographic wetness, especially between *S. sp1* and others, and relative elevation, especially between the two *S. globulifera*; 
whereas species topographic differences for *Eschweilera* were mainly driven by relative elevation.
Indeed, topographic wetness was more related to hydrology with water table depth; 
whereas relative elevation was more related to soil chemistry.
Thus, *Symphonia* species are able to grow in a wide variety of habitats due to species adaptation to different water and nutrient access;
whereas *Eschweilera* species avoid wettest habitats and grow in a variety of topography due to species adaptation to nutrient access (Fig. \@ref(fig:SpDistVar)).
Topography had globally a greater role among *Symphonia* species than among *Eschweilera* species (less residual variation).
*Eschweilera* species may thus differentiate along other ecological niches or coexist with species competitively combining [@Aarssen1983].

## Species differentiation along topography and coexistence within species complexes

The interaction between topography and genes shapes the microgeographic genetic structure of the three sympatric populations of *Symphonia globulifera* and *Eschweilera* clade *Parvifolia*. 
Species of *Symphonia globulifera* and *Eschweilera* clade *Parvifolia* are locally adapted to fine-scale topography, 
along a gradient from flooded, nutrient-rich bottomlands to drier, poorer slopes and plateaus.
Genomic bases for the microgeographic adaptation of species have been identified for *Symphonia* species,
with in particular a functional response to water distribution identified as a driver of the topographic niches of the species.
Similarly to European white oak, we identified coexisting different species with genes that allow them to survive in different ecological niches despite interspecific hybridization [@Leroy2019]. 
Consequently, we evidenced syngameons of tropical trees with differential adaptations of species to topographic niches stabilizing local coexistence of species. 
If interspecific gene flow benefits all the constituent species, *Symphonia globulifera* and *Eschweilera* clade *Parvifolia* might be a successful evolutionary state as syngamons [@Cannon2019a].
Literature includes numerous examples of closely-related species differentiated along topography [@gunatilleke_specieshabitat_2006; @Engelbrecht2007; @kraft_functional_2008; @Allie2015] or along other ecological niches [@Crystal2003; @Yamasaki2013].
In Paracou, several species complexes have been shown to present differentiated niches along topography [Schmitt et al. in prep].
Combined with our results, this abundant evidence of niche differentiation between closely related species calls into question the more general role of topography in the genetic adaptation and diversification of tropical tree species complexes.
Moreover, this question the role of species complexes and syngameons in the origin and maintenance of Neotropical forest diversity.

# Acknowledgements

We thank the University of Bordeaux for a PhD grant to Sylvain Schmitt. 
We are grateful to Pascal Petronelli and the CIRAD inventory team for their work on tree inventories and botanical identification. 
This study was partially funded by an Investissement d’Avenir grant of the ANR: CEBA (ANR-10-LABEX-0025).

# Authors’ contributions

All authors conceived the ideas and designed methodology;
SS, MH, and NT sampled individuals;
SS and MH realized the gene capture experiment;
SS, MH and BH  analysed outputs; 
SS and XX led the writing of the manuscript. 
All authors contributed critically to the drafts and gave final approval for publication.

# References

<div id="refs"></div>

# Supporting information

**Model S1.**  Stan code for the animal model

**Tab. S1.** *Eschweilera* botanical species and genetic clusters

**Fig. S1.** Target selection for the capture experiment of *Symphonia*

**Fig. S2.** Target selection for the capture experiment of *Eschweilera*

**Fig. S3.** SNP abundance per library for *Eschweilera*

**Fig. S4.** Library abundance per SNP for *Eschweilera*

**Fig. S5.** Outgroup detection for *Eschweilera*

**Fig. S6.** Cross-validation for *Symphonia* population structure

**Fig. S7.** *Symphonia* population structure

**Fig. S8.** *Symphonia* hybrid index 

**Fig. S9.** *Symphonia* species-specific SNPs

# Tables and Figures

## Figures

**Figure \@ref(fig:maps).** Map of sampled individuals for species complexes *Symphonia* and *Eschweilera* clade *Parvifolia*. Colours represent species determined based on the genetic structure of capture datasets, which was not necessarily in agreement with original botanical identification. Grey level represents hill shading to visualize topography.

**Figure \@ref(fig:symphospecies).** Admixture plot of *Symphonia* individuals for the best K, K = 3.

**Figure \@ref(fig:symphomorphotypes).** *Symphonia* trunk morphology. The three morphotypes are identified with their bark with *S. sp1* (left, red) having a light grey thin and smooth bark, the *S. globulifera type Paracou* (center, light blue) having a dark and intermediate thin and smooth bark compared to the thick and lashed bark of *S. globulifera type Regina* (right, dark blue).

**Figure \@ref(fig:parvispecies).** Principal component analysis (PCA) of single nucleotide polymorphisms (SNP) from *Eschweilera* clade *Parvifolia.* The colours represent the clusters detected with Kmeans for the best K, K = 3.

**Figure \@ref(fig:SpDistVar).** Species distribution and individual variance partitioning along topography. Each subfigure shows density of individuals per species (density plot) against individual variation (barplot) partitioned with the Animal model into between-species (dark grey), between-genotypes (intermediate grey) and residual (light grey). Species distribution and individual variance partitioning partitioning are given along the topographic wetness index (TWI, left subfigures) and the logarithm of relative elevation (log(RE+1), right subfigures) for the species complexes *Eschweilera* clade *Parvifolia* (top subfigures) and *Symphonia* (bottom subfigures). Colours represent species determined based on the genetic structure of capture datasets, which was not necessarily in agreement with original botanical identification.

\newpage
 
```{r config, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls()); invisible(gc())
library(knitr)
library(tidyverse)
library(raster)
library(bayesplot)
theme_set(bayesplot::theme_default())
opts_chunk$set(echo = F, message = F, warning = F, 
               fig.height = 6, fig.width = 6,
               cache = T, cache.lazy = F)
# crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0'
crs <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
spcol <- c("#1b9e77", "#d95f02", "#7570b3", "#1E90FF", "#0000EE", "#CD2626")
names(spcol) <- c("E. decolorans", "E. sagotiana", "E. coriacea", "S. globulifera Paracou", "S. globulifera Regina", "S. sp1")
```

```{r fits}
fitSympho <- list(TWI = list(), RE = list())
for(var in c("TWI", "RE")){
  for(sim in list.files("../symcapture/symcapture_save/EnvGeno", 
                        pattern = var, full.names = T)){
    load(sim)
    fitSympho[[var]] <- c(fitSympho[[var]], fit)
  }
}
fitSympho <- lapply(fitSympho, rstan::sflist2stanfit)
names(fitSympho) <- paste0("Symphonia.", names(fitSympho))
fitParvi <- list(TWI = list(), RE = list())
for(var in c("TWI", "RE")){
  for(sim in list.files("../parvicapture/parvicapture_save/all/EnvGeno2/", 
                        pattern = var, full.names = T)){
    load(sim)
    fitParvi[[var]] <- c(fitParvi[[var]], fit)
  }
}
fitParvi <- lapply(fitParvi, rstan::sflist2stanfit)
names(fitParvi) <- paste0("Eschweilera.", names(fitParvi))
fitEnv <- c(fitSympho, fitParvi)
rm(fitSympho, fitParvi)
lapply(fitEnv, broom::tidyMCMC, c("mu", "Vp", "Vg", "Vr"), droppars = NULL, rhat = F) %>% 
  bind_rows(.id = "fit") %>% 
  separate(fit, c("complex", "variable")) %>% 
  separate(term, c("parameter", "population"), "[:punct:]", convert = T) %>% 
  mutate(population = ifelse(is.na(population), "", paste0(complex, population))) %>% 
  mutate(population = recode(population, 
                             "Symphonia1" = "S. globulifera Paracou",
                             "Symphonia2" = "S. globulifera Regina", 
                             "Symphonia3" = "S. sp1",
                             "Eschweilera3" =  "E. decolorans", 
                             "Eschweilera2" = "E. sagotiana",
                             "Eschweilera1" = "E. coriacea")) %>% 
  mutate(parameter = recode(parameter, 
                            "mu" = "$\\mu_s$",
                            "Vp" = "$V_{species}$", 
                            "Vg" = "$V_{genotype}$",
                            "Vr" = "$V_{residuals}$")) %>% 
  kable(caption = "Parameters and associated standard deviation of the animal model for *Symphonia* and *Eschweilera* with topographic wetness index (TWI) and relative elevation (RE).",
        format = "pandoc",
        col.names = c("Species complex", "Topographic variable", "Parameter",  
                      "Species", "Estimate", "Standard deviation")) %>% 
  kableExtra::add_footnote("Parameters include species mean ($\\mu_s$), variance ($V_{species}$), genotype variance ($V_{genotype}$), and residuals variance ($V_{residuals}$). Parameters have been infered with bayesian modelling of the animal model (Model S1) independently for the two species complexes and the two topographic variables.", notation = "none")
```

```{r maps, fig.cap="Map of sampled individuals for species complexes *Symphonia* and *Eschweilera* clade *Parvifolia*. Colours represent species determined based on the genetic structure of capture datasets, which was not necessarily in agreement with original botanical identification. Grey level represents hill shading to visualize topography.", fig.width=6, fig.height=5}
load("../symcapture/symcapture_save/Env.Rdata")
symphonia <- trees
load("../parvicapture/parvicapture_save/Env.Rdata")
eschweilera <- trees
trees <- bind_rows(
  mutate(symphonia, genus = "Symphonia") %>% 
    dplyr::select("Ind", "Xutm", "Yutm", "genus", "pop") %>% 
    dplyr::rename(species = pop) %>% 
    mutate(species = gsub("Type", " ", species)) %>% 
    mutate(species = paste0("S. ", species)),
  mutate(eschweilera, genus = "Eschweilera") %>% 
    dplyr::select("Library", "Xutm", "Yutm", "genus", "cluster") %>% 
    dplyr::rename(Ind = Library, species = cluster) %>% 
    mutate(species = recode(species, "3" =  "E. decolorans", 
                            "2" = "E. sagotiana",
                            "1" = "E. coriacea")) 
)
coordinates(trees) <- ~Xutm + Yutm
proj4string(trees) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
trees <- spTransform(trees, CRSobj = crs)
hills <- raster(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/",
                          "topography", "hillshade_1m.tif"))
hills <- crop(hills, trees)
hills <- projectRaster(hills, crs = crs)
hills <- as(aggregate(hills, 4), "SpatialPixelsDataFrame")
hills <- as.data.frame(hills)
colnames(hills) <- c("hills", "Xutm", "Yutm")
hills <- lapply(c("Symphonia", "Eschweilera"), function(g) mutate(hills, genus = g)) %>% bind_rows()
ggplot(hills, aes(x = Xutm, y = Yutm)) +
  geom_tile(aes(fill = hills),  col = NA, alpha = 0.6, data = ) +
  scale_fill_distiller(guide = "none", palette = "Greys", direction = 1) +
  geom_point(data = as.data.frame(trees), aes(col = species)) +
  scale_color_manual("", values = spcol[c(3, 1, 2, 4, 5, 6)]) +
  facet_wrap(~ genus) +
  coord_equal() +
  cowplot::theme_map() +
  ggspatial::annotation_scale(location = "br", width_hint = 0.5, plot_unit = "m", 
                              data = data.frame(genus = "Symphonia")) +
  ggspatial::annotation_north_arrow(location = "tl", height = unit(1, "cm"), width = unit(1, "cm"),
                                    data = data.frame(genus = "Eschweilera")) +
  theme(axis.title = element_blank(),
        legend.position = "bottom", legend.text = element_text(face = "italic"),
        strip.background = element_blank(), strip.text.x = element_blank())  +
  guides( col = guide_legend(nrow = 2, byrow = T)) +
  ggsave("figures/Figure_1.pdf", device = "pdf", dpi = 600, width = 6, height = 5)
```

```{r symphospecies, fig.cap="Admixture plot of *Symphonia* individuals for the best K, K = 3.", fig.width=6, fig.height=3}
pophelper::readQ(file.path("../../../data/Symphonia_Paracou/Sequences/populationGenomics/",
                           "admixture", "paracou", "symcapture.all.biallelic.snp.filtered.nonmissing.paracou.3.Q"))[[1]] %>%
  dplyr::rename(Ssp1 = Cluster1, SgParacou = Cluster2, SgRegina = Cluster3) %>%
  mutate(Ind = gsub(".g.vcf", "", read_tsv(file.path("../../../data/Symphonia_Paracou/Sequences", "variantCalling", "paracou",
                                                     "symcapture.all.biallelic.snp.filtered.nonmissing.paracou.fam"),
                                           col_names = c("FID", "IID", "FIID", "MIID", "sex", "phenotype"))$IID)) %>%
  arrange(desc(Ssp1), desc(SgParacou), desc(SgRegina)) %>%
  mutate(order = 1:nrow(.)) %>%
  reshape2::melt(id.vars = c("order", "Ind"), variable.name = "pop") %>%
  ggplot(aes(reorder(Ind, order), value, fill = pop, col = pop)) +
  geom_col() +
  scale_fill_manual("", values = c("#CD2626", "#1E90FF", "#0000EE"),
                    labels = c("S. sp1", "S. globulifera Paracou", "S. globulifera Regina")) +
  scale_color_manual("", values = c("#CD2626", "#1E90FF", "#0000EE"),
                     labels = c("S. sp1", "S. globulifera Paracou", "S. globulifera Regina")) +
  ylab("Admixture coefficient") +
  theme(axis.title.x = element_blank(), axis.line.x = element_blank(),
        axis.ticks.x = element_blank(), axis.text.x = element_blank(),
        legend.text = element_text(face = "italic"), legend.position = "top") +
  ggsave("figures/Figure_2.pdf", device = "pdf", dpi = 600, width = 6, height = 3)
```

```{r symphomorphotypes, fig.cap="*Symphonia* trunk morphology. The three morphotypes are identified with their bark with *S. sp1* (left, red) having a light grey thin and smooth bark, the *S. globulifera type Paracou* (center, light blue) having a dark and intermediate thin and smooth bark compared to the thick and lashed bark of *S. globulifera type Regina* (right, dark blue)."}
include_graphics("figures/symphoniamorphotypes.png")
# convert symphoniamorphotypes.png Figure_3.tiff
```

```{r parvispecies, fig.cap="Principal component analysis (PCA) of single nucleotide polymorphisms (SNP) from *Eschweilera* clade *Parvifolia.* The colours represent the clusters detected with Kmeans for the best K, K = 3.", fig.height=5, fig.width=5}
vars <- read_delim(file.path("../../../data/Eschweilera_Paracou/Sequences/", "variants", "final", "filtered.eigenval"), 
               delim = " ", col_names = "var")
read_delim(file.path("../../../data/Eschweilera_Paracou/Sequences/", "variants", "final", "filtered.eigenvec"),
           delim = " ", col_names = c("X1", "Sample", paste0("PCA", 1:20))) %>% 
  separate(Sample, paste0("X", 1:7), "[:punct:]", remove = F) %>% 
  dplyr::rename(IdGenetic = X4, Lane = X5) %>% 
  left_join(read_tsv(file.path("../../../data/Eschweilera_Paracou/Sequences/", "variants", "final", "filtered.kmeans"))) %>% 
  mutate(species = recode(cluster, "3" =  "E. decolorans", 
                          "2" = "E. sagotiana",
                          "1" = "E. coriacea")) %>% 
  ggplot(aes(x = PCA1, y = PCA2, col = species)) +
  geom_point(size=2, alpha = 0.5) +
  theme(legend.position = "bottom", legend.text = element_text(face = "italic")) +
  xlab(paste0("PCA 1 - ", vars$var[1], "%")) +
  ylab(paste0("PCA 2 - ", vars$var[2], "%")) +
  scale_color_manual("", values = spcol[c(3,1,2)]) +
  ggsave("figures/Figure_4.pdf", device = "pdf", dpi = 600, width = 5, height = 5)
```

```{r SpDistVar, fig.cap="Species distribution and individual variance partitioning along topography. Each subfigure shows density of individuals per species (density plot) against individual variation (barplot) partitioned with the Animal model into between-species (dark grey), between-genotypes (intermediate grey) and residual (light grey). Species distribution and individual variance partitioning partitioning are given along the topographic wetness index (TWI, left subfigures) and the logarithm of relative elevation (log(RE+1), right subfigures) for the species complexes *Eschweilera* clade *Parvifolia* (top subfigures) and *Symphonia* (bottom subfigures). Colours represent species determined based on the genetic structure of capture datasets, which was not necessarily in agreement with original botanical identification.", fig.width=11, fig.height=6}
wetness <- raster(file.path("../../../data/Paracou/", "topography", "TWI_1m.tif"))
relele <- raster(file.path("../../../data/Paracou/", "topography", "RelativeElevation_1m.tif"))
dem <- raster(file.path("../../../data/Paracou/", "topography", "DEM_1m_2015.tif")) # for CRS
projection(wetness) <- projection(dem)
projection(relele) <- projection(dem)
wetness <- projectRaster(wetness, crs = crs)
relele <- projectRaster(relele, crs = crs)
trees$TWI <- raster::extract(wetness, trees)
trees$RE <- raster::extract(relele, trees)
gl.legend <- cowplot::get_legend(trees@data %>%
  mutate(RE = log(RE+1)) %>% 
  reshape2::melt(id.vars = c("Ind", "genus", "species")) %>% 
  mutate(variable = recode(variable, "TWI" = "Topographic wetness index",
                           "RE" = "log(Relative elevation + 1)")) %>% 
  ggplot(aes(value, fill = species, color = species)) +
  geom_density(alpha = 0.1) +
  facet_grid(genus ~ variable, scales = "free") +
  scale_color_manual("Species", values = spcol[c(3, 1, 2, 4, 5, 6)]) +
  scale_fill_manual("Species", values = spcol[c(3, 1, 2, 4, 5, 6)]) +
  theme(legend.position = "bottom", legend.text = element_text(face = "italic")) +
  guides(fill = guide_legend(nrow = 2, byrow = T), col = guide_legend(nrow = 2, byrow = T)))
fitSympho <- list(TWI = list(), RE = list())
for(var in c("TWI", "RE")){
  for(sim in list.files("../symcapture/symcapture_save/EnvGeno", 
                        pattern = var, full.names = T)){
    load(sim)
    fitSympho[[var]] <- c(fitSympho[[var]], fit)
  }
}
fitSympho <- lapply(fitSympho, rstan::sflist2stanfit)
names(fitSympho) <- paste0("Symphonia.", names(fitSympho))
fitParvi <- list(TWI = list(), RE = list())
for(var in c("TWI", "RE")){
  for(sim in list.files("../parvicapture/parvicapture_save/all/EnvGeno2/", 
                        pattern = var, full.names = T)){
    load(sim)
    fitParvi[[var]] <- c(fitParvi[[var]], fit)
  }
}
fitParvi <- lapply(fitParvi, rstan::sflist2stanfit)
names(fitParvi) <- paste0("Eschweilera.", names(fitParvi))
fitEnv <- c(fitSympho, fitParvi)
rm(fitSympho, fitParvi)
gr.legend <- cowplot::get_legend(lapply(fitEnv, mcmc_intervals_data, regex_pars = c("Vp", "Vg", "Vr")) %>% 
  bind_rows(.id = "variable") %>% 
  mutate(parameter = recode(parameter, "Vp" = "Species", "Vg" = "Genotype", "Vr" = "Residual")) %>% 
  group_by(variable) %>%
  mutate(pct = paste0(round(m / sum(m) * 100), "%")) %>%
  separate(variable, c("genus", "variable")) %>% 
  group_by(genus, variable) %>%
  mutate(m2 = m/sum(m)) %>% 
  ungroup() %>% 
  mutate(variable = recode_factor(variable, "RE" = "Relative elevation",
                                  "TWI" = "Topographic wetness index")) %>% 
  ggplot(aes(x = variable, fill = parameter)) +
  geom_col(aes(y = m2)) +
  geom_text(aes(y = m2, label = pct), col = "white", position = position_stack(vjust = .5)) +
  facet_wrap(~ genus, scales = "free", nrow = 2) +
  coord_flip() +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.line.x = element_blank(),
        axis.ticks.x = element_blank(), axis.line.y = element_blank(),
        legend.position = "bottom", strip.text = element_text(face = "italic")) +
  scale_fill_grey(expression(sigma^2)) +
  guides(fill = guide_legend(nrow = 3, byrow = T)))
bars <- lapply(fitEnv, mcmc_intervals_data, regex_pars = c("Vp", "Vg", "Vr")) %>% 
  bind_rows(.id = "variable") %>% 
  mutate(parameter = recode(parameter, "Vp" = "Species", "Vg" = "Genotype", "Vr" = "Residual")) %>% 
  group_by(variable) %>%
  mutate(pct = paste0(round(m / sum(m) * 100), "%")) %>%
  separate(variable, c("genus", "variable")) %>% 
  group_by(genus, variable) %>%
  mutate(m2 = m/sum(m)) %>% 
  ungroup() %>% 
  mutate(variable = recode_factor(variable, "RE" = "Relative elevation",
                                  "TWI" = "Topographic wetness index")) %>% 
  group_by(genus, variable) %>% 
  do(g = ggplot(data = ., aes(x = variable, fill = parameter)) +
       geom_col(aes(y = m2)) +
       geom_text(aes(y = m2, label = pct), col = "white", position = position_stack(vjust = .5)) +
       theme(axis.title = element_blank(), axis.text = element_blank(), axis.line = element_blank(), 
             axis.ticks = element_blank()) +
       scale_fill_grey(guide = "none"))
densities <- trees@data %>%
  mutate(RE = log(RE+1)) %>% 
  reshape2::melt(id.vars = c("Ind", "genus", "species")) %>% 
  mutate(variable = recode(variable, "TWI" = "Topographic wetness index",
                           "RE" = "log(Relative elevation + 1)")) %>% 
  group_by(genus, variable) %>% 
  do(g = ggplot(data = ., aes(value, fill = species, color = species)) +
       geom_density(alpha = 0.1) +
       facet_grid(genus ~ variable, scales = "free") +
       scale_color_manual("", values = spcol[c(3, 1, 2, 4, 5, 6)]) +
       scale_fill_manual("", values = spcol[c(3, 1, 2, 4, 5, 6)]) +
       theme(legend.position = "none"))
g.white <- qplot(1:10, 1:10, geom="blank") +
  theme(axis.title = element_blank(), axis.line = element_blank(), 
        axis.ticks = element_blank(), axis.text = element_blank())
cowplot::plot_grid(densities$g[[1]], 
                   bars$g[[2]], 
                   densities$g[[2]], 
                   bars$g[[1]],
                   densities$g[[3]], 
                   bars$g[[4]], 
                   densities$g[[4]], 
                   bars$g[[3]],
                   g.white,
                   gl.legend,
                   g.white,
                   gr.legend,
                   nrow = 3, rel_widths = c(3,1,3,1), rel_heights = c(3,3,1),
                   labels = c("(a)", "", "(b)", "", "(c)", "", "(d)", "")) +
  ggsave("figures/Figure_5.pdf", device = "pdf", dpi = 600, width = 11, height = 6)
```
