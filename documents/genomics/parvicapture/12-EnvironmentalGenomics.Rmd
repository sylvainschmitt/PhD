```{r setup_envgenom, include=FALSE, eval=T}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(bayesplot)
library(raster)
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F, eval=T)
path <- "~/Documents/BIOGECO/PhD/data/Eschweilera_Paracou/Sequences/genomics"
crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0'
S_sqrt_trans <- function() scales::trans_new("S_sqrt",
                                             function(x) sign(x)*sqrt(abs(x)),
                                             function(x) x^2*sign(x))
load("./parvicapture_save/Env.Rdata") 
```

# Environmental genomics

In this chapter, we decomposed environmental variation with population structure and individual kinship.

```{r DataEnvGenom, eval=F}
clades <- rbind(
  data.frame(Clade = "Parvifolia",
             Species = c("sagotiana", "coriacea", "decolorans", "pedicellata", "wachenheimii", "grandiflora",
                         "grandiflora_form2")),
  data.frame(Clade = "Chartacea",
             Species = c("congestiflora", "simiorum"))
)
trees <- googlesheets::gs_title("Parvicapture") %>% 
  googlesheets::gs_read("Extraction") %>% 
  dplyr::select(IdGenetic, Genus, Species, Plot, SubPlot, TreeFieldNum) %>% 
  unique() %>% 
  na.omit() %>% 
  left_join(clades)
trees <- read_delim(file.path(path, "..", "variants", "final", "filtered.fam"),
         col_names = c("FID", "IID", "FIID", "MIID", "sex", "phenotype"), delim = " ") %>%
  mutate(Library = gsub(".g.vcf", "", IID)) %>% 
  separate(Library, paste0("X", 1:7), "[:punct:]", remove = F, convert = T) %>%
  dplyr::rename(IdGenetic = X4, Lane = X5, Label = X3) %>% 
  left_join(trees)
trees <- left_join(trees, 
                   src_sqlite(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/",
                                        "trees", "Paracou.sqlite")) %>% 
                     tbl("Paracou") %>% 
                     filter(CensusYear == 2015) %>% 
                     collect())
trees <- left_join(trees, 
                   read_tsv(file.path(path, "..", "variants", "final", "filtered.kmeans")), 
                   by = c("IID" = "Sample"))
treesXY <- trees
coordinates(treesXY) <- ~Xutm + Yutm
proj4string(treesXY) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
treesXY <- spTransform(treesXY, CRSobj = crs)
wetness <- raster(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/", 
                            "topography", "TWI_1m.tif"))
dem <- raster(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/",
                        "topography", "DEM_1m_2015.tif")) # for CRS
projection(wetness) <- projection(dem)
wetness <- projectRaster(wetness, crs = crs)
trees$TWI <- raster::extract(wetness, treesXY)
relele <- raster(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/", 
                            "topography", "RelativeElevation_1m.tif"))
projection(relele) <- projection(dem)
trees$RE <- raster::extract(relele, treesXY)
rm(dem, wetness, treesXY)
cl <- parallel::makeCluster(getOption("cl.cores", 4))
parallel::clusterExport(cl, list("trees"))
NC <- parallel::parLapply(cl, 1:nrow(trees), function(ind){
  library(tidyverse)
  src_sqlite(file.path("../../../data/Paracou/", "trees", "Paracou.sqlite")) %>% 
    tbl("Paracou") %>% 
    filter(Plot == local(trees$Plot[ind])) %>% 
    filter(idTree != local(trees$idTree[ind])) %>% 
    mutate(dij = sqrt((local(trees$Xutm[ind]) - Xutm)^2+(local(trees$Yutm[ind]) - Yutm)^2)) %>% 
    filter(dij < 20) %>% 
    mutate(con = ifelse(Genus == local(trees$Genus[ind]) && Species == local(trees$Species[ind]), 1, 0)) %>% 
    mutate(DBH = CircCorr/pi) %>% 
    collect() %>% 
    group_by(CensusYear) %>% 
    summarise(NCI = sum(DBH*DBH*exp(-0.25*dij))) %>% 
    ungroup() %>% 
    summarise(idTree = local(trees$idTree[ind]),
              NCI = mean(NCI))})
parallel::stopCluster(cl) ; rm(cl)
NC <- bind_rows(NC)
trees$NCI <- NC$NCI
rm(NC)
save(trees, file = "./parvicapture_save/Env.Rdata")
```

## Genetic variance

We found a significant effect on the genotype on NCI, RE, and TWI. And population had a stronger effect on RE (13%) tahn TWI (6%). Nevertheless, residual variation remains high (73-88%).

```{r EnvMdata}
ids <- read_tsv(file.path(path, "..", "variants", "final", "filtered.king.id"))
K <- read_tsv(file.path(path, "..", "variants", "final", "filtered.king"),
              col_names = ids$IID) %>% 
  as.data.frame()
row.names(K) <- ids$IID
K <- as.matrix(K) 
K[is.na(K)] <- 0
K[K < 0] <- 0
K <- K*2
K <- as.matrix(Matrix::nearPD(K)$mat)
subtrees <- trees
rownames(subtrees) <- subtrees$IID
subtrees <- subtrees[row.names(K),]
mdata <- lapply(c("TWI", "RE", "NCI"), function(variable) {
  return(list(N = nrow(subtrees),
              P = 3,
              y = as.vector(scale(subtrees[variable], center = F)),
              population = subtrees$cluster,
              K = K))})
names(mdata) <- c("TWI", "RE", "NCI")
mdata$RE$y <- mdata$RE$y + 1 # for the lognormal
save(mdata, file = file.path("parvicapture_save", 'dataEnv.Rdata'))   
```

```{bash envGeno2Cluster, eval=F}
vars=(TWI RE NCI)
for var in "${vars[@]}" ; do for chain in $(seq 8) ; do echo "module purge ; module load compiler/gcc-7.2.0 ; module load system/R-3.5.3 ; R_LIBS_USER=\" \" Rscript EnvGeno2.R $chain $var" ; done ; done > EnvGeno2.sh
sarray -J Env2 -o out/%j.Env2.out -e out/%j.Env2.err -t 48:00:00 --constraint=broadwell --cpus-per-task=1 --mail-type=BEGIN,END,FAIL EnvGeno2.sh
tail -n 1 out/*.Env2.out | grep Iteration
```

```{r envGeno2Tab, fig.cap="Genetic variance of individual growth potential with a lognormal animal model."}
fitEnv <- list(TWI = list(), NCI = list(), RE = list())
for(var in c("TWI", "NCI", "RE")){
  for(sim in list.files("parvicapture_save/EnvGeno2", 
                        pattern = var, full.names = T)){
    load(sim)
    fitEnv[[var]] <- c(fitEnv[[var]], fit)
  }
}
fitEnv <- lapply(fitEnv, sflist2stanfit)
lapply(fitEnv, broom::tidyMCMC, c("mu", "Vp", "Vg", "Vr"), 
       droppars = NULL, rhat = T) %>% 
  bind_rows(.id = "Variable") %>% 
  separate(term, c("parameter", "population"), "[:punct:]", convert = T) %>% 
  mutate(population = ifelse(is.na(population), "", population)) %>% 
  kable(caption = "Summary table of the kinship growth model",
        col.names = c("Variable", "Parameter",  "Population",  
                      "Estimate", "$\\sigma$", "$\\hat{R}$"))
```

```{r envGeno2Trace, fig.cap="Traceplot for environmental variables."}
cowplot::plot_grid(plotlist = lapply(fitEnv, mcmc_trace, 
                                     regex_pars = c("Vp", "Vg", "Vr"), 
                                     facet_args = list(nrow = 1)),
                   nrow = 3, labels = names(fitEnv))   
```

```{r envgeno2R2, fig.cap="R2 for environmental variable"}
lapply(fitEnv, pars = c("Vp", "Vg", "Vr"), as.data.frame) %>% 
  bind_rows(.id = "model") %>% 
  rowwise() %>% 
  mutate(Vtot = sum(c(Vp, Vg, Vr))) %>% 
  mutate(Vexp = sum(c(Vp, Vg))) %>% 
  mutate_at(c("Vp", "Vg", "Vexp"), funs(./Vtot)) %>% 
  dplyr::select(-Vtot, -Vr) %>% 
  reshape2::melt(id.vars = "model") %>% 
  group_by(model, variable) %>% 
  summarise(q5 = quantile(value, 0.05),
            q25 = quantile(value, 0.25),
            mean = mean(value),
            median = median(value),
            sd = sd(value),
            q75 = quantile(value, 0.75),
            q95 = quantile(value, 0.95)) %>% 
    mutate(variable = recode_factor(variable, 
                           "Vexp" = "Marginal", "Vg" = "Genotype", 
                           "Vp" = "Population")) %>% 
  ggplot(aes(x = variable, xend = variable, col = variable)) +
  geom_point(aes(y = median), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = q5, yend = q95),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = q25, yend = q75), size = 2, alpha = 0.5) +
  ylab(expression(R^2)) +  
  theme(axis.title.y = element_blank()) +
  facet_wrap(~ model, nrow = 3) +
  coord_flip()   
```

```{r envGeno2VarPart, fig.cap="Genetic variance partitionning for environmental variables."}
lapply(fitEnv, mcmc_intervals_data, regex_pars = c("Vp", "Vg", "Vr")) %>% 
  bind_rows(.id = "variable") %>% 
  mutate(parameter = recode(parameter, "Vp" = "Population", "Vg" = "Genotype", "Vr" = "Residual")) %>% 
  group_by(variable) %>%
  mutate(pct = paste0(round(m / sum(m) * 100), "%")) %>%
  ggplot(aes(x = variable, fill = parameter)) +
  geom_col(aes(y = m)) +
  geom_text(aes(y = m, label = pct), col = "white", position = position_stack(vjust = .5)) +
  facet_wrap(~ variable, scales = "free") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.line.x = element_blank(), axis.ticks.x = element_blank()) +
  scale_fill_discrete(expression(sigma^2))   
```

```{r aTWInNCI2, fig.cap="Multiplicative"}
t <- lapply(fitEnv, function(fit)
  as.data.frame(fit, "alog") %>% 
    summarise_all(median) %>% 
    reshape2::melt(NULL)) %>% 
  bind_rows(.id = "fit") %>% 
  separate(variable, c("X1", "IndNum", "X2"), convert = T) %>% 
  mutate(value = exp(value)) %>% 
  reshape2::dcast(IndNum ~ fit, value.var = "value") %>%
  cbind(mutate(trees, DBH = CircCorr/pi) %>% 
          dplyr::select(DBH, cluster, TWI, NCI, RE) %>% 
          dplyr::rename(TWI.var = TWI, NCI.var = NCI, RE.var = RE, pop = cluster)) %>% 
  dplyr::rename(TWI.a = TWI, NCI.a = NCI, RE.a = RE) %>% 
  mutate(pop = as.factor(pop))
reshape2::melt(t, id.vars = c("IndNum", "pop", "DBH", "NCI.a", "RE.a", "TWI.a"), 
               variable.name = "variable", value.name = "variable.value") %>% 
  reshape2::melt(id.vars = c("IndNum", "pop", "DBH", "variable", "variable.value"), 
               variable.name = "genetic", value.name = "genetic.value") %>% 
  mutate(variable = gsub(".var", "", variable)) %>% 
  mutate(genetic = gsub(".a", "", genetic)) %>% 
  filter(variable == genetic) %>% 
  ggplot(aes(variable.value, genetic.value, col = pop, size = DBH)) +
  geom_point() +
  facet_wrap(~ variable, scales = "free") +
  geom_hline(yintercept = 1, linetype = "dashed", col = "lightgrey") +
  geom_point(alpha = 0.4) +
  scale_size_continuous("DBH 2017") +
  scale_color_manual(guide = "none", values = c("#1E90FF", "#0000EE", "#CD2626")) +
  xlab("Variable vlaue") + ylab("Genetic multiplicative value")
dplyr::select(t, TWI.a, RE.a, NCI.a) %>% 
  cor %>% 
  corrplot::corrplot.mixed()
```
