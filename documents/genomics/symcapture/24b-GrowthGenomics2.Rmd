---
output: html_document
editor_options: 
  chunk_output_type: inline
---
```{r setup_growthgenom2, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(raster)
library(bayesplot)
library(rstan)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = F, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "~/Documents/BIOGECO/PhD/data/Symphonia_Paracou/Sequences/populationGenomics/"
S_sqrt_trans <- function() scales::trans_new("S_sqrt",
                                             function(x) sign(x)*sqrt(abs(x)),
                                             function(x) x^2*sign(x))
load("./symcapture_save/Env2.Rdata")  
# load(file.path("symcapture_save", 'AnimalModels.Rdata'))
```

# Growth genomics 2

```{r mdata2}
load("./symcapture_save/Env2.Rdata")  
trees <- trees %>% 
  na.omit(pop) %>% # remove admixed
  group_by(Ind) %>% 
  mutate(Y0 = first(CensusYear), DBH0 = first(DBH), DBHtoday = last(DBH)) %>% 
  ungroup() %>% 
  dplyr::select(Ind, IID, pop, Plot, SubPlot, TreeFieldNum, Y0, DBH0, DBHtoday) %>% 
  unique() %>% 
  # filter(Y0 != 2017) %>% 
  # filter((DBH0 - DBHtoday) != 0) %>% 
  mutate(IndNum = as.numeric(as.factor(Ind)), popNum = as.numeric(as.factor(pop))) 
treesSub <- filter(trees, Plot == 16) %>% # for test purposes
  mutate(IndNum = as.numeric(as.factor(Ind)), popNum = as.numeric(as.factor(pop)))
fam <- read_delim(file.path(path, "gemma", "Gmax0", "paracou3pop.fam"), delim = " ", 
                  col_names = c("FID", "IID", "PAT", "MAT", "SEX", "PHENOTYPE"))
K <- read_tsv(file.path(path, "gemma", "Gmax0", "paracou3pop.kinship.sXX.txt"), 
              col_names = fam$IID) %>% 
  mutate(IID = fam$IID) %>% 
  column_to_rownames(var = "IID") %>% 
  as.matrix()
mdata <- function(data){
  list(I = nrow(data),
       Y = 2017 - min(data$Y0) + 1,
       P = length(unique(data$popNum)),
       years = min(data$Y0):2017,
       DBH0 = data$DBH0,
       Y0 = data$Y0,
       DBHtoday = data$DBHtoday,
       ind = data$IndNum,
       pop = data$popNum,
       K = dplyr::select(data, IID, IndNum) %>% arrange(IndNum) %>% 
         dplyr::select(IID) %>% unlist() %>% K[.,.],
       L = c(0, 0, 0), 
       U = c(2, 200, 1)
       )
}
```

## Growth & Ontogeny

$$DBH_{today,p,i} \sim \mathcal N (DBH_{t0}+\sum_{y=y0+1}^{y=today}AGR(DBH_{y-1,p,i}, \sigma)$$

$$AGR_{t,y,i} = \theta1_i.exp(-\frac12.[\frac{log(\frac{DBH_{y-1,p,i}}{\theta2_i})}{\theta3_i}]^2)\mid \forall \theta, \theta_i \sim \mathcal N (\theta_p, \sigma^2_{R_{\theta}})$$

```{r growthOntogenyTab3}
# growth <- stan_model("./symcapture_models/Growth5.stan")
# fitGrowth <- sampling(growth, chains = 2, 
#                       control = list(adapt_delta = 0.99, max_treedepth = 12),
#                       include = F, pars = c("DBH", "Gmaxi", "Dopti", "Ksi"), 
#                       data = mdata(trees))
# save(fitGrowth, file = file.path("symcapture_save", 'growth4.Rdata'))
load(file.path("symcapture_save", 'growth4.Rdata'))
mcmc_trace(fitGrowth)
broom::tidyMCMC(fitGrowth, droppars = NULL, rhat = T) %>% kable()
```
                
## Growth & Kinship

$$log(AGR_{y,p,i}+1) \sim \mathcal N (Gmax_i.exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{Dopt_i})}{Ks_i}]^2), \sigma^2)$$
$$\mid \forall \theta \in \begin{bmatrix} Gmax \\ Dopt \\ Ks \end{bmatrix}, \begin{align} \theta_i \sim \mathcal N (\theta_p + a_{\theta}, \sigma^2_{R_{\theta}})  \\ a_{\theta} \sim \mathcal{MVN} (0, \sigma^2_{G_{\theta}}.K) \end{align}$$

### Subset

```{r growthKinshipTab3sub}
# growth <- stan_model("./symcapture_models/GrowthAnimal3.stan")
# fitGrowthKin <- sampling(growth, chains = 2, save_warmup = F,
#                          control = list(adapt_delta = 0.99, max_treedepth = 12), data = mdata(treesSub))
# save(fitGrowthKin, file = file.path("symcapture_save", 'growthkin4sub.Rdata'))
load(file.path("symcapture_save", 'growthkin4sub.Rdata'))
broom::tidyMCMC(fitGrowthKin, c("theta", "sigmaR", "sigmaG", "sigma", "R2m", "R2c", "lp__"), droppars = NULL, rhat = T) %>% kable() 
```

```{r}
load(file.path("symcapture_save", 'growthkin4sub.Rdata')) 
mcmc_trace(as.array(fitGrowthKin, pars = c("theta", "sigmaG", "sigmaR", "sigma")))
# mcmc_pairs(as.array(fitGrowthKin, pars = c("theta")))
```

### Full

```{r growthKinshipTab3}
# growth <- stan_model("./symcapture_models/GrowthAnimal3.stan")
# fitGrowthKin <- sampling(growth, chains = 2, save_warmup = F,
#                          control = list(adapt_delta = 0.99, max_treedepth = 12), data = mdata(trees))
# save(fitGrowthKin, file = file.path("symcapture_save", 'growthkin4.Rdata'))
load(file.path("symcapture_save", 'growthkin4.Rdata'))
broom::tidyMCMC(fitGrowthKin, c("theta", "sigmaR", "sigmaG", "sigma", "R2m", "R2c", "lp__"), droppars = NULL, rhat = T) %>% kable() 
```

```{r}
mcmc_trace(as.array(fitGrowthKin, pars = c("theta", "sigmaG", "sigmaR", "sigma"))) 
mcmc_pairs(as.array(fitGrowthKin, pars = c("sigmaG")))
```

```{r growthKinshipG31, fig.cap="Ontogenetic parameters R2 (marginal and conditional."}
mcmc_intervals_data(fitGrowthKin, regex_pars = c("R2")) %>% 
  separate(parameter, c("index", "parameter"), "[:punct:]") %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax", "2" = "Dopt", "3" = "Ks")) %>% 
  mutate(index = recode(index, "R2m" = "Marginal", "R2c" = "Conditional")) %>%
  ggplot(aes(x = index, xend = index, col = parameter, fill = parameter)) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  facet_wrap(~ parameter, labeller = label_parsed) +
  xlab("") + ylab(expression(R^2)) + 
  scale_fill_discrete(guide = "none") +
  scale_color_discrete(guide = "none")  
```
                              
### Parameters

$$\mid \forall \theta \in \begin{bmatrix} Gmax \\ Dopt \\ Ks \end{bmatrix}, \begin{align} \theta_i \sim \mathcal N (\theta_p + a_{\theta}, \sigma^2_{R_{\theta}})  \\ a_{\theta} \sim \mathcal{MVN} (0, \sigma^2_{G_{\theta}}.K) \end{align}$$

```{r}
parameters <- as.data.frame(fitGrowth, pars = "thetai") %>% 
  reshape2::melt(NULL, variable.name = "parameter") %>% 
  separate(parameter, c("theta", "parameter", "IndNum"), sep = "[:punct:]", convert = T) %>% 
  dplyr::select(-theta) %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax",  "2" = "Dopt", "3"= "Ks")) %>% 
  group_by(parameter, IndNum) %>% 
  summarise_all(mean) %>% 
  ungroup() %>% 
  left_join(dplyr::select(trees, IID, IndNum, popNum) %>% unique())

mdataPar <- function(par) {
  parameter <- filter(parameters, parameter == par)
    list(N = nrow(parameter), 
         P = max(parameter$popNum), 
         Y = parameter$value, 
         population = parameter$popNum, 
         K = dplyr::select(parameter, IID, IndNum) %>% 
           unique() %>% arrange(IndNum) %>% 
           dplyr::select(IID) %>% unlist() %>% K[.,.])}

# animal <- stan_model("./symcapture_models/Animal.stan")
# fitAnimal <- lapply(c("Gmax", "Dopt", "Ks"), function(par)
#   sampling(animal, chains = 2, save_warmup = F,
#            control = list(adapt_delta = 0.99, max_treedepth = 12), data = mdataPar(par)))
# names(fitAnimal) <- c("Gmax", "Dopt", "Ks")
# save(fitAnimal, file = file.path("symcapture_save", 'growthkin5.Rdata'))
load(file.path("symcapture_save", 'growthkin5.Rdata'))
lapply(fitAnimal, broom::tidyMCMC, pars = c("sigmaG", "sigmaR", "R2m", "R2c"), droppars = NULL, rhat = T) %>% 
  bind_rows(.id = "parameter") %>% kable() 
```

```{r}
cowplot::plot_grid(plotlist = lapply(fitAnimal, function(fit) 
  mcmc_trace(as.array(fit, pars = c("sigmaG", "sigmaR")))), 
  labels = names(fitAnimal), nrow = 3)
```

```{r}
cowplot::plot_grid(plotlist = lapply(fitAnimal, function(fit) 
  mcmc_intervals(fit, regex_pars = c("R2")) ), 
  labels = names(fitAnimal))
```
