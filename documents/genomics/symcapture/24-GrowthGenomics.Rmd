```{r setup_growthgenom, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(raster)
library(bayesplot)
library(rstan)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
path <- "~/Documents/BIOGECO/PhD/data/Symphonia_Paracou/Sequences/populationGenomics/"
pathCluster <- "~/Remotes/genotoul/work/PhD/documents/genomics/symcapture"
S_sqrt_trans <- function() scales::trans_new("S_sqrt",
                                             function(x) sign(x)*sqrt(abs(x)),
                                             function(x) x^2*sign(x))
```

# Growth genomics

We explored and selected ontogenic and environmental descriptors to be used in the annual growth rate model. We then built four growth model with growing complexity including ontogeny, environment, kinship and population effects. We finally compared growth models and derived growth parameters to be used in association genomics for mono- and poly-genic signals. 

## Variables

```{r DataGrowthGenom}
trees <- src_sqlite(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/",
                              "trees", "Paracou.sqlite")) %>% 
  tbl("Paracou") %>% 
  filter(Genus == "Symphonia") %>% 
  mutate(DBH = CircCorr/pi) %>% 
  collect()
trees <- read_tsv(file.path(path, "..", "variantCalling", "paracou",
                          "symcapture.all.biallelic.snp.filtered.nonmissing.paracou.fam"),
         col_names = c("FID", "IID", "FIID", "MIID", "sex", "phenotype")) %>% 
  mutate(Ind = gsub(".g.vcf", "", IID)) %>% 
  mutate(X = gsub("P", "", Ind)) %>% 
  separate(X, c("Plot", "SubPlot", "TreeFieldNum"), convert = T) %>% 
  left_join(trees) %>% 
  left_join(read_tsv(file.path(path, "bayescenv", "paracou3pop.popmap"),
                     col_names = c("IID", "pop"))) %>% 
  left_join(read_tsv(file.path(path, "populations", "paracou.hybridmap")),
            by = "Ind", suffix = c("", ".hybrid"))
trees0 <- trees
trees <- trees %>% 
  group_by(Ind) %>% 
  mutate(Y0 = dplyr::first(CensusYear), DBH0 = dplyr::first(DBH), 
         DBHtoday = dplyr::last(DBH), N = n()) %>%  
  ungroup() %>% 
  dplyr::select(Ind, IID, pop, Plot, SubPlot, TreeFieldNum, Y0, DBH0, DBHtoday, N) %>% 
  unique()
save(trees, file = "./symcapture_save/Env2.Rdata")
```

```{r mdata}
trees <- trees %>% 
  na.omit(pop) %>% # remove admixed
  mutate(IndNum = as.numeric(as.factor(Ind)), popNum = as.numeric(as.factor(pop)))
fam <- read_delim(file.path(path, "gemma", "Gmax0", "paracou3pop.fam"), delim = " ", 
                  col_names = c("FID", "IID", "PAT", "MAT", "SEX", "PHENOTYPE"))
K <- read_tsv(file.path(path, "..", "variantCalling", "paracou",
                        "out.relatedness2"))  %>% 
  reshape2::dcast(INDV1 ~ INDV2, value.var = "RELATEDNESS_PHI") %>% 
  column_to_rownames("INDV1") %>% 
  as.matrix()
model_data <- function(data) {
  K <- K[trees$IID, trees$IID]
  K[K < 0] <- 0
  K <- K*2
  K <- as.matrix(Matrix::nearPD(K)$mat)
  list(I = nrow(data),
       Y = 2017 - min(data$Y0) + 1,
       P = length(unique(data$popNum)),
       years = min(data$Y0):2017,
       DBH0 = data$DBH0,
       Y0 = data$Y0,
       DBHtoday = data$DBHtoday + 10^-6,
       ind = data$IndNum,
       pop = data$popNum,
       K = K,
       L = c(0, 10, 0.1), 
       U = c(5, 100, 1.5))
}
```

## Growth & Ontogeny

We used the following form of hierachical model to model DBH increasqe between DBH today $DBH_{y=today}$ and DBH at recruitment $DBH_{y=y0,p,i}$ for individual $i$ in population $p$:

$$DBH_{y=today,p,i} - DBH_{y=y0,p,i} \sim \mathcal{logN} (\sum _{y=y_0} ^{y=today} Gmax_i.exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{Dopt_i})}{Ks_i}]^2), \sigma)$$
$$\mid \forall \theta \in [Gmax, Dopt,Ks], \theta_i \sim \mathcal N (\theta_p, \sigma^2_{R_{\theta}})$$

with $Gmax$, $Dopt$ and $Ks$ the parameters of the growth response to ontgeny representing respectively the maximum growth potential, the optimal growth diameter when this potential is reached, and the kurtosis of the growth curve respectivelly. Ontogenic parameters were defined at the individual level $i$ as random effects centered on the population level $p$ parameters with associated individual variance $\sigma^2_R$.

At the population level, *Symphonia* individuals showed a maximum growth potential of $3.7 - 6.1 ~mm.yr^{-1}$ at optimal diameter of $16-30~cm$ with a kurtosis of $0.83-1.21$ (Tab. \@ref(tab:growthOntogenyTab)). All parameters showed significant (not optimal diameter) variation at the individual level within populations ($\pm0.3~mm.yr^{-1}$, $\pm53~cm$, and $\pm0.3$ for maximum growth, optimal diameter and kurtosis respectively).

```{r growthOntogenyTab}
# mdata <- model_data(trees)
# growth <- stan_model("symcapture_models/Growth.stan")
# fitGrowth <- sampling(growth, chains = 2, data = mdata, save_warmup = F,
#                        control = list(adapt_delta = 0.9, max_treedepth = 12),
#                        include = F, pars = c("DBH", "theta_raw", "thetai_raw", "sigmaR_raw"))
# save(mdata, fitGrowth, file = file.path("symcapture_save", "growthPar.Rdata"))
load(file.path("symcapture_save", 'growthPar.Rdata'))
broom::tidyMCMC(fitGrowth, pars = c("theta", "sigmaP", "sigmaR", "sigma", "R2", "lp__"), 
                droppars = NULL, rhat = T) %>% 
  separate(term, c("parameter", "population", "ontogeny"), sep = "[:punct:]") %>% 
  mutate(ontogeny = ifelse(ontogeny == "", population, ontogeny)) %>% 
  mutate(population = ifelse(parameter != "theta", NA, population)) %>% 
  mutate(ontogeny = recode(ontogeny, "1" = "Gmax", "2" = "Dopt", "3" = "Ks")) %>% 
  mutate(population = recode(population, "1" = "S. globulifera type Paracou", "2" = "S. globulifera type Regina", 
                             "3" = "S. sp1")) %>% 
  mutate(parameter = recode(parameter, "theta" = "$\\theta$", "sigmaP" = "$\\sigma_{Population}$",
                            "sigmaR" = "$\\sigma_{Residual}$", "sigma" = "$\\sigma$", "R2" = "$R^2$",
                            "lp" = "loglikelihood")) %>% 
  mutate_at(c("population", "ontogeny"), funs(ifelse(is.na(.), "", .))) %>% 
  arrange(ontogeny, parameter, population) %>% 
  dplyr::select(ontogeny, parameter, population, estimate, std.error, rhat) %>% 
  kable(caption = "Summary table of the ontogenic growth model",
        col.names = c("Ontogenetic parameter", "Parameter", "Population", "Estimate", "$\\sigma$", "$\\hat{R}$"))
opts_chunk$set(eval = F)
# mcmc_trace(fitGrowth)
```

```{r predgrowth, eval=F}
pars <- as.data.frame(fitGrowth, pars = "thetai") %>% 
  reshape2::melt(NULL) %>% 
  group_by(variable) %>% 
  summarise(l = quantile(value, 0.05), m = mean(value), u = quantile(value, 0.95)) %>% 
  separate(variable, c("variable", "IndNum", "parameter"), convert = T) %>% 
  dplyr::select(-variable) %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax", "2" = "Dopt", "3" = "Ks")) %>% 
  left_join(dplyr::select(trees, IndNum, Ind))
pred <- matrix(nrow = nrow(trees), ncol = 2017-1984+1)
row.names(pred) <- trees$Ind
colnames(pred) <- 1984:2017
for(t in 1:(ncol(pred)-1)) {
    pred[trees$Y0 == colnames(pred)[t],t] <- trees$DBH0[trees$Y0 == colnames(pred)[t]]
    pred[,t+1] <- unlist(pred[,t] + pars[pars$parameter == "Gmax","m"]*
      exp(-0.5*(log(pred[,t]/pars[pars$parameter == "Dopt","m"])/
                  pars[pars$parameter == "Ks","m"])^2))
}
pred <- as.data.frame(pred) %>% 
  rownames_to_column("Ind") %>% 
  reshape2::melt(id.vars = "Ind", variable.name = "Year", value.name = "DBHp") %>% 
  mutate(Year = as.numeric(as.character(Year)))
trees0 %>% 
  rename(Year = CensusYear, DBHo = DBH) %>% 
  left_join(pred) %>% 
  filter(Plot == 3) %>% 
  # filter(Ind == sample(trees$Ind, 20)) %>% 
  ggplot(aes(x = Year)) +
  geom_point(aes(y = DBHo), alpha = 0.5) +
  geom_line(aes(y = DBHp), col = "red", lwd = 1.2) +
  facet_wrap(~ Ind, scales = "free_y")
```

## Growth & Genotype

The kinship matrix express individuals genetic covariation an can help assess the role of genetic variation in individual response to growth. We used the following form of hierachical model to model DBH today $DBH_{y=today}$ with Diameter at Breast Height $DBH_{y,p,i}$  and individuals Kinsip matrix $K$ at year $y\in[y_0,today]$ for individual $i$ in population $p$:

$$DBH_{y=today,p,i} \sim \mathcal{logN} (DBH_0 + \sum _{y=y_0} ^{y=today} Gmax_i.exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{Dopt_i})}{Ks_i}]^2), \sigma)$$
$$\mid \forall \theta \in [Gmax, Dopt,Ks], \theta_i \sim \mathcal N (\theta_p+A.a_\theta, \sigma^2_{R_{\theta}}),a_\theta\sim\mathcal N(0,\sigma_{G_\theta})$$

with $Gmax$, $Dopt$ and $Ks$ the parameters of the growth response to ontgeny representing respectively the maximum growth potential, the optimal growth diameter when this potential is reached, and the kurtosis of the growth curve respectivelly. Ontogenic parameters were defined at the individual level $i$ as random effects centered on the sum of population level $p$ parameters and additive gentic variance $a_{theta}$ with associated individual variance $\sigma_R$. Parameter additive gentic variance $a_{theta}$ follow a multivariate normal law centered on 0 of covariance $\sigma_G K$.

Growth response to ontogeny didn't change compared to the previous paragraph, and won't be discussed here. For the three ontogenetic parameters ($Gmax$, $Dopt$, and $Ks$), most of the variability was explained by the population (ca 50%) and around 30% of the remaining variability was explained by the genotype (Tab. \@ref(tab:growthKinshipTab) and Fig. \@ref(fig:growthKinshipG1) and \@ref(fig:growthKinshipG1)). Growth parameters were more differentiated between population than random genetic variation ($Qst >> Fst$). These results highlights a strong local adptation with *Symphonia*.

```{r growthGeno}
# mdata <- model_data(trees)
# growthgeno <- stan_model("symcapture_models/GrowthGeno.stan")
# fitGrowthGeno <- sampling(growthgeno, chains = 2, data = mdata, save_warmup = F,
#                           control = list(adapt_delta = 0.9, max_treedepth = 12),
#                           include = F, pars = c("DBH", "theta_raw", "thetai_raw", "a_raw",
#                                                 "sigmaR_raw", "sigmaG_raw", "thetai", "a"))
# save(mdata, fitGrowthGeno, file = file.path("symcapture_save", "growthgenoPar.Rdata"))
load(file.path("symcapture_save", 'growthgenoPar.Rdata'))
```


```{r growthKinshipTab, eval=F}
broom::tidyMCMC(fitGrowthGeno, c("theta", "sigmaP", "sigmaG", "sigmaR", 
                                 "sigma", "lp__"), droppars = NULL, rhat = T) %>% 
  separate(term, c("parameter", "population", "ontogeny"), sep = "[:punct:]") %>% 
  mutate(ontogeny = ifelse(ontogeny == "", population, ontogeny)) %>% 
  mutate(population = ifelse(parameter != "theta", NA, population)) %>% 
  mutate(ontogeny = recode(ontogeny, "1" = "Gmax",  "2" = "Dopt", "3" = "Ks")) %>% 
  mutate(population = recode(population, "1" = "S. globulifera type Paracou", "2" = "S. globulifera type Regina", 
                             "3" = "S. sp1")) %>% 
  mutate(parameter = recode(parameter, "sigmaP" = "$\\sigma_P$", "sigmaG" = "$\\sigma_G$", "sigmaR" = "$\\sigma_R$", 
                            "sigma" = "$\\sigma$", "lp" = "loglikelihood", "theta" = "$\\theta$")) %>% 
  mutate_at(c("population", "ontogeny"), funs(ifelse(is.na(.), "", .))) %>% 
  arrange(ontogeny, parameter, population) %>% 
  dplyr::select(ontogeny, parameter, population, estimate, std.error, rhat) %>% 
  kable(caption = "Summary table of the ontogenic growth model",
        col.names = c("Ontogenetic parameter", "Parameter", "Population", "Estimate", "$\\sigma$", "$\\hat{R}$"))
```

```{r predgrowthgeno, eval=F}
Gmax <- c(0.8064037,	0.9498348,	0.5231761)
Dopt <-	c(27.4856024,	31.1377830,	25.9439725)
Ks <- c(0.5460768,	0.5099998, 0.6050797)
DBHnew <- function(DBHold, popNum,
                   Gmax = c(0.8064037,	0.9498348,	0.5231761),
                   Dopt = c(27.4856024,	31.1377830,	25.9439725), 
                   Ks = c(0.5460768,	0.5099998, 0.6050797))
  DBHold + Gmax[popNum]*exp(-0.5*(log(DBHold/Dopt[popNum])/Ks[popNum])^2)
pred <- matrix(nrow = nrow(trees), ncol = 2017-1984+1)
row.names(pred) <- trees$Ind
colnames(pred) <- 1984:2017
for(t in 1:(ncol(pred)-1)) {
    pred[trees$Y0 == colnames(pred)[t],t] <- trees$DBH0[trees$Y0 == colnames(pred)[t]]
    pred[,t+1] <- DBHnew(pred[,t], trees$popNum)
}
pred <- as.data.frame(pred) %>% 
  rownames_to_column("Ind") %>% 
  reshape2::melt(id.vars = "Ind", variable.name = "Year", value.name = "DBHp") %>% 
  mutate(Year = as.numeric(as.character(Year)))
trees0 %>% 
  rename(Year = CensusYear, DBHo = DBH) %>% 
  left_join(pred) %>% 
  filter(Plot == 3) %>% 
  ggplot(aes(x = Year)) +
  geom_point(aes(y = DBHo), alpha = 0.5) +
  geom_line(aes(y = DBHp, group = Ind), col = "red", lwd = 1.2) +
  facet_wrap(~ Ind, scales = "free_y")
```

```{r, eval=F}
load(file.path("symcapture_save", 'growthkin2.Rdata'))
mcmc_trace(as.array(fitGrowthGeno, pars = c("theta", "sigmaG", "sigmaR", "sigma")))
# mcmc_pairs(as.array(fitGrowthKin, pars = c("Gmaxg", "Doptg", "Ksg")))
```

```{r growthKinshipG1, fig.cap="Heritability $h^2$, broad heritability $h_p^2$ and trait differentiation $Qst$ for ontogenetic parameters.", eval=F}
mcmc_intervals_data(fitGrowthGeno, regex_pars = c("R2")) %>% 
  separate(parameter, c("index", "parameter"), "[:punct:]") %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax", "2" = "Dopt", "3" = "Ks")) %>% 
  mutate(index = recode(index, "R2m" = "marginal", "R2c" = "conditionnal")) %>% 
  ggplot(aes(x = index, xend = index, col = parameter, fill = parameter)) +
  geom_point(aes(y = m), shape = 21, size = 3, alpha = 0.5) +
  geom_segment(aes(y = ll, yend = hh),
               size = 1, show.legend = F, alpha = 0.5) +
  geom_segment(aes(y = l, yend = h), size = 2, alpha = 0.5) +
  facet_wrap(~ parameter, labeller = label_parsed) +
  xlab("") + ylab(expression(R^2)) + 
  scale_fill_discrete(guide = "none") +
  scale_color_discrete(guide = "none")
```

```{r growthKinshipG2, fig.cap="Genetic variance partitionning for ontogenetic parameters.", eval=F}
mcmc_intervals_data(fitGrowthGeno, regex_pars = c("sigmaP", "sigmaG", "sigmaR")) %>%
  separate(parameter, c("sigma", "parameter"), "[:punct:]") %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax", "2" = "Dopt", "3" = "Ks")) %>% 
  mutate(sigma = recode(sigma, "sigmaP" = "Population", "sigmaG" = "Genotype", "sigmaR" = "Residual")) %>% 
  mutate(sigma = factor(sigma, levels = c("Population", "Genotype", "Residual"))) %>% 
  group_by(parameter) %>% 
  mutate(pct = paste0(round(m / sum(m) * 100), "%")) %>% 
  ggplot(aes(x = parameter, fill = sigma)) +
  geom_col(aes(y = m)) +
  geom_text(aes(y = m, label = pct), col = "white", position = position_stack(vjust = .5)) +
  facet_wrap(~ parameter, scales = "free") +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_blank(), axis.line.x = element_blank(), axis.ticks.x = element_blank()) +
  scale_fill_discrete(expression(sigma^2))
```

## Associations

SNP association to growth parameters have been assessed on growth parametrs per individual ($Gmax_i$, $Dopt_i$, $Ks_i$) with mono- and poly-genic modelling (respectivelly LMM and BSLMM, see methods in environmental genomics). Both mono- and poly-genic modelling didn't detected any significant SNP (Fig. \@ref(fig:growthMLM) and \@ref(fig:growthBSLMM)), at the exception of one neutral SNPs for $Dopt$. Moreover, polygenic modelling with bayesian sparse linear mixed models (BSLMM) didn't converged due to a small number of individuals (Fig. \@ref(fig:growthBSLMMConvergence)).

```{bash Gemma, eval=F, echo=T}
module load bioinfo/plink-v1.90b5.3
module load bioinfo/gemma-v0.97
cat paracou3pop.popmap | awk '{print"0\t"$1"\t0\t0\t0\t-9"}' > paracou3pop.fam
for par in $(seq 1 3) ; do plink \
  --bfile ../../../variantCalling/paracou3pop/symcapture.all.biallelic.snp.filtered.nonmissing.paracou3pop \
  --allow-extra-chr --keep paracou3pop.fam \
  --extract ../../../variantCalling/paracou3pop/LD.prune.in \
  --maf 0.05 --pheno growth.phenotype --mpheno $par --out paracou3pop.$par --make-bed ; done
gemma -bfile paracou3pop.1 -gk 1 -o kinship
for par in $(seq 1 3) ; do  gemma -bfile paracou3pop.$par -k output/kinship.cXX.txt -lmm 1 -o LMM.$par ; done
for par in $(seq 1 3) ; do  gemma -bfile paracou3pop.$par -k -bslmm 1  -o BSLMM.$par & done
```

```{r growthMLM, fig.cap="q-value of major effect SNPs associated to individual growth parameters. SNP were detected using linear mixed models (LMM) with individual kiniship as random effect. SNP significance was assessed with Wald test. q-value was obtained correcting mutlitple testing with false discovery rate."}
opts_chunk$set(eval = T)
lapply(list.files(file.path(path, "gemma", "growth"), pattern = ".assoc.txt$", full.names = T), read_tsv)%>% 
  bind_rows(.id = "parameter") %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax",  "2" = "Dopt",  "3" = "Ks")) %>% 
  left_join(read_tsv(file.path(path, "..", "annotation", "snps.annotation")) %>%
              dplyr::rename(rs = snp)) %>% 
  mutate(qval = p.adjust(p_wald, "fdr")) %>%
  arrange(chr, ps) %>% 
  mutate(snp = 1:nrow(.)) %>% 
  na.omit(qval) %>% 
  ggplot(aes(snp, -log10(qval), label = snp, alpha = qval < 0.05, col = type)) +
  geom_hline(yintercept = 2, linetype = "dashed", col = "red") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", col = "red") +
  geom_point() +
  ylab(expression(-log[10]("q-value"))) +
  facet_wrap(~ parameter) +
  scale_alpha_discrete(guide = "none") +
  scale_y_sqrt() +
  xlab("SNP number") +
  scale_color_discrete("SNP type")
```

```{r growthBSLMMConvergence, fig.cap="Traceplot of hyper-parameters chain for Baysian Sparse Linear Mixed Model (BSLMM)."}
cowplot::plot_grid(plotlist = lapply(list.files(file.path(path, "gemma", "growth"), pattern = ".hyp.txt$", full.names = T), 
       function(file) read_tsv(file) %>% 
         dplyr::select(pge, n_gamma) %>% 
         dplyr::rename(PGE = pge, `n[gamma]` = n_gamma) %>% 
         mutate(iteration = 1:n()) %>% 
         filter(row_number() %% 100 == 0) %>% 
         dplyr::select(-iteration) %>% 
         mcmc_combo()), labels = c("Gmax", "Dopt", "Ks"), nrow = 3)  
```

```{r growthBSLMM, fig.cap="Effect of SNPs associated to individual growth parameters with a polygenic model. SNP were detected using bayesian sparse linear mixed models (BSLMM) with individual kiniship as random effect. SNP significance was assessed with the $\\gamma$ parameter and highlighted here with SNPs having at least 90% chance of having an effect on the phenotype."}
lapply(list.files(file.path(path, "gemma", "growth"), pattern = ".param.txt$", full.names = T), read_tsv) %>% 
  bind_rows(.id = "parameter") %>% 
  mutate(parameter = recode(parameter, "1" = "Gmax",  "2" = "Dopt",  "3" = "Ks")) %>% 
  left_join(read_tsv(file.path(path, "..", "annotation", "snps.annotation")) %>%
              dplyr::rename(rs = snp)) %>% 
  arrange(chr, ps) %>% 
  mutate(snp = 1:nrow(.)) %>% 
  ggplot(aes(snp, beta*gamma, label = snp, col = type, alpha = gamma > 0.5)) +
  geom_point() +
  scale_y_continuous(trans="S_sqrt") +
  facet_wrap(~ parameter) +
  ylab(expression(beta*gamma))  
```
