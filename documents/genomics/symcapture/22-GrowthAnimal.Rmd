```{r setup_growthanimal, include=FALSE}
# rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(raster)
library(bayesplot)
library(kinship2)
library(rstan)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = F, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
load("./symcapture_save/Env2.Rdata")
trees <- trees %>% 
  na.omit(pop) %>% # remove admixed
  dplyr::select(Ind, IID, pop, Plot, SubPlot, TreeFieldNum, Y0, DBH0, DBHtoday, N)
pairs_stan <- function(chain, stan_model, pars) {
  energy <- as.matrix(sapply(get_sampler_params(stan_model, inc_warmup = F), 
                             function(x) x[,"energy__"]))
  pars <- rstan::extract(stan_model, pars = pars, permuted = F)
  df <- data.frame(energy[,chain], pars[,chain,])
  names(df)[1] <- "energy"
  GGally::ggpairs(df, title = paste0("Chain", chain), 
                  lower = list(continuous = GGally::wrap("points", alpha = 0.2)))                    
} 
```

# Growth & Animal models

The aim of this document is to explore animal and growth model with generated data to validate their behavior and use it on *Symphonia* and *Eschweilera* real data. Let's consider a set of $P=2$ populations including each $Fam=3$ families composed of $I = 14$ individuals with arbitrar relationships (it's only 84 individuals to do quick tests).

```{r simkinship, fig.cap="Kinship matrix"}
simK <- function(
  P = 2, 
  Fam = 3
){
  I <- 14 # Individuals
  ped.df <- data.frame(pop = rep(1:P, each = Fam*I),
                       fam = rep(1:Fam, each = I),
                       ind = rep(1:I, Fam*P),
                       father = rep(c(NA, NA, 1, 1, 1, 1, NA, 
                                      6, 6, 6, NA, 11, 11, 11), Fam*P),
                       mother = rep(c(NA, NA, 2, 2, 2, 2, NA, 
                                      7, 7, 7, NA, 3, 3, 3), Fam*P), 
                       sex = rep(c(1, 2, 2, 3, 3, 1, 2, 3, 3, 
                                   3, 1, 3, 3, 3), Fam*P)) %>% 
    mutate_at(c("father", "mother"), funs(ifelse(!is.na(.), 
                                                 paste0(pop,fam,.), NA))) %>%
    mutate(ind = paste0(pop,fam,ind))
  ped.ped <- kinship2::pedigree(id = ped.df$ind, dadid = ped.df$father, 
                                momid = ped.df$mother, sex = ped.df$sex, 
                                famid = paste0(ped.df$pop, ped.df$fam))
  K <- as.matrix(kinship2::kinship(ped.ped))
  K <- 2*K
  return(list(df = ped.df, K = K))
}
heatmap(simK()$K)
```

## Animal

We used the following animal model with a lognormal distribution to estimate population and genotypic variance:

$$y_{p,i} \sim \mathcal{logN}(log(a_i),\sigma_1) \\ a_i \sim \mathcal{MVlogN_N}(log(\mu_p),\sigma_2.K)$$

```{r simanimal}
simAnimal <- function(
  P = 2, 
  Fam = 3,
  sigmaP = 0.5,
  sigmaG = 0.3,
  sigmaR = 0.2
){
  K <- simK(P, Fam)
  N <- nrow(K$K)
  epsilonG <- rnorm(N)
  p <- rlnorm(P, sd = sigmaP)
  mdata <- list(N = N, K = K$K, population = K$df$pop,
                y = rlnorm(N, 
                           log(p[K$df$pop]) + 
                             sigmaG*as.vector(t(chol(K$K)) %*% epsilonG),
                           sigmaR))
  return(list(p = p, 
              sigmaR = sigmaR, 
              sigmaG = sigmaG, 
              mdata = mdata))
}
```

We fitted the equivalent model with following priors:

$$y_{p,i} \sim \mathcal{logN}(log(\mu_p) + \sigma_2.A.\epsilon_i, \sigma_1) \\ \epsilon \sim \mathcal{N}(0,1) \\ \mu_p \sim \mathcal{logN}(0,1) \\  (\sigma_1,\sigma_2) \sim \mathcal N(0,1) \\V_P = Var(\mu_p) \\V_G=\sigma_2^2\\V_R=\sigma_1^2$$

```{r animalTable}
# mdata <- simAnimal()
# animal <- stan_model("symcapture_models/AnimalLog.stan")
# fitAnimal <- sampling(animal, chains = 2, save_warmup = F, data = mdata$mdata)
# save(mdata, fitAnimal, file = file.path("symcapture_save", "animal.Rdata"))
load(file.path("symcapture_save", "animal.Rdata"))
broom::tidyMCMC(fitAnimal, pars = c("mu", "sigma", "Vp", "lp__"), 
                droppars = NULL, rhat = T) %>% 
  mutate(expected = c(mdata$p, mdata$sigmaR, mdata$sigmaG, 
                      var(mdata$p), NA)) %>% 
  dplyr::select(term, estimate, std.error, expected, rhat) %>% 
  kable(caption = "Animal model fitted versus expected values.",
        col.names = c("Parameter", "Estimate", "Standard error", 
                      "Expected", "$\\hat R$"))
```

```{r animalTrace, fig.cap="Parameters for Animal model traceplot and expected value in red."}
mcmc_trace(as.array(fitAnimal, pars = c("mu", "sigma", "Vp", "lp__")),
           np = nuts_params(fitAnimal)) +
    geom_hline(aes(yintercept = expected), col = "red", 
             data = data.frame(parameter = c(paste0("mu[", 1:length(mdata$p), "]"), 
                                             paste0("sigma[", 1:2, "]"), 
                                             "Vp", "lp__"), 
                               expected = c(mdata$p, mdata$sigmaR,
                                            mdata$sigmaG, var(mdata$p), NA)))
```

## Gmax

We used the following growth model with a lognormal distribution to estimate individual growth potential:

$$DBH_{y=today,p,i}  - DBH_{y=y0,p,i} \sim \mathcal{logN} (log(\sum _{y=y_0} ^{y=today} \theta1_i.exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{100.\theta2_p})}{\theta3_p}]^2)), \sigma_1) \\ \theta1_i \sim \mathcal {logN}(\theta1_p, \sigma_2) \\ \theta2_p \sim \mathcal {logN}(\theta2,\sigma_3) \\ \theta3_p \sim \mathcal {logN}(\theta3,\sigma_4)$$

```{r simgmax}
simGmax <- function(
  P = 2, 
  I = 3*14,
  Y = 33, # Nb years
  Gmax = c(0.53, 0.54, 0.36),
  Dopt = 0.25,
  Ks = 0.7,
  sigma = c(0.10, 0.67, 0.2, 0.2)
){
  Gmax <- Gmax[1:P]
  years <- 1984:(1984+Y-1)
  pop <- sample(1:P, I, replace = T)
  Init <- sample_n(trees, I)
  DBH0 <- Init$DBH0
  Y0 <- Init$Y0
  Gmaxi <- rlnorm(I, meanlog = log(Gmax[pop]), sdlog = sigma[2])
  Doptp <- rlnorm(P, meanlog = log(Dopt), sdlog = sigma[3])
  Ksp <- rlnorm(P, meanlog = log(Ks), sdlog = sigma[4])
  DBH <- rep(NA, I)
  for (t in 1:(Y-1)) {
    for(i in 1:I){
      if(years[t] == Y0[i]) 
        DBH[i] <- DBH0[i] 
    }
    DBH <- DBH + Gmaxi * exp(-0.5*(log(DBH / (100*Doptp[pop])) / Ksp[pop])^2)
  }
  DBH <- DBH - DBH0
  DBHtoday <- DBH0 + rlnorm(I, meanlog = log(DBH), sdlog = sigma[1])
  return(list(Gmax = Gmax, Dopt = Dopt, Ks = Ks, 
              sigmaR = sigma[2], sigma = sigma[1],
              mdata = list(I = I, Y = Y, P = P, years = years, DBH0 = DBH0,
                           Y0 = Y0, DBHtoday = DBHtoday, pop = pop)))
}
```

We fitted the equivalent model with following priors:

$$DBH_{y=today,p,i}  - DBH_{y=y0,p,i} \sim \mathcal{logN} ( log(\sum _{y=y_0} ^{y=today} \theta1_i . exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{100.\theta2_p})}{\theta3_p}]^2)), \sigma_1) \\  \theta1_i = e^{log(\theta1_p) + \sigma_2.\epsilon1_i} \\ \theta2_p  = e^{log(\theta2) + \sigma_3.\epsilon2_i} \\ \theta3_p  = e^{log(\theta3) + \sigma_4.\epsilon3_i} \\ (\epsilon1, \epsilon2, \epsilon3, \epsilon4) \sim \mathcal{N}(0,1) \\ (\theta1_p, \theta2, \theta3) \sim \mathcal{logN}(0,1) \\ (\sigma_1, \sigma_2, \sigma_3, \sigma_4) \sim \mathcal{N}(0,1) \\ V_P = Var(\mu_p) \\ V_R=\sigma_2^2$$

```{r gmaxTable}
# mdata <- simGmax()
# gmax <- stan_model("symcapture_models/Gmax.stan")
# fitGmax <- sampling(gmax, chains = 2, save_warmup = F, data = mdata$mdata,
#                     control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(mdata, fitGmax, file = file.path("symcapture_save", "gmax.Rdata"))
load(file.path("symcapture_save", "gmax.Rdata"))
broom::tidyMCMC(fitGmax, pars = c("thetap1", "theta2", "theta3",
                                  "sigma[1]", "sigma[2]", "Vp", "lp__"), 
                droppars = NULL, rhat = T) %>% 
  mutate(expected = c(mdata$Gmax, mdata$Dopt, mdata$Ks,  
                      mdata$sigma, mdata$sigmaR, 
                      var(mdata$Gmax), NA)) %>% 
  dplyr::select(term, estimate, std.error, expected, rhat) %>% 
  kable(caption = "Animal model fitted versus expected values.",
        col.names = c("Parameter", "Estimate", "Standard error", 
                      "Expected", "$\\hat R$"))
```

```{r gmaxTrace, fig.cap="Parameters for Growth model traceplot and expected value in red."}
load(file.path("symcapture_save", "gmax.Rdata"))
mcmc_trace(as.array(fitGmax, pars = c("thetap1", "theta2", "theta3",
                                      "sigma[1]", "sigma[2]", "Vp", "lp__")),
           np = nuts_params(fitGmax)) +
  geom_hline(aes(yintercept = expected), col = "red", 
             data = data.frame(parameter = c(paste0("thetap1[", 
                                                    1:length(mdata$Gmax), "]"),
                                             "theta2", "theta3", 
                                             paste0("sigma[", 1:2, "]"), 
                                             "Vp", "lp__"), 
                               expected = c(mdata$Gmax, mdata$Dopt, mdata$Ks,  
                                            mdata$sigma, mdata$sigmaR, 
                                            var(mdata$Gmax), NA)))
```

## Gmax & Animal

```{r simgmaxgeno}
simGmaxGeno <- function(
  P = 2, 
  Fam = 3,
  Y = 33, # Nb years
  Gmax = c(0.53, 0.54, 0.36),
  Dopt = 0.25,
  Ks = 0.7,
  sigma = c(0.10, 0.67, 0.2, 0.2, 0.4)
){
  K <- simK(P, Fam)
  I <- nrow(K$K)
  Gmax <- Gmax[1:P]
  years <- 1984:(1984+Y-1)
  pop <- K$df$pop
  Init <- sample_n(trees, I)
  DBH0 <- Init$DBH0
  Y0 <- Init$Y0
  a <- exp(log(Gmax[pop]) + sigma[5]*as.vector(t(chol(K$K)) %*% rnorm(I)))
  Gmaxi <- rlnorm(I, meanlog = log(a), sdlog = sigma[2])
  Doptp <- rlnorm(P, meanlog = log(Dopt), sdlog = sigma[3])
  Ksp <- rlnorm(P, meanlog = log(Ks), sdlog = sigma[4])
  DBH <- rep(NA, I)
  for (t in 1:(Y-1)) {
    for(i in 1:I){
      if(years[t] == Y0[i]) 
        DBH[i] <- DBH0[i] 
    }
    DBH <- DBH + Gmaxi * exp(-0.5*(log(DBH / (100*Doptp[pop])) / Ksp[pop])^2)
  }
  DBH <- DBH - DBH0
  DBHtoday <- DBH0 + rlnorm(I, meanlog = log(DBH), sdlog = sigma[1])
  return(list(Gmax = Gmax, Dopt = Dopt, Ks = Ks, 
              sigmaR = sigma[2], sigmaG = sigma[5], sigma = sigma[1],
              mdata = list(I = I, Y = Y, P = P, years = years, DBH0 = DBH0,
                           Y0 = Y0, DBHtoday = DBHtoday, pop = pop, K = K$K)))
}
```

We used the following growth model with a lognormal distribution to estimate individual growth potential and associated genotypic variation:

$$DBH_{y=today,p,i}  - DBH_{y=y0,p,i} \sim \mathcal{logN} ( log(\sum _{y=y_0} ^{y=today} \theta1_i . exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{\theta2_p})}{\theta3_p}]^2)), \sigma_1) \\  \theta1_i \sim \mathcal{logN}(log(a1_i), \sigma_2) \\ \theta2_p \sim \mathcal{logN}(log(\theta2), \sigma_2) \\ \theta3_p  \sim \mathcal{logN}(log(\theta3) ,\sigma_4) \\ a1_i \sim \mathcal{MVlogN}(log(\theta1_p), \sigma_5.K)$$

We fitted the equivalent model with following priors:

$$DBH_{y=today,p,i}  - DBH_{y=y0,p,i} \sim \mathcal{logN} ( log(\sum _{y=y_0} ^{y=today} \theta1_i . exp(-\frac12.[\frac{log(\frac{DBH_{y,p,i}}{\theta2_p})}{\theta3_p}]^2)), \sigma_1) \\  \theta1_i = e^{log(a1_i) + \sigma_2.\epsilon1_i} \\ \theta2_p  = e^{log(\theta2) + \sigma_3.\epsilon2_i} \\ \theta3_p  = e^{log(\theta3) + \sigma_4.\epsilon3_i} \\ \\ a1_i = e^{log(\theta1_p) + \sigma_5.A.\epsilon4_i} \\ (\epsilon1, \epsilon2, \epsilon3, \epsilon4) \sim \mathcal{N}(0,1) \\ (\theta1_p, \theta2, \theta3) \sim \mathcal{logN}(0,1) \\ (\sigma_1, \sigma_2, \sigma_3, \sigma_4, \sigma_5) \sim \mathcal{N}(0,1) \\ V_P = Var(\mu_p) \\V_G=\sigma_5^2\\V_R=\sigma_2^2$$

```{r gmaxgenoTable}
# mdata <- simGmaxGeno()
# gmaxgeno <- stan_model("symcapture_models/GmaxGeno.stan")
# fitGmaxGeno <- sampling(gmaxgeno, chains = 2, save_warmup = F, data = mdata$mdata,
#                         control = list(adapt_delta = 0.99, max_treedepth = 12))
# save(mdata, fitGmaxGeno, file = file.path("symcapture_save", "gmaxgeno.Rdata"))
load(file.path("symcapture_save", "gmaxgeno.Rdata"))
broom::tidyMCMC(fitGmaxGeno, pars = c("thetap1", "theta2", "theta3",
                                  "sigma[1]", "sigma[2]", "sigma[5]",
                                  "Vp", "lp__"), 
                droppars = NULL, rhat = T) %>% 
  mutate(expected = c(mdata$Gmax, mdata$Dopt, mdata$Ks,  
                      mdata$sigma, mdata$sigmaR, mdata$sigmaG,
                      var(mdata$Gmax), NA)) %>% 
  dplyr::select(term, estimate, std.error, expected, rhat) %>% 
  kable(caption = "Animal model fitted versus expected values.",
        col.names = c("Parameter", "Estimate", "Standard error", 
                      "Expected", "$\\hat R$"))
```

```{r gmaxgenoTrace, fig.cap="Parameters for Growth & Animal model traceplot and expected value in red."}
mcmc_trace(as.array(fitGmaxGeno, pars = c("thetap1", "theta2", "theta3",
                                      "sigma[1]", "sigma[2]", "sigma[5]",
                                      "Vp", "lp__")),
           np = nuts_params(fitGmaxGeno)) +
  geom_hline(aes(yintercept = expected), col = "red", 
             data = data.frame(parameter = c(paste0("thetap1[", 
                                                    1:length(mdata$Gmax), "]"),
                                             "theta2", "theta3", 
                                             paste0("sigma[", c(1:2,5), "]"), 
                                             "Vp", "lp__"), 
                               expected = c(mdata$Gmax, mdata$Dopt, mdata$Ks,  
                                            mdata$sigma, mdata$sigmaR,  mdata$sigmaG,
                                            var(mdata$Gmax), NA)))
```

<!-- ```{r gmaxdata, fig.height=10, fig.width=10} -->
<!-- pars <- data.frame(sigmaR1 = rep(seq(from = 0.1, to = 1, length.out = 5), each = 5), -->
<!--                    sigma = rep(seq(from = 0.1, to = 1, length.out = 5), 5), -->
<!--                    sim = 1:25) -->
<!-- # mdata <- mapply(function(sigmaR1, sigma)  -->
<!-- #   gdata(I = 332, P = 1, Gmax = 0.54, sigmaR = c(sigmaR1, 0, 0), sigma = sigma), -->
<!-- #   sigmaR1 = pars$sigmaR1, sigma = pars$sigma, SIMPLIFY = F) -->
<!-- # names(mdata) <- paste0(pars$sigmaR1, "-", pars$sigma) -->
<!-- # save(mdata, file = file.path("symcapture_save", "gmaxData.Rdata")) -->
<!-- load(file = file.path("symcapture_save", "gmaxData.Rdata"))  -->
<!-- lapply(mdata, function(x) x$data) %>%  -->
<!--   bind_rows(.id = "pars") %>%  -->
<!--   separate(pars, c("sigmaR1", "sigma"), "-", convert = T, remove = F) %>%  -->
<!--   ggplot() +  -->
<!--   geom_point(aes(x = DBH0, y = DBHtoday, col = Y0)) +  -->
<!--   geom_abline() +  -->
<!--   geom_text(aes(label = pars), x = 60, y = 20, size = 3) +  -->
<!--   xlab("DBH at recruitment") + ylab("DBH today") + -->
<!--   viridis::scale_color_viridis(guide = "none") + -->
<!--   facet_wrap(~ sigmaR1 + sigma, scales = "free") + -->
<!--   theme(strip.background = element_blank(), strip.text.x = element_blank())  -->
<!-- ``` -->

<!-- ```{bash fitGmaxCluster, eval=F, echo=T} -->
<!-- for sim in $(seq 25) ; do echo "module purge ; module load compiler/gcc-7.2.0 ; module load system/R-3.5.3 ; R_LIBS_USER=\" \" Rscript Gmax.R $sim" ; done > Gmax.sh -->
<!-- sarray -J Gmax -o out/%j.Gmax.out -e out/%j.Gmax.err -t 36:00:00 --constraint=broadwell --cpus-per-task=2 --mail-type=BEGIN,END,FAIL Gmax.sh -->
<!-- ``` -->

<!-- ```{r gamxTab} -->
<!-- fitsGmax <- list() -->
<!-- sims <- c(1:25) -->
<!-- for(sim in sims){ -->
<!--   load(paste0("./symcapture_save/gmax/gmax", sim, ".Rdata")) -->
<!--   fitsGmax[[sim]] <- fit -->
<!-- } -->
<!-- broom::tidyMCMC(fitsGmax[[1]], pars = c("theta", "sigmaR", "sigma", "lp__"),  -->
<!--                 droppars = NULL, ess = T, rhat = T, estimate.method = "median") %>%  -->
<!--   mutate(expected = c(unlist(mdata[[1]]$params)[c(1:4, 7)], NA)) %>%  -->
<!--   dplyr::select(term, estimate, std.error, expected, rhat, ess) %>%  -->
<!--   kable(caption = "Individual growth model combined with population animal model fitted versus expected values.", -->
<!--         col.names = c("Parameter", "Estimate", "Standard error",  -->
<!--                       "Expected", "$\\hat R$", "$N_{eff}$"))  -->
<!-- ``` -->

<!-- ```{r gmaxTraceSigma, fig.height=6, fig.width=10} -->
<!-- cowplot::plot_grid(plotlist = lapply(sims, function(sim) -->
<!--   mcmc_trace(as.array(fitsGmax[[sim]], pars = c("sigmaR", "sigma"))) +  -->
<!--     geom_hline(aes(yintercept = expected), col = "red",  -->
<!--                data = data.frame(parameter = c("sigmaR", "sigma"), -->
<!--                                  expected = unlist(mdata[[sim]]$params)[c(4,7)])) + -->
<!--     theme(legend.position = "none") + ylim(0, 1.5)), labels = names(mdata)) -->
<!-- ``` -->
