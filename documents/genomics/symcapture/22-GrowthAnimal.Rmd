```{r setup_growthanimal, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(raster)
library(bayesplot)
library(kinship2)
library(rstan)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = T, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = T)
```

# Growth & Animal models

## Introduction

The aim of this model is to explore animal and growth model building theoritically in order to validate its behavior and use it on *Symphonia* and *Eschweilera* data. 

## Tes 1 - Simulated data

Let's consider a set of $P$ populations including each $Fam$ families composed of $I = 14$ individuals with arbitrar relationships.

```{r kinship1, fig.cap="Kinship matrix"}
kin.df <- function(P= 3, Fam = 6){
  I <- 14 # Individuals
  data.frame(pop = rep(1:P, each = Fam*I),
                       fam = rep(1:Fam, each = I),
                       ind = rep(1:I, Fam*P),
                       father = rep(c(NA, NA, 1, 1, 1, 1, NA, 6, 6, 6, NA, 11, 11, 11), Fam*P),
                       mother = rep(c(NA, NA, 2, 2, 2, 2, NA, 7, 7, 7, NA, 3, 3, 3), Fam*P), 
                       sex = rep(c(1, 2, 2, 3, 3, 1, 2, 3, 3, 3, 1, 3, 3, 3), Fam*P)) %>% 
    mutate_at(c("father", "mother"), funs(ifelse(!is.na(.), paste0(pop,fam,.), NA))) %>% 
    mutate(ind = paste0(pop,fam,ind))
}
kin.mat <- function(P = 3, Fam = 6){
  ped.df <- kin.df(P, Fam)
  ped.ped <- pedigree(id = ped.df$ind, dadid = ped.df$father, momid = ped.df$mother, sex = ped.df$sex, famid = paste0(ped.df$pop, ped.df$fam))
  K <- as.matrix(kinship(ped.ped))
  K <- 2*K
}
heatmap(kin.mat(3, 6))
```

### Genotype

We will use the following animal model to estimate variance associated to the genotype without population variance at first:

$$y \sim \mathcal N(\mu + A.a,\sigma_R)~|~a \sim \mathcal N(o,\sigma_G)$$

```{r genotype1}
K <- kin.mat(1, 6)
sigmaY <- 1
sigmaG <- 0.3
sigmaR <- sigmaY - sigmaG
N <- nrow(K)
mu <- rnorm(1)
u <- rnorm(N, sd = sqrt(sigmaG))
r <- rnorm(N, sd = sqrt(sigmaR))
y <- mu + as.vector(t(chol(K)) %*% u) + r
ggplot(data.frame(y = y, u = u), aes(u, y)) +
  geom_point() + geom_smooth(method = "lm", se = F) +
  ggtitle(paste("Vy =", round(var(y), 2), 
                "mu =", round(mu, 2),
                "Vg=", round(var(as.vector((t(chol(K)) %*% u))), 2), 
                "Vr=", round(var(r), 2)))
animal1 <- stan_model("symcapture_models/Animal1.stan")
fitAnimal1 <- sampling(animal1, chains = 2, save_warmup = F, data = list(N = N, Y = y, K = K))
broom::tidyMCMC(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable()
mcmc_trace(as.array(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR")))
```

### Population & Genotype

We will use the following animal model to estimate variance associated to the genotype with population variance:

$$y \sim \mathcal N(\mu_p + A.a,\sigma_R)~|~a \sim \mathcal N(o,\sigma_G)$$

```{r pop1}
P = 3
Fam = 6
K <- kin.mat(P, Fam)
ped.df <- kin.df(P, Fam)
sigmaP <- 0.8
sigmaG <- 0.8
sigmaR <- 0.2
N <- nrow(K)
p <- rnorm(P, sd = sqrt(sigmaP))
u <- rnorm(N, sd = sqrt(sigmaG))
r <- rnorm(N, sd = sqrt(sigmaR))
y <- p[ped.df$pop] + as.vector(t(chol(K)) %*% u) + r
ggplot(data.frame(y = y, u = u, pop = as.factor(ped.df$pop)),
       aes(u, y, col = pop)) +
  geom_point() + geom_smooth(method = "lm", se = F) +
  ggtitle(paste("Vy =", round(var(y), 2), 
                "Vp =", round(var(p), 2), 
                "Vg=", round(var(as.vector((t(chol(K)) %*% u))), 2), 
                "Vr=", round(var(r), 2)),
          paste("p =", paste0(round(p, 2), collapse = " ")))
animal2 <- stan_model("symcapture_models/Animal2.stan")
fitAnimal2 <- sampling(animal2, chains = 2, save_warmup = F, 
                       data = list(N = N, Y = y, K = K, P = P, population = ped.df$pop))
broom::tidyMCMC(fitAnimal2, pars = c("mu", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable()
mcmc_trace(as.array(fitAnimal2, pars = c("mu", "sigmaG", "sigmaR")))
```

### Growth

We will use the following model to estimate individual growth and associated parameters genotypic variance without population variance at first:

$$y \sim \mathcal N (\theta i_1.exp(-\frac12.[\frac{log(\frac{x}{\theta i_2})}{\theta i_3}]^2), \sigma^2)$$
$$\theta_i \sim \mathcal N (\theta + A.a_{\theta}, \sigma^2_{R_{\theta}})  ~|~ a_{\theta} \sim \mathcal N (0, \sigma^2_{G_{\theta}})$$

```{r growth1}
P = 1
Fam = 5
K <- kin.mat(P, Fam)
ped.df <- kin.df(P, Fam)
sigmaG <- c(0.3, 30, 0.5)
sigmaRt <- c(0.1, 10, 0.2)
sigmaR <- 0.1
N <- nrow(K)
Time = 3
u <- sapply(sigmaG, function(sigma) rnorm(N, sd = sqrt(sigma)))
theta <- c(1, 30, 0.8)
r <- rnorm(N, sd = sqrt(sigmaR))
rt <- sapply(sigmaRt, function(sigma) rnorm(N, sd = sqrt(sigma)))
thetai <- matrix(nrow = N, ncol = 3)
for(i in 1:3)
  thetai[,i] <- theta[i] + t(chol(K)) %*% u[,i] + rt[,i]
data <- sapply(1:Time, function(t)
  data.frame(x = rlnorm(N, meanlog = 3.2, sdlog = 0.5),
             i = rownames(K)) %>% 
    mutate(y = thetai[,1]*exp(-0.5*(log(x/thetai[,2])/thetai[,3])^2) + r),
  simplify = F
) %>% bind_rows(.id = "t") %>% 
  mutate(i = as.numeric(as.factor(i)))
ggplot(data, aes(x, y, col = as.factor(i))) +
  geom_point() +
  stat_function(fun = function(x)
    theta[1]*exp(-0.5*(log(x/theta[2])/theta[3])^2), col = "red") +
  scale_color_discrete(guide = "none") +
  ggtitle(paste("Vg=", paste0(round(apply(u, 2, var), 2), collapse = " "),
                "Vr=", paste0(round(apply(rt, 2, var), 2), collapse = " ")),
          paste("theta =", paste0(round(theta, 2), collapse = " ")))
growthanimal1 <- stan_model("symcapture_models/GrowthAnimalTest1.stan")
fitGrowthAnimal1 <- sampling(growthanimal1, chains = 2, save_warmup = F, 
                             data = list(N = nrow(data), I = max(data$i), y = data$y, 
                                         x = data $x, ind = data$i, K = K, L = c(0.1, 0, 0.1), U = c(2, 200, 3)))
broom::tidyMCMC(fitGrowthAnimal1, pars = c("theta", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable()
mcmc_trace(as.array(fitGrowthAnimal1, pars = c("theta", "sigmaG", "sigmaR")))
mcmc_pairs(as.array(fitGrowthAnimal1, pars = c("sigmaG", "sigmaR")))
```

### Growth & Gmax only

We will use the following model to estimate individual growth and associated parameters genotypic variance without population variance at first:

$$y \sim \mathcal N (\theta i_1.exp(-\frac12.[\frac{log(\frac{x}{\theta i_2})}{\theta i_3}]^2), \sigma^2)$$
$$\theta i_1 \sim \mathcal N (\theta_1 + A.a_{\theta_1}, \sigma^2_{R_{\theta_1}})  ~|~ a_{\theta_1} \sim \mathcal N (0, \sigma^2_{G_{\theta_1}})$$

```{r growth2}
P = 1
Fam = 5
K <- kin.mat(P, Fam)
ped.df <- kin.df(P, Fam)
sigmaG <- 0.4
sigmaRt <- c(0.1, 10, 0.2)
sigmaR <- 0.1
N <- nrow(K)
Time = 3
u <- rnorm(N, sd = sqrt(sigmaG))
theta <- c(1, 30, 0.8)
r <- rnorm(N, sd = sqrt(sigmaR))
rt <- sapply(sigmaRt, function(sigma) rnorm(N, sd = sqrt(sigma)))
thetai <- matrix(nrow = N, ncol = 3)
thetai[,1] <- theta[1] + t(chol(K)) %*% u + rt[,1]
for(i in 2:3)
  thetai[,i] <- theta[i] + rt[,i]
data <- sapply(1:Time, function(t)
  data.frame(x = rlnorm(N, meanlog = 3.2, sdlog = 0.5),
             i = rownames(K)) %>% 
    mutate(y = thetai[,1]*exp(-0.5*(log(x/thetai[,2])/thetai[,3])^2) + r),
  simplify = F
) %>% bind_rows(.id = "t") %>% 
  mutate(i = as.numeric(as.factor(i)))
ggplot(data, aes(x, y, col = as.factor(i))) +
  geom_point() +
  stat_function(fun = function(x)
    theta[1]*exp(-0.5*(log(x/theta[2])/theta[3])^2), col = "red") +
  scale_color_discrete(guide = "none") +
  ggtitle(paste("Vg=", paste0(round(var(u), 2), collapse = " "),
                "Vr=", paste0(round(apply(rt, 2, var), 2), collapse = " ")),
          paste("theta =", paste0(round(theta, 2), collapse = " ")))
growthanimal2 <- stan_model("symcapture_models/GrowthAnimalTest2.stan")
fitGrowthAnimal2 <- sampling(growthanimal2, chains = 2, save_warmup = F,
                             data = list(N = nrow(data), I = max(data$i), y = data$y,
                                         x = data $x, ind = data$i, K = K, L = c(0.1, 0, 0.1), U = c(2, 200, 3)))
broom::tidyMCMC(fitGrowthAnimal2, pars = c("theta", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable()
mcmc_trace(as.array(fitGrowthAnimal2, pars = c("theta", "sigmaG", "sigmaR")))
mcmc_pairs(as.array(fitGrowthAnimal2, pars = c("theta", "sigmaG", "sigmaR")))
```

<!-- ## Test 2 - Diogro Mello's data -->

<!-- ### Kinship -->

<!-- ```{r kinship2} -->
<!-- ped <- read.table("https://raw.githubusercontent.com/diogro/QGcourse/master/tutorials/volesPED.txt", header = T) -->
<!-- inv.phylo <- MCMCglmm::inverseA(ped, scale = TRUE) -->
<!-- K <- solve(inv.phylo$Ainv) -->
<!-- K <- (K + t(K))/2 -->
<!-- rownames(K) <- rownames(inv.phylo$Ainv) -->
<!-- K <- as.matrix(K) -->
<!-- P <- 1 -->
<!-- heatmap(K) -->
<!-- K2 <- K -->
<!-- ``` -->

<!-- ### Phenotype -->

<!-- ```{r variances2} -->
<!-- sigmaP <- 0.2 -->
<!-- sigmaG <- 0.4 -->
<!-- sigmaR <- 0.6 -->
<!-- N = nrow(K) -->
<!-- u_tilde <- rnorm(N, sd = sqrt(sigmaG)) -->
<!-- p <- rep(rnorm(n = P, sd = sqrt(sigmaP)), each = N) -->
<!-- r <- rnorm(N, sd = sqrt(sigmaR)) -->
<!-- y <- p + as.vector(t(chol(K)) %*% u_tilde) + r -->
<!-- ggplot(data.frame(y = y, u = u_tilde, pop = as.factor(P)), -->
<!--        aes(u, y, col = pop)) + -->
<!--   geom_point() + geom_smooth(method = "lm", se = F) + -->
<!--     ggtitle(paste0("Variances: Y=", round(var(y), 2),  -->
<!--                    " p1=", unique(round(p, 2))[1], -->
<!--                    " p2=", unique(round(p, 2))[2], -->
<!--                    " P=", round(var(p), 2), -->
<!--                    " G=", round(var(as.vector((t(chol(K)) %*% u_tilde))), 2),  -->
<!--                    " R=", round(var(r), 2))) -->
<!-- ``` -->

<!-- ### Animal -->

<!-- ```{r animal2} -->
<!-- animal1 <- stan_model("symcapture_models/Animal1.stan") -->
<!-- fitAnimal1 <- sampling(animal1, chains = 2, save_warmup = F, -->
<!--                        data = list(N = N, P = P, Y = y, population = rep(P,N), K = K)) -->
<!-- mcmc_trace(as.array(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"))) -->
<!-- mcmc_pairs(as.array(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"))) -->
<!-- broom::tidyMCMC(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable() -->
<!-- ``` -->

<!-- ## Data 3 - Symphonia -->

<!-- ### Kinship -->

<!-- ```{r kinship3} -->
<!-- path <- "~/Documents/BIOGECO/PhD/data/Symphonia_Paracou/Sequences/populationGenomics/" -->
<!-- fam <- read_delim(file.path(path, "gemma", "Gmax0", "paracou3pop.fam"), delim = " ", -->
<!--                   col_names = c("FID", "IID", "PAT", "MAT", "SEX", "PHENOTYPE")) -->
<!-- K <- read_tsv(file.path(path, "gemma", "Gmax0", "paracou3pop.kinship.sXX.txt"), -->
<!--               col_names = fam$IID) %>% -->
<!--   mutate(IID = fam$IID) %>% -->
<!--   column_to_rownames(var = "IID") %>% -->
<!--   as.matrix() -->
<!-- P <- 1 -->
<!-- K[K < 0] <- 0 -->
<!-- heatmap(K) -->
<!-- K3 <- K -->
<!-- ``` -->

<!-- ### Phenotype -->

<!-- ```{r variances3} -->
<!-- sigmaP <- 0.2 -->
<!-- sigmaG <- 0.4 -->
<!-- sigmaR <- 0.6 -->
<!-- N = nrow(K) -->
<!-- u_tilde <- rnorm(N, sd = sqrt(sigmaG)) -->
<!-- p <- rep(rnorm(n = P, sd = sqrt(sigmaP)), each = N) -->
<!-- r <- rnorm(N, sd = sqrt(sigmaR)) -->
<!-- y <- p + as.vector(t(chol(K)) %*% u_tilde) + r -->
<!-- ggplot(data.frame(y = y, u = u_tilde, pop = as.factor(P)), -->
<!--        aes(u, y, col = pop)) + -->
<!--   geom_point() + geom_smooth(method = "lm", se = F) + -->
<!--     ggtitle(paste0("Variances: Y=", round(var(y), 2),  -->
<!--                    " p1=", unique(round(p, 2))[1], -->
<!--                    " p2=", unique(round(p, 2))[2], -->
<!--                    " P=", round(var(p), 2), -->
<!--                    " G=", round(var(as.vector((t(chol(K)) %*% u_tilde))), 2),  -->
<!--                    " R=", round(var(r), 2))) -->
<!-- ``` -->

<!-- ### Animal -->

<!-- ```{r animal3.1} -->
<!-- animal1 <- stan_model("symcapture_models/Animal1.stan") -->
<!-- fitAnimal1 <- sampling(animal1, chains = 2, save_warmup = F, -->
<!--                        data = list(N = N, P = P, Y = y, population = rep(P,N), K = K)) -->
<!-- mcmc_trace(as.array(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"))) -->
<!-- mcmc_pairs(as.array(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"))) -->
<!-- broom::tidyMCMC(fitAnimal1, pars = c("mu", "sigmaG", "sigmaR"), droppars = NULL, rhat = T) %>% kable() -->
<!-- ``` -->

